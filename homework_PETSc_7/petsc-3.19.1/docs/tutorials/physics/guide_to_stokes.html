
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Guide to the Stokes Equations using Finite Elements &#8212; PETSc 3.19.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/katex-math.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script src="../../_static/katex.min.js"></script>
    <script src="../../_static/auto-render.min.js"></script>
    <script src="../../_static/katex_autorenderer.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/physics/guide_to_stokes';</script>
    <link rel="shortcut icon" href="../../_static/petsc_favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../index.html">

  
  
  
  
  
  
  

  
    <img src="../../_static/PETSc-TAO_RGB.svg" class="logo__image only-light" alt="Logo image">
    <img src="../../_static/PETSc-TAO_RGB_white.svg" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../overview/index.html">
                        Overview
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../install/index.html">
                        Install
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../manual/index.html">
                        User-Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../manualpages/index.html">
                        C/Fortran API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../petsc4py/petsc4py.html">
                        Python API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../faq/index.html">
                        FAQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../community/index.html">
                        Community
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../developers/index.html">
                        Developers
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../miscellaneous/index.html">
                        Misc.
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://gitlab.com/petsc/petsc" title="GitLab" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fab fa-gitlab"></i></span>
            <label class="sr-only">GitLab</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../overview/index.html">
                        Overview
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../install/index.html">
                        Install
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../manual/index.html">
                        User-Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../manualpages/index.html">
                        C/Fortran API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../petsc4py/petsc4py.html">
                        Python API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../faq/index.html">
                        FAQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../community/index.html">
                        Community
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../developers/index.html">
                        Developers
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../miscellaneous/index.html">
                        Misc.
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://gitlab.com/petsc/petsc" title="GitLab" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fab fa-gitlab"></i></span>
            <label class="sr-only">GitLab</label></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="guide-to-the-stokes-equations-using-finite-elements">
<span id="tut-stokes"></span><h1>Guide to the Stokes Equations using Finite Elements<a class="headerlink" href="#guide-to-the-stokes-equations-using-finite-elements" title="Permalink to this heading">#</a></h1>
<p>This guide accompanies <a class="reference external" href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/src/snes/tutorials/ex62.c.html">SNES Example 62</a> and <a class="reference external" href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/src/snes/tutorials/ex69.c.html">SNES Example 69</a>.</p>
<p>The Stokes equations for a fluid, a steady-state form of the Navier-Stokes equations, start with the balance of momentum, just as in elastostatics,</p>
<div class="math">
\[\nabla \cdot \sigma + f = 0,\]</div>
<p>where <span class="math">\(\sigma\)</span> is the stress tensor and <span class="math">\(f\)</span> is the body force, combined with the conservation of mass</p>
<div class="math">
\[\nabla \cdot (\rho u) = 0,\]</div>
<p>where <span class="math">\(\rho\)</span> is the density and <span class="math">\(u\)</span> is the fluid velocity. If we assume that the density is constant, making the fluid incompressible, and that the rheology is Newtonian, meaning that the viscous stress is linearly proportional to the local strain rate, then we have</p>
<div class="math">
\[\begin{aligned}
  \nabla \cdot \mu \left( \nabla u + \nabla u^T \right) - \nabla p + f &= 0 \\
  \nabla \cdot u &= 0
\end{aligned}\]</div>
<p>where <span class="math">\(p\)</span> is the pressure, <span class="math">\(\mu\)</span> is the dynamic shear viscosity, with units <span class="math">\(N\cdot s/m^2\)</span> or <span class="math">\(Pa\cdot s\)</span>. If we divide by the constant density, we would have the kinematic viscosity <span class="math">\(\nu\)</span> and a force per unit mass. The second equation demands that the velocity field be divergence-free, indicating that the flow is incompressible. The pressure in this case can be thought of as the Lagrange multiplier enforcing the incompressibility constraint. In the compressible case, we would need an equation of state to relate the pressure to the density, and perhaps temperature.</p>
<p>We will discretize our Stokes equations with finite elements, so the first step is to write a variational weak form of the equations. We choose to use a Ritz-Galerkin setup, so let our velocity <span class="math">\(u \in V\)</span> and pressure <span class="math">\(p \in Q\)</span>, so that</p>
<div class="math">
\[\begin{aligned}
  \left< \nabla v, \mu \left( \nabla u + \nabla u^T \right) \right> + \left< v, \frac{\partial\sigma}{\partial n} \right>_\Gamma - \left< \nabla\cdot v, p \right> - \left< v, f \right> &= 0 & \text{for all} \ v \in V\\
  \left< q, -\nabla \cdot u \right> &= 0 & \text{for all} \ q \in Q
\end{aligned}\]</div>
<p>where integration by parts has added a boundary integral over the normal derivative of the stress (traction), and natural boundary conditions correspond to stress-free boundaries. We have multiplied the continuity equation by minus one in order to preserve symmetry.</p>
<section id="equation-definition">
<h2>Equation Definition<a class="headerlink" href="#equation-definition" title="Permalink to this heading">#</a></h2>
<p>The test functions <span class="math">\(v, q\)</span> and their derivatives are determined by the discretization, whereas the form of the integrand is determined by the physics. Given a quadrature rule to evaluate the form integral, we would only need the evaluation of the physics integrand at the quadrature points, given the values of the fields and their derivatives. The entire scheme is detailed in <span id="id1">[<a class="reference internal" href="#id826" title="M. G. Knepley, J. Brown, K. Rupp, and B. F. Smith. Achieving high performance with unified residual evaluation. ArXiv e-prints, September 2013. arXiv:1309.1204.">KnepleyBrownRuppSmith13</a>]</span>. The kernels paired with test functions we will call <span class="math">\(f_0\)</span> and those paired with gradients of test functions will be called <span class="math">\(f_1\)</span>.</p>
<p>For example, the kernel for the continuity equation, paired with the pressure test function, is called <code class="docutils literal notranslate"><span class="pre">f0_p</span></code> and can be seen here</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f0_p</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">d</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">u_x</span><span class="p">[</span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We use the components of the Jacobian of <span class="math">\(u\)</span> to build up its divergence. For the balance of momentum excluding body force, we test against the gradient of the test function, as seen in <code class="docutils literal notranslate"><span class="pre">f1_u</span></code>,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f1_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f1</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">  </span><span class="n">Nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uOff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">uOff</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">f1</span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">u_x</span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">u_x</span><span class="p">[</span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">]);</span>
<span class="w">    </span><span class="n">f1</span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="n">uOff</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>Notice how the pressure <span class="math">\(p\)</span> is referred to using <code class="docutils literal notranslate"><span class="pre">u[uOff[1]]</span></code> so that we can have many fields with different numbers of components. <code class="docutils literal notranslate"><span class="pre">DMPlex</span></code> uses these point functions to construct the residual. A similar set of point functions is also used to build the Jacobian. The last piece of our physics specification is the construction of exact solutions using the Method of Manufactured Solutions (MMS).</p>
</section>
<section id="mms-solutions">
<h2>MMS Solutions<a class="headerlink" href="#mms-solutions" title="Permalink to this heading">#</a></h2>
<p>An MMS solution is chosen to elucidate some property of the problem, and to check that it is being solved accurately, since the error can be calculated explicitly. For our Stokes problem, we first choose a solution with quadratic velocity and linear pressure,</p>
<div class="math">
\[u = \begin{pmatrix} x^2 + y^2 \\ 2 x^2 - 2 x y \end{pmatrix} \quad \mathrm{or} \quad \begin{pmatrix} 2 x^2 + y^2 + z^2 \\ 2 x^2 - 2xy \\ 2 x^2 - 2xz \end{pmatrix}\]</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">quadratic_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>

<span class="w">  </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]);</span>
<span class="w">    </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">quadratic_p</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f0_quadratic_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">f0</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Trigonometric MMS Solution</span>
<span class="cm">   2D:</span>

<span class="cm">     u = sin(pi x) + sin(pi y)</span>
<span class="cm">     v = -pi cos(pi x) y</span>
<span class="cm">     p = sin(2 pi x) + sin(2 pi y)</span>
<span class="cm">     f = &lt;2pi cos(2 pi x) + mu pi^2 sin(pi x) + mu pi^2 sin(pi y), 2pi cos(2 pi y) - mu pi^3 cos(pi x) y&gt;</span>

<span class="cm">   so that</span>

<span class="cm">     e(u) = (grad u + grad u^T) = /        2pi cos(pi x)             pi cos(pi y) + pi^2 sin(pi x) y \</span>
<span class="cm">                                  \ pi cos(pi y) + pi^2 sin(pi x) y          -2pi cos(pi x)          /</span>
<span class="cm">     div mu e(u) - \nabla p + f = mu &lt;-pi^2 sin(pi x) - pi^2 sin(pi y), pi^3 cos(pi x) y&gt; - &lt;2pi cos(2 pi x), 2pi cos(2 pi y)&gt; + &lt;f_x, f_y&gt; = 0</span>
<span class="cm">     \nabla \cdot u             = pi cos(pi x) - pi cos(pi x) = 0</span>

<span class="cm">   3D:</span>

<span class="cm">     u = 2 sin(pi x) + sin(pi y) + sin(pi z)</span>
<span class="cm">     v = -pi cos(pi x) y</span>
<span class="cm">     w = -pi cos(pi x) z</span>
<span class="cm">     p = sin(2 pi x) + sin(2 pi y) + sin(2 pi z)</span>
<span class="cm">     f = &lt;2pi cos(2 pi x) + mu 2pi^2 sin(pi x) + mu pi^2 sin(pi y) + mu pi^2 sin(pi z), 2pi cos(2 pi y) - mu pi^3 cos(pi x) y, 2pi cos(2 pi z) - mu pi^3 cos(pi x) z&gt;</span>

<span class="cm">   so that</span>

<span class="cm">     e(u) = (grad u + grad u^T) = /        4pi cos(pi x)             pi cos(pi y) + pi^2 sin(pi x) y  pi cos(pi z) + pi^2 sin(pi x) z \</span>
<span class="cm">                                  | pi cos(pi y) + pi^2 sin(pi x) y          -2pi cos(pi x)                        0                  |</span>
<span class="cm">                                  \ pi cos(pi z) + pi^2 sin(pi x) z               0                         -2pi cos(pi x)            /</span>
<span class="cm">     div mu e(u) - \nabla p + f = mu &lt;-2pi^2 sin(pi x) - pi^2 sin(pi y) - pi^2 sin(pi z), pi^3 cos(pi x) y, pi^3 cos(pi x) z&gt; - &lt;2pi cos(2 pi x), 2pi cos(2 pi y), 2pi cos(2 pi z)&gt; + &lt;f_x, f_y, f_z&gt; = 0</span>
<span class="cm">     \nabla \cdot u             = 2 pi cos(pi x) - pi cos(pi x) - pi cos(pi x) = 0</span>
<span class="cm">*/</span>
<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">trig_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>

<span class="w">  </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]);</span>
<span class="w">    </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">trig_p</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f0_trig_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
<span class="w">    </span><span class="n">f0</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscPowRealInt</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">ProcessOptions</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">sol</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SOL_QUADRATIC</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsBegin.html">PetscOptionsBegin</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stokes Problem Options&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;<a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a>&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsEList.html">PetscOptionsEList</a></span><span class="p">(</span><span class="s">&quot;-sol&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The MMS solution&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ex62.c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_STATIC_ARRAY_LENGTH.html">PETSC_STATIC_ARRAY_LENGTH</a></span><span class="p">(</span><span class="n">SolTypes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">[</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sol</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SolType</span><span class="p">)</span><span class="n">sol</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsEnd.html">PetscOptionsEnd</a></span><span class="p">();</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">CreateMesh</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="o">*</span><span class="n">dm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreate.html">DMCreate</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetType.html">DMSetType</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetFromOptions.html">DMSetFromOptions</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMViewFromOptions.html">DMViewFromOptions</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-dm_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupParameters</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Parameter</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="cm">/* setup PETSc parameter bag */</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagCreate.html">PetscBagCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Parameter</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetName.html">PetscBagSetName</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;par&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stokes Parameters&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagRegisterScalar.html">PetscBagRegisterScalar</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mu&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dynamic Shear Viscosity, Pa s&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetFromOptions.html">PetscBagSetFromOptions</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span><span class="w">       </span><span class="n">viewer</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PetscViewerFormat</a></span><span class="w"> </span><span class="n">format</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">         </span><span class="n">flg</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscOptionsGetViewer.html">PetscOptionsGetViewer</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-param_view&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flg</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPushFormat.html">PetscViewerPushFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagView.html">PetscBagView</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFlush.html">PetscViewerFlush</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPopFormat.html">PetscViewerPopFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerDestroy.html">PetscViewerDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupEqn</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">2</span><span class="p">])(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span><span class="w">        </span><span class="n">ds</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMLabel/DMLabel.html">DMLabel</a></span><span class="w">        </span><span class="n">label</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDS.html">DMGetDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ds</span><span class="p">));</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">SOL_QUADRATIC</span><span class="p">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f0_quadratic_u</span><span class="p">,</span><span class="w"> </span><span class="n">f1_u</span><span class="p">));</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quadratic_u</span><span class="p">;</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quadratic_p</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">SOL_TRIG</span><span class="p">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f0_trig_u</span><span class="p">,</span><span class="w"> </span><span class="n">f1_u</span><span class="p">));</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trig_u</span><span class="p">;</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trig_p</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">default</span><span class="o">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/SETERRQ.html">SETERRQ</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unsupported solution type: %s (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">[</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscMin.html">PetscMin</a></span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">,</span><span class="w"> </span><span class="n">SOL_UNKNOWN</span><span class="p">)],</span><span class="w"> </span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">f0_p</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g3_uu</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g2_up</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g1_pu</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g3_uu</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">g0_pp</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetLabel.html">DMGetLabel</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;marker&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">label</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMAddBoundary.html">DMAddBoundary</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMBoundaryConditionType.html">DM_BC_ESSENTIAL</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wall&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="cm">/* Make constant values available to pointwise functions */</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">Parameter</span><span class="w">  </span><span class="o">*</span><span class="n">param</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">param</span><span class="p">));</span>
<span class="w">    </span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">;</span><span class="w"> </span><span class="cm">/* dynamic shear viscosity, Pa s */</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetConstants.html">PetscDSSetConstants</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">constants</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">zero</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">one</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">CreatePressureNullSpace</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">origField</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="o">*</span><span class="n">nullspace</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">vec</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">funcs</span><span class="p">[</span><span class="mi">2</span><span class="p">])(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="p">};</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCheck.html">PetscCheck</a></span><span class="p">(</span><span class="n">origField</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Field %&quot;</span><span class="w"> </span><span class="n">PetscInt_FMT</span><span class="w"> </span><span class="s">&quot; should be 1 for pressure&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">origField</span><span class="p">);</span>
<span class="w">  </span><span class="n">funcs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one</span><span class="p">;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span><span class="w"> </span><span class="n">ds</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDS.html">DMGetDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ds</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectViewFromOptions.html">PetscObjectViewFromOptions</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-ds_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateGlobalVector.html">DMCreateGlobalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMProjectFunction.html">DMProjectFunction</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">funcs</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/InsertMode.html">INSERT_ALL_VALUES</a></span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecNormalize.html">VecNormalize</a></span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceCreate.html">MatNullSpaceCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_FALSE</a></span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="n">nullspace</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecDestroy.html">VecDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="cm">/* New style for field null spaces */</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="w">  </span><span class="n">pressure</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="n">nullspacePres</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetField.html">DMGetField</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pressure</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceCreate.html">MatNullSpaceCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">(</span><span class="n">pressure</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectCompose.html">PetscObjectCompose</a></span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nullspace&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceDestroy.html">MatNullSpaceDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupProblem</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">setupEqn</span><span class="p">)(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w">              </span><span class="n">cdm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dm</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscQuadrature.html">PetscQuadrature</a></span><span class="w"> </span><span class="n">q</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">       </span><span class="n">simplex</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">Nf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">Nc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;velocity&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pressure&quot;</span><span class="p">};</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">prefix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;vel_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pres_&quot;</span><span class="p">};</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDimension.html">DMGetDimension</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexIsSimplex.html">DMPlexIsSimplex</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplex</span><span class="p">));</span>
<span class="w">  </span><span class="n">Nc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span>
<span class="w">  </span><span class="n">Nc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nf</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFE.html">PetscFE</a></span><span class="w"> </span><span class="n">fe</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFECreateDefault.html">PetscFECreateDefault</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">Nc</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="w"> </span><span class="n">simplex</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fe</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">f</span><span class="p">]));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFEGetQuadrature.html">PetscFEGetQuadrature</a></span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">q</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFESetQuadrature.html">PetscFESetQuadrature</a></span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetField.html">DMSetField</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">fe</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFEDestroy.html">PetscFEDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateDS.html">DMCreateDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">((</span><span class="o">*</span><span class="n">setupEqn</span><span class="p">)(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cdm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCopyDisc.html">DMCopyDisc</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">cdm</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetNullSpaceConstructor.html">DMSetNullSpaceConstructor</a></span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CreatePressureNullSpace</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetCoarseDM.html">DMGetCoarseDM</a></span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cdm</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a></span><span class="w">   </span><span class="n">snes</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w">     </span><span class="n">dm</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w">    </span><span class="n">u</span><span class="p">;</span>
<span class="w">  </span><span class="n">AppCtx</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInitialize.html">PetscInitialize</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">help</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">ProcessOptions</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">CreateMesh</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESCreate.html">SNESCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetDM.html">SNESSetDM</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetApplicationContext.html">DMSetApplicationContext</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">SetupParameters</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">SetupProblem</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">SetupEqn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexCreateClosureIndex.html">DMPlexCreateClosureIndex</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateGlobalVector.html">DMCreateGlobalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/DMPlexSetSNESLocalFEM.html">DMPlexSetSNESLocalFEM</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetFromOptions.html">SNESSetFromOptions</a></span><span class="p">(</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/DMSNESCheckFromOptions.html">DMSNESCheckFromOptions</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Solution&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a></span><span class="w">          </span><span class="n">J</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetUp.html">SNESSetUp</a></span><span class="p">(</span><span class="n">snes</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">CreatePressureNullSpace</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESGetJacobian.html">SNESGetJacobian</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetNullSpace.html">MatSetNullSpace</a></span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceDestroy.html">MatNullSpaceDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Jacobian&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatViewFromOptions.html">MatViewFromOptions</a></span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-J_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSolve.html">SNESSolve</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecDestroy.html">VecDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESDestroy.html">SNESDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMDestroy.html">DMDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagDestroy.html">PetscBagDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="p">.</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFinalize.html">PetscFinalize</a></span><span class="p">());</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="math">
\[p = x + y - 1 \quad \mathrm{or} \quad x + y + z - \frac{3}{2}\]</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">quadratic_p</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f0_quadratic_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">f0</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Trigonometric MMS Solution</span>
<span class="cm">   2D:</span>

<span class="cm">     u = sin(pi x) + sin(pi y)</span>
<span class="cm">     v = -pi cos(pi x) y</span>
<span class="cm">     p = sin(2 pi x) + sin(2 pi y)</span>
<span class="cm">     f = &lt;2pi cos(2 pi x) + mu pi^2 sin(pi x) + mu pi^2 sin(pi y), 2pi cos(2 pi y) - mu pi^3 cos(pi x) y&gt;</span>

<span class="cm">   so that</span>

<span class="cm">     e(u) = (grad u + grad u^T) = /        2pi cos(pi x)             pi cos(pi y) + pi^2 sin(pi x) y \</span>
<span class="cm">                                  \ pi cos(pi y) + pi^2 sin(pi x) y          -2pi cos(pi x)          /</span>
<span class="cm">     div mu e(u) - \nabla p + f = mu &lt;-pi^2 sin(pi x) - pi^2 sin(pi y), pi^3 cos(pi x) y&gt; - &lt;2pi cos(2 pi x), 2pi cos(2 pi y)&gt; + &lt;f_x, f_y&gt; = 0</span>
<span class="cm">     \nabla \cdot u             = pi cos(pi x) - pi cos(pi x) = 0</span>

<span class="cm">   3D:</span>

<span class="cm">     u = 2 sin(pi x) + sin(pi y) + sin(pi z)</span>
<span class="cm">     v = -pi cos(pi x) y</span>
<span class="cm">     w = -pi cos(pi x) z</span>
<span class="cm">     p = sin(2 pi x) + sin(2 pi y) + sin(2 pi z)</span>
<span class="cm">     f = &lt;2pi cos(2 pi x) + mu 2pi^2 sin(pi x) + mu pi^2 sin(pi y) + mu pi^2 sin(pi z), 2pi cos(2 pi y) - mu pi^3 cos(pi x) y, 2pi cos(2 pi z) - mu pi^3 cos(pi x) z&gt;</span>

<span class="cm">   so that</span>

<span class="cm">     e(u) = (grad u + grad u^T) = /        4pi cos(pi x)             pi cos(pi y) + pi^2 sin(pi x) y  pi cos(pi z) + pi^2 sin(pi x) z \</span>
<span class="cm">                                  | pi cos(pi y) + pi^2 sin(pi x) y          -2pi cos(pi x)                        0                  |</span>
<span class="cm">                                  \ pi cos(pi z) + pi^2 sin(pi x) z               0                         -2pi cos(pi x)            /</span>
<span class="cm">     div mu e(u) - \nabla p + f = mu &lt;-2pi^2 sin(pi x) - pi^2 sin(pi y) - pi^2 sin(pi z), pi^3 cos(pi x) y, pi^3 cos(pi x) z&gt; - &lt;2pi cos(2 pi x), 2pi cos(2 pi y), 2pi cos(2 pi z)&gt; + &lt;f_x, f_y, f_z&gt; = 0</span>
<span class="cm">     \nabla \cdot u             = 2 pi cos(pi x) - pi cos(pi x) - pi cos(pi x) = 0</span>
<span class="cm">*/</span>
<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">trig_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>

<span class="w">  </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]);</span>
<span class="w">    </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">trig_p</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f0_trig_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
<span class="w">    </span><span class="n">f0</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscPowRealInt</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">ProcessOptions</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">sol</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SOL_QUADRATIC</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsBegin.html">PetscOptionsBegin</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stokes Problem Options&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;<a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a>&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsEList.html">PetscOptionsEList</a></span><span class="p">(</span><span class="s">&quot;-sol&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The MMS solution&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ex62.c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_STATIC_ARRAY_LENGTH.html">PETSC_STATIC_ARRAY_LENGTH</a></span><span class="p">(</span><span class="n">SolTypes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">[</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sol</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SolType</span><span class="p">)</span><span class="n">sol</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsEnd.html">PetscOptionsEnd</a></span><span class="p">();</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">CreateMesh</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="o">*</span><span class="n">dm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreate.html">DMCreate</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetType.html">DMSetType</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetFromOptions.html">DMSetFromOptions</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMViewFromOptions.html">DMViewFromOptions</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-dm_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupParameters</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Parameter</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="cm">/* setup PETSc parameter bag */</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagCreate.html">PetscBagCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Parameter</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetName.html">PetscBagSetName</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;par&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stokes Parameters&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagRegisterScalar.html">PetscBagRegisterScalar</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mu&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dynamic Shear Viscosity, Pa s&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetFromOptions.html">PetscBagSetFromOptions</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span><span class="w">       </span><span class="n">viewer</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PetscViewerFormat</a></span><span class="w"> </span><span class="n">format</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">         </span><span class="n">flg</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscOptionsGetViewer.html">PetscOptionsGetViewer</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-param_view&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flg</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPushFormat.html">PetscViewerPushFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagView.html">PetscBagView</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFlush.html">PetscViewerFlush</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPopFormat.html">PetscViewerPopFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerDestroy.html">PetscViewerDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupEqn</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">2</span><span class="p">])(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span><span class="w">        </span><span class="n">ds</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMLabel/DMLabel.html">DMLabel</a></span><span class="w">        </span><span class="n">label</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDS.html">DMGetDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ds</span><span class="p">));</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">SOL_QUADRATIC</span><span class="p">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f0_quadratic_u</span><span class="p">,</span><span class="w"> </span><span class="n">f1_u</span><span class="p">));</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quadratic_u</span><span class="p">;</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quadratic_p</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">SOL_TRIG</span><span class="p">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f0_trig_u</span><span class="p">,</span><span class="w"> </span><span class="n">f1_u</span><span class="p">));</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trig_u</span><span class="p">;</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trig_p</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">default</span><span class="o">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/SETERRQ.html">SETERRQ</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unsupported solution type: %s (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">[</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscMin.html">PetscMin</a></span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">,</span><span class="w"> </span><span class="n">SOL_UNKNOWN</span><span class="p">)],</span><span class="w"> </span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">f0_p</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g3_uu</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g2_up</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g1_pu</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g3_uu</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">g0_pp</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetLabel.html">DMGetLabel</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;marker&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">label</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMAddBoundary.html">DMAddBoundary</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMBoundaryConditionType.html">DM_BC_ESSENTIAL</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wall&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="cm">/* Make constant values available to pointwise functions */</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">Parameter</span><span class="w">  </span><span class="o">*</span><span class="n">param</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">param</span><span class="p">));</span>
<span class="w">    </span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">;</span><span class="w"> </span><span class="cm">/* dynamic shear viscosity, Pa s */</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetConstants.html">PetscDSSetConstants</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">constants</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">zero</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">one</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">CreatePressureNullSpace</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">origField</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="o">*</span><span class="n">nullspace</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">vec</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">funcs</span><span class="p">[</span><span class="mi">2</span><span class="p">])(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="p">};</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCheck.html">PetscCheck</a></span><span class="p">(</span><span class="n">origField</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Field %&quot;</span><span class="w"> </span><span class="n">PetscInt_FMT</span><span class="w"> </span><span class="s">&quot; should be 1 for pressure&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">origField</span><span class="p">);</span>
<span class="w">  </span><span class="n">funcs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one</span><span class="p">;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span><span class="w"> </span><span class="n">ds</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDS.html">DMGetDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ds</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectViewFromOptions.html">PetscObjectViewFromOptions</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-ds_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateGlobalVector.html">DMCreateGlobalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMProjectFunction.html">DMProjectFunction</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">funcs</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/InsertMode.html">INSERT_ALL_VALUES</a></span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecNormalize.html">VecNormalize</a></span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceCreate.html">MatNullSpaceCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_FALSE</a></span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="n">nullspace</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecDestroy.html">VecDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="cm">/* New style for field null spaces */</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="w">  </span><span class="n">pressure</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="n">nullspacePres</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetField.html">DMGetField</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pressure</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceCreate.html">MatNullSpaceCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">(</span><span class="n">pressure</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectCompose.html">PetscObjectCompose</a></span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nullspace&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceDestroy.html">MatNullSpaceDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupProblem</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">setupEqn</span><span class="p">)(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w">              </span><span class="n">cdm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dm</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscQuadrature.html">PetscQuadrature</a></span><span class="w"> </span><span class="n">q</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">       </span><span class="n">simplex</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">Nf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">Nc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;velocity&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pressure&quot;</span><span class="p">};</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">prefix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;vel_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pres_&quot;</span><span class="p">};</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDimension.html">DMGetDimension</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexIsSimplex.html">DMPlexIsSimplex</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplex</span><span class="p">));</span>
<span class="w">  </span><span class="n">Nc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span>
<span class="w">  </span><span class="n">Nc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nf</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFE.html">PetscFE</a></span><span class="w"> </span><span class="n">fe</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFECreateDefault.html">PetscFECreateDefault</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">Nc</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="w"> </span><span class="n">simplex</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fe</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">f</span><span class="p">]));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFEGetQuadrature.html">PetscFEGetQuadrature</a></span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">q</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFESetQuadrature.html">PetscFESetQuadrature</a></span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetField.html">DMSetField</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">fe</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFEDestroy.html">PetscFEDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateDS.html">DMCreateDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">((</span><span class="o">*</span><span class="n">setupEqn</span><span class="p">)(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cdm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCopyDisc.html">DMCopyDisc</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">cdm</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetNullSpaceConstructor.html">DMSetNullSpaceConstructor</a></span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CreatePressureNullSpace</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetCoarseDM.html">DMGetCoarseDM</a></span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cdm</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a></span><span class="w">   </span><span class="n">snes</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w">     </span><span class="n">dm</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w">    </span><span class="n">u</span><span class="p">;</span>
<span class="w">  </span><span class="n">AppCtx</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInitialize.html">PetscInitialize</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">help</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">ProcessOptions</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">CreateMesh</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESCreate.html">SNESCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetDM.html">SNESSetDM</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetApplicationContext.html">DMSetApplicationContext</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">SetupParameters</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">SetupProblem</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">SetupEqn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexCreateClosureIndex.html">DMPlexCreateClosureIndex</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateGlobalVector.html">DMCreateGlobalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/DMPlexSetSNESLocalFEM.html">DMPlexSetSNESLocalFEM</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetFromOptions.html">SNESSetFromOptions</a></span><span class="p">(</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/DMSNESCheckFromOptions.html">DMSNESCheckFromOptions</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Solution&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a></span><span class="w">          </span><span class="n">J</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetUp.html">SNESSetUp</a></span><span class="p">(</span><span class="n">snes</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">CreatePressureNullSpace</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESGetJacobian.html">SNESGetJacobian</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetNullSpace.html">MatSetNullSpace</a></span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceDestroy.html">MatNullSpaceDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Jacobian&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatViewFromOptions.html">MatViewFromOptions</a></span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-J_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSolve.html">SNESSolve</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecDestroy.html">VecDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESDestroy.html">SNESDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMDestroy.html">DMDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagDestroy.html">PetscBagDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="p">.</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFinalize.html">PetscFinalize</a></span><span class="p">());</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>By plugging these solutions into our equations, assuming that the velocity we choose is divergence-free, we can determine the body force necessary to make them satisfy the Stokes equations. For the quadratic solution above, we find</p>
<div class="math">
\[f = \begin{pmatrix} 1 - 4\mu \\ 1 - 4\mu \end{pmatrix} \quad \mathrm{or} \quad \begin{pmatrix} 1 - 8\mu \\ 1 - 4\mu \\ 1 - 4\mu \end{pmatrix}\]</div>
<p>which is implemented in our <code class="docutils literal notranslate"><span class="pre">f0_quadratic_u</span></code> pointwise function</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f0_quadratic_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">f0</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We let PETSc know about these solutions</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
</pre></div>
</div>
<p>These solutions will be captured exactly by the <span class="math">\(P_2-P_1\)</span> finite element space. We can use the <code class="docutils literal notranslate"><span class="pre">-dmsnes_check</span></code> option to activate function space checks. It gives the <span class="math">\(L_2\)</span> error, or <em>discretization</em> error, of the exact solution, the residual computed using the interpolation of the exact solution into our finite element space, and uses a Taylor test to check that our Jacobian matches the residual. It should converge at order 2, or be exact in the case of linear equations like Stokes. Our <span class="math">\(P_2-P_1\)</span> runs in the PETSc test section at the bottom of the source file</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nl">suffix</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="n">d_p2_p1_check</span>
<span class="w">    </span><span class="nl">requires</span><span class="p">:</span><span class="w"> </span><span class="n">triangle</span>
<span class="w">    </span><span class="nl">args</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="n">sol</span><span class="w"> </span><span class="n">quadratic</span><span class="w"> </span><span class="o">-</span><span class="n">vel_petscspace_degree</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">pres_petscspace_degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">dmsnes_check</span><span class="w"> </span><span class="mf">0.0001</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nl">suffix</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="n">d_p2_p1_check</span>
<span class="w">    </span><span class="nl">requires</span><span class="p">:</span><span class="w"> </span><span class="n">ctetgen</span>
<span class="w">    </span><span class="nl">args</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="n">sol</span><span class="w"> </span><span class="n">quadratic</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_dim</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_box_faces</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">vel_petscspace_degree</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">pres_petscspace_degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">dmsnes_check</span><span class="w"> </span><span class="mf">0.0001</span>
</pre></div>
</div>
<p>verify these claims, as we can see from the output files</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>L_2 Error: [2.08577e-16, 3.51044e-17]
L_2 Residual: 3.30808e-15
Function appears to be linear
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>L_2 Error: [8.33588e-16, 9.09348e-17]
L_2 Residual: 2.40406e-15
Function appears to be linear
</pre></div>
</div>
<p>We can carry out the same tests for the <span class="math">\(Q_2-Q_1\)</span> element,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nl">suffix</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="n">d_q2_q1_check</span>
<span class="w">    </span><span class="nl">args</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="n">sol</span><span class="w"> </span><span class="n">quadratic</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_simplex</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="n">vel_petscspace_degree</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">pres_petscspace_degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">dmsnes_check</span><span class="w"> </span><span class="mf">0.0001</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nl">suffix</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="n">d_q2_q1_check</span>
<span class="w">    </span><span class="nl">args</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="n">sol</span><span class="w"> </span><span class="n">quadratic</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_simplex</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_dim</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_box_faces</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">vel_petscspace_degree</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">pres_petscspace_degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">dmsnes_check</span><span class="w"> </span><span class="mf">0.0001</span>
</pre></div>
</div>
<p>The quadratic solution, however, cannot tell us whether our discretization is attaining the correct order of convergence, especially for higher order elements. Thus, we will define another solution based on trigonometric functions.</p>
<div class="math">
\[u = \begin{pmatrix} \sin(\pi x) + \sin(\pi y) \\ -\pi \cos(\pi x) y \end{pmatrix} \quad \mathrm{or} \quad
    \begin{pmatrix} 2 \sin(\pi x) + \sin(\pi y) + \sin(\pi z) \\ -\pi \cos(\pi x) y \\ -\pi \cos(\pi x) z \end{pmatrix}\]</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">trig_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>

<span class="w">  </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]);</span>
<span class="w">    </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">trig_p</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f0_trig_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
<span class="w">    </span><span class="n">f0</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscPowRealInt</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">ProcessOptions</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">sol</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SOL_QUADRATIC</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsBegin.html">PetscOptionsBegin</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stokes Problem Options&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;<a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a>&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsEList.html">PetscOptionsEList</a></span><span class="p">(</span><span class="s">&quot;-sol&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The MMS solution&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ex62.c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_STATIC_ARRAY_LENGTH.html">PETSC_STATIC_ARRAY_LENGTH</a></span><span class="p">(</span><span class="n">SolTypes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">[</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sol</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SolType</span><span class="p">)</span><span class="n">sol</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsEnd.html">PetscOptionsEnd</a></span><span class="p">();</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">CreateMesh</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="o">*</span><span class="n">dm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreate.html">DMCreate</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetType.html">DMSetType</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetFromOptions.html">DMSetFromOptions</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMViewFromOptions.html">DMViewFromOptions</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-dm_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupParameters</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Parameter</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="cm">/* setup PETSc parameter bag */</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagCreate.html">PetscBagCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Parameter</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetName.html">PetscBagSetName</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;par&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stokes Parameters&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagRegisterScalar.html">PetscBagRegisterScalar</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mu&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dynamic Shear Viscosity, Pa s&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetFromOptions.html">PetscBagSetFromOptions</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span><span class="w">       </span><span class="n">viewer</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PetscViewerFormat</a></span><span class="w"> </span><span class="n">format</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">         </span><span class="n">flg</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscOptionsGetViewer.html">PetscOptionsGetViewer</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-param_view&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flg</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPushFormat.html">PetscViewerPushFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagView.html">PetscBagView</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFlush.html">PetscViewerFlush</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPopFormat.html">PetscViewerPopFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerDestroy.html">PetscViewerDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupEqn</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">2</span><span class="p">])(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span><span class="w">        </span><span class="n">ds</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMLabel/DMLabel.html">DMLabel</a></span><span class="w">        </span><span class="n">label</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDS.html">DMGetDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ds</span><span class="p">));</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">SOL_QUADRATIC</span><span class="p">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f0_quadratic_u</span><span class="p">,</span><span class="w"> </span><span class="n">f1_u</span><span class="p">));</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quadratic_u</span><span class="p">;</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quadratic_p</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">SOL_TRIG</span><span class="p">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f0_trig_u</span><span class="p">,</span><span class="w"> </span><span class="n">f1_u</span><span class="p">));</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trig_u</span><span class="p">;</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trig_p</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">default</span><span class="o">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/SETERRQ.html">SETERRQ</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unsupported solution type: %s (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">[</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscMin.html">PetscMin</a></span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">,</span><span class="w"> </span><span class="n">SOL_UNKNOWN</span><span class="p">)],</span><span class="w"> </span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">f0_p</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g3_uu</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g2_up</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g1_pu</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g3_uu</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">g0_pp</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetLabel.html">DMGetLabel</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;marker&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">label</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMAddBoundary.html">DMAddBoundary</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMBoundaryConditionType.html">DM_BC_ESSENTIAL</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wall&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="cm">/* Make constant values available to pointwise functions */</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">Parameter</span><span class="w">  </span><span class="o">*</span><span class="n">param</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">param</span><span class="p">));</span>
<span class="w">    </span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">;</span><span class="w"> </span><span class="cm">/* dynamic shear viscosity, Pa s */</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetConstants.html">PetscDSSetConstants</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">constants</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">zero</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">one</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">CreatePressureNullSpace</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">origField</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="o">*</span><span class="n">nullspace</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">vec</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">funcs</span><span class="p">[</span><span class="mi">2</span><span class="p">])(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="p">};</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCheck.html">PetscCheck</a></span><span class="p">(</span><span class="n">origField</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Field %&quot;</span><span class="w"> </span><span class="n">PetscInt_FMT</span><span class="w"> </span><span class="s">&quot; should be 1 for pressure&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">origField</span><span class="p">);</span>
<span class="w">  </span><span class="n">funcs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one</span><span class="p">;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span><span class="w"> </span><span class="n">ds</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDS.html">DMGetDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ds</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectViewFromOptions.html">PetscObjectViewFromOptions</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-ds_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateGlobalVector.html">DMCreateGlobalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMProjectFunction.html">DMProjectFunction</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">funcs</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/InsertMode.html">INSERT_ALL_VALUES</a></span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecNormalize.html">VecNormalize</a></span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceCreate.html">MatNullSpaceCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_FALSE</a></span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="n">nullspace</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecDestroy.html">VecDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="cm">/* New style for field null spaces */</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="w">  </span><span class="n">pressure</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="n">nullspacePres</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetField.html">DMGetField</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pressure</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceCreate.html">MatNullSpaceCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">(</span><span class="n">pressure</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectCompose.html">PetscObjectCompose</a></span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nullspace&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceDestroy.html">MatNullSpaceDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupProblem</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">setupEqn</span><span class="p">)(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w">              </span><span class="n">cdm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dm</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscQuadrature.html">PetscQuadrature</a></span><span class="w"> </span><span class="n">q</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">       </span><span class="n">simplex</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">Nf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">Nc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;velocity&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pressure&quot;</span><span class="p">};</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">prefix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;vel_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pres_&quot;</span><span class="p">};</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDimension.html">DMGetDimension</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexIsSimplex.html">DMPlexIsSimplex</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplex</span><span class="p">));</span>
<span class="w">  </span><span class="n">Nc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span>
<span class="w">  </span><span class="n">Nc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nf</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFE.html">PetscFE</a></span><span class="w"> </span><span class="n">fe</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFECreateDefault.html">PetscFECreateDefault</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">Nc</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="w"> </span><span class="n">simplex</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fe</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">f</span><span class="p">]));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFEGetQuadrature.html">PetscFEGetQuadrature</a></span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">q</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFESetQuadrature.html">PetscFESetQuadrature</a></span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetField.html">DMSetField</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">fe</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFEDestroy.html">PetscFEDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateDS.html">DMCreateDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">((</span><span class="o">*</span><span class="n">setupEqn</span><span class="p">)(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cdm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCopyDisc.html">DMCopyDisc</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">cdm</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetNullSpaceConstructor.html">DMSetNullSpaceConstructor</a></span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CreatePressureNullSpace</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetCoarseDM.html">DMGetCoarseDM</a></span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cdm</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a></span><span class="w">   </span><span class="n">snes</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w">     </span><span class="n">dm</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w">    </span><span class="n">u</span><span class="p">;</span>
<span class="w">  </span><span class="n">AppCtx</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInitialize.html">PetscInitialize</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">help</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">ProcessOptions</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">CreateMesh</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESCreate.html">SNESCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetDM.html">SNESSetDM</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetApplicationContext.html">DMSetApplicationContext</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">SetupParameters</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">SetupProblem</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">SetupEqn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexCreateClosureIndex.html">DMPlexCreateClosureIndex</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateGlobalVector.html">DMCreateGlobalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/DMPlexSetSNESLocalFEM.html">DMPlexSetSNESLocalFEM</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetFromOptions.html">SNESSetFromOptions</a></span><span class="p">(</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/DMSNESCheckFromOptions.html">DMSNESCheckFromOptions</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Solution&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a></span><span class="w">          </span><span class="n">J</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetUp.html">SNESSetUp</a></span><span class="p">(</span><span class="n">snes</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">CreatePressureNullSpace</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESGetJacobian.html">SNESGetJacobian</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetNullSpace.html">MatSetNullSpace</a></span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceDestroy.html">MatNullSpaceDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Jacobian&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatViewFromOptions.html">MatViewFromOptions</a></span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-J_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSolve.html">SNESSolve</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecDestroy.html">VecDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESDestroy.html">SNESDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMDestroy.html">DMDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagDestroy.html">PetscBagDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="p">.</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFinalize.html">PetscFinalize</a></span><span class="p">());</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="math">
\[p = \sin(2 \pi x) + \sin(2 \pi y) \quad \mathrm{or} \quad \sin(2 \pi x) + \sin(2 \pi y) + \sin(2 \pi z)\]</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">trig_p</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f0_trig_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscSqr.html">PetscSqr</a></span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscSinReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
<span class="w">    </span><span class="n">f0</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscPowRealInt</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PetscCosReal</span><span class="p">(</span><span class="n">PETSC_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">ProcessOptions</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">sol</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SOL_QUADRATIC</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsBegin.html">PetscOptionsBegin</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stokes Problem Options&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;<a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a>&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsEList.html">PetscOptionsEList</a></span><span class="p">(</span><span class="s">&quot;-sol&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The MMS solution&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ex62.c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_STATIC_ARRAY_LENGTH.html">PETSC_STATIC_ARRAY_LENGTH</a></span><span class="p">(</span><span class="n">SolTypes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">[</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sol</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n">options</span><span class="o">-&gt;</span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SolType</span><span class="p">)</span><span class="n">sol</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscOptionsEnd.html">PetscOptionsEnd</a></span><span class="p">();</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">CreateMesh</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="o">*</span><span class="n">dm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreate.html">DMCreate</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetType.html">DMSetType</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetFromOptions.html">DMSetFromOptions</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMViewFromOptions.html">DMViewFromOptions</a></span><span class="p">(</span><span class="o">*</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-dm_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupParameters</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Parameter</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="cm">/* setup PETSc parameter bag */</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagCreate.html">PetscBagCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Parameter</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetName.html">PetscBagSetName</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;par&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stokes Parameters&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagRegisterScalar.html">PetscBagRegisterScalar</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mu&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dynamic Shear Viscosity, Pa s&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetFromOptions.html">PetscBagSetFromOptions</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span><span class="w">       </span><span class="n">viewer</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PetscViewerFormat</a></span><span class="w"> </span><span class="n">format</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">         </span><span class="n">flg</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscOptionsGetViewer.html">PetscOptionsGetViewer</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-param_view&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flg</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPushFormat.html">PetscViewerPushFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagView.html">PetscBagView</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFlush.html">PetscViewerFlush</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPopFormat.html">PetscViewerPopFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerDestroy.html">PetscViewerDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupEqn</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">2</span><span class="p">])(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span><span class="w">        </span><span class="n">ds</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMLabel/DMLabel.html">DMLabel</a></span><span class="w">        </span><span class="n">label</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDS.html">DMGetDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ds</span><span class="p">));</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">SOL_QUADRATIC</span><span class="p">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f0_quadratic_u</span><span class="p">,</span><span class="w"> </span><span class="n">f1_u</span><span class="p">));</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quadratic_u</span><span class="p">;</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quadratic_p</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">SOL_TRIG</span><span class="p">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f0_trig_u</span><span class="p">,</span><span class="w"> </span><span class="n">f1_u</span><span class="p">));</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trig_u</span><span class="p">;</span>
<span class="w">    </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trig_p</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">default</span><span class="o">:</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/SETERRQ.html">SETERRQ</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unsupported solution type: %s (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SolTypes</span><span class="p">[</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscMin.html">PetscMin</a></span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">,</span><span class="w"> </span><span class="n">SOL_UNKNOWN</span><span class="p">)],</span><span class="w"> </span><span class="n">user</span><span class="o">-&gt;</span><span class="n">sol</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetResidual.html">PetscDSSetResidual</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">f0_p</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g3_uu</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g2_up</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobian.html">PetscDSSetJacobian</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g1_pu</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g3_uu</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">g0_pp</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetExactSolution.html">PetscDSSetExactSolution</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetLabel.html">DMGetLabel</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;marker&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">label</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMAddBoundary.html">DMAddBoundary</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMBoundaryConditionType.html">DM_BC_ESSENTIAL</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wall&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">exactFuncs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="cm">/* Make constant values available to pointwise functions */</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">Parameter</span><span class="w">  </span><span class="o">*</span><span class="n">param</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">param</span><span class="p">));</span>
<span class="w">    </span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">;</span><span class="w"> </span><span class="cm">/* dynamic shear viscosity, Pa s */</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetConstants.html">PetscDSSetConstants</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">constants</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">zero</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">one</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nc</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">u</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">CreatePressureNullSpace</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">origField</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="o">*</span><span class="n">nullspace</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">vec</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">funcs</span><span class="p">[</span><span class="mi">2</span><span class="p">])(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="p">};</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCheck.html">PetscCheck</a></span><span class="p">(</span><span class="n">origField</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Field %&quot;</span><span class="w"> </span><span class="n">PetscInt_FMT</span><span class="w"> </span><span class="s">&quot; should be 1 for pressure&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">origField</span><span class="p">);</span>
<span class="w">  </span><span class="n">funcs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one</span><span class="p">;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span><span class="w"> </span><span class="n">ds</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDS.html">DMGetDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ds</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectViewFromOptions.html">PetscObjectViewFromOptions</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-ds_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateGlobalVector.html">DMCreateGlobalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMProjectFunction.html">DMProjectFunction</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">funcs</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/InsertMode.html">INSERT_ALL_VALUES</a></span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecNormalize.html">VecNormalize</a></span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceCreate.html">MatNullSpaceCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_FALSE</a></span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="n">nullspace</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecDestroy.html">VecDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">vec</span><span class="p">));</span>
<span class="w">  </span><span class="cm">/* New style for field null spaces */</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="w">  </span><span class="n">pressure</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="n">nullspacePres</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetField.html">DMGetField</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pressure</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceCreate.html">MatNullSpaceCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">(</span><span class="n">pressure</span><span class="p">),</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectCompose.html">PetscObjectCompose</a></span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nullspace&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceDestroy.html">MatNullSpaceDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">nullspacePres</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupProblem</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">setupEqn</span><span class="p">)(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w">              </span><span class="n">cdm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dm</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscQuadrature.html">PetscQuadrature</a></span><span class="w"> </span><span class="n">q</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">       </span><span class="n">simplex</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">Nf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">Nc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;velocity&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pressure&quot;</span><span class="p">};</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">prefix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;vel_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pres_&quot;</span><span class="p">};</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetDimension.html">DMGetDimension</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexIsSimplex.html">DMPlexIsSimplex</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplex</span><span class="p">));</span>
<span class="w">  </span><span class="n">Nc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span>
<span class="w">  </span><span class="n">Nc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Nf</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFE.html">PetscFE</a></span><span class="w"> </span><span class="n">fe</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFECreateDefault.html">PetscFECreateDefault</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">Nc</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="w"> </span><span class="n">simplex</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fe</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">f</span><span class="p">]));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFEGetQuadrature.html">PetscFEGetQuadrature</a></span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">q</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFESetQuadrature.html">PetscFESetQuadrature</a></span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetField.html">DMSetField</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">fe</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFEDestroy.html">PetscFEDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateDS.html">DMCreateDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">((</span><span class="o">*</span><span class="n">setupEqn</span><span class="p">)(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cdm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCopyDisc.html">DMCopyDisc</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">cdm</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetNullSpaceConstructor.html">DMSetNullSpaceConstructor</a></span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CreatePressureNullSpace</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetCoarseDM.html">DMGetCoarseDM</a></span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cdm</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a></span><span class="w">   </span><span class="n">snes</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w">     </span><span class="n">dm</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w">    </span><span class="n">u</span><span class="p">;</span>
<span class="w">  </span><span class="n">AppCtx</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInitialize.html">PetscInitialize</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">help</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">ProcessOptions</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">CreateMesh</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESCreate.html">SNESCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectComm.html">PetscObjectComm</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetDM.html">SNESSetDM</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetApplicationContext.html">DMSetApplicationContext</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">SetupParameters</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">SetupProblem</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">SetupEqn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexCreateClosureIndex.html">DMPlexCreateClosureIndex</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateGlobalVector.html">DMCreateGlobalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/DMPlexSetSNESLocalFEM.html">DMPlexSetSNESLocalFEM</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetFromOptions.html">SNESSetFromOptions</a></span><span class="p">(</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/DMSNESCheckFromOptions.html">DMSNESCheckFromOptions</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Solution&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a></span><span class="w">          </span><span class="n">J</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpace.html">MatNullSpace</a></span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSetUp.html">SNESSetUp</a></span><span class="p">(</span><span class="n">snes</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n">CreatePressureNullSpace</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESGetJacobian.html">SNESGetJacobian</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetNullSpace.html">MatSetNullSpace</a></span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatNullSpaceDestroy.html">MatNullSpaceDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Jacobian&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatViewFromOptions.html">MatViewFromOptions</a></span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-J_view&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSolve.html">SNESSolve</a></span><span class="p">(</span><span class="n">snes</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecDestroy.html">VecDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESDestroy.html">SNESDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">snes</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMDestroy.html">DMDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagDestroy.html">PetscBagDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="p">.</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFinalize.html">PetscFinalize</a></span><span class="p">());</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="math">
\[f = \begin{pmatrix} 2 \pi \cos(2 \pi x) + \mu \pi^2 \sin(\pi x) + \mu \pi^2 \sin(\pi y) \\ 2 \pi \cos(2 \pi y) - \mu \pi^3 \cos(\pi x) y \end{pmatrix} \quad \mathrm{or} \quad
\begin{pmatrix} 2 \pi \cos(2 \pi x) + 2\mu \pi^2 \sin(\pi x) + \mu \pi^2 \sin(\pi y) + \mu \pi^2 \sin(\pi z) \\ 2 \pi \cos(2 \pi y) - \mu \pi^3 cos(\pi x) y \\ 2 \pi \cos(2 \pi z) - \mu \pi^3 \cos(\pi x) z \end{pmatrix}\]</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">f0_quadratic_u</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">f0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">        </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">f0</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We can now use <code class="docutils literal notranslate"><span class="pre">-snes_convergence_estimate</span></code> to determine the convergence exponent for the discretization. This options solves the problem on a series of refined meshes, calculates the error on each mesh, and determines the slope on a logarithmic scale. For example, we do this in two dimensions, refining our mesh twice using <code class="docutils literal notranslate"><span class="pre">-convest_num_refine</span> <span class="pre">2</span></code> in the following test.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nl">suffix</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="n">d_p2_p1_conv</span>
<span class="w">    </span><span class="nl">requires</span><span class="p">:</span><span class="w"> </span><span class="n">triangle</span>
<span class="w">    </span><span class="cp"># Using -dm_refine 3 gives L_2 convergence rate: [3.0, 2.1]</span>
<span class="w">    </span><span class="nl">args</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="n">sol</span><span class="w"> </span><span class="n">trig</span><span class="w"> </span><span class="o">-</span><span class="n">vel_petscspace_degree</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">pres_petscspace_degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">snes_convergence_estimate</span><span class="w"> </span><span class="o">-</span><span class="n">convest_num_refine</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">ksp_error_if_not_converged</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">ksp_atol</span><span class="w"> </span><span class="mf">1e-10</span><span class="w"> </span><span class="o">-</span><span class="n">ksp_error_if_not_converged</span><span class="w"> </span><span class="o">-</span><span class="n">pc_use_amat</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">pc_type</span><span class="w"> </span><span class="n">fieldsplit</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_type</span><span class="w"> </span><span class="n">schur</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_fact_type</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_precondition</span><span class="w"> </span><span class="n">a11</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_off_diag_use_amat</span><span class="w"> </span>\
<span class="w">        </span><span class="o">-</span><span class="n">fieldsplit_velocity_pc_type</span><span class="w"> </span><span class="n">lu</span><span class="w"> </span><span class="o">-</span><span class="n">fieldsplit_pressure_ksp_rtol</span><span class="w"> </span><span class="mf">1e-10</span><span class="w"> </span><span class="o">-</span><span class="n">fieldsplit_pressure_pc_type</span><span class="w"> </span><span class="n">lu</span>

</pre></div>
</div>
<p>However, the test needs an accurate linear solver. Sparse LU factorizations do not, in general, do full pivoting. Thus we must deal with the zero pressure block explicitly. We use the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PCFIELDSPLIT.html">PCFIELDSPLIT</a></span></code> preconditioner and the full Schur complement factorization, but we still need a preconditioner for the Schur complement <span class="math">\(B^T A^{-1} B\)</span>. We can have PETSc construct that matrix automatically, but the cost rises steeply as the problem size increases. Instead, we use the fact that the Schur complement is spectrally equivalent to the pressure mass matrix <span class="math">\(M_p\)</span>. We can make a preconditioning matrix, which has the diagonal blocks we will use to build the preconditioners, letting PETSc know that we get the off-diagonal blocks from the original system with <code class="docutils literal notranslate"><span class="pre">-pc_fieldsplit_off_diag_use_amat</span></code> and to build the Schur complement from the original matrix using <code class="docutils literal notranslate"><span class="pre">-pc_use_amat</span></code>,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">g3_uu</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetJacobianPreconditioner.html">PetscDSSetJacobianPreconditioner</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">g0_pp</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
</pre></div>
</div>
<p>Putting this all together, and using exact solvers on the subblocks, we have</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nl">suffix</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="n">d_p2_p1_conv</span>
<span class="w">    </span><span class="nl">requires</span><span class="p">:</span><span class="w"> </span><span class="n">triangle</span>
<span class="w">    </span><span class="cp"># Using -dm_refine 3 gives L_2 convergence rate: [3.0, 2.1]</span>
<span class="w">    </span><span class="nl">args</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="n">sol</span><span class="w"> </span><span class="n">trig</span><span class="w"> </span><span class="o">-</span><span class="n">vel_petscspace_degree</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">pres_petscspace_degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">snes_convergence_estimate</span><span class="w"> </span><span class="o">-</span><span class="n">convest_num_refine</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">ksp_error_if_not_converged</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">ksp_atol</span><span class="w"> </span><span class="mf">1e-10</span><span class="w"> </span><span class="o">-</span><span class="n">ksp_error_if_not_converged</span><span class="w"> </span><span class="o">-</span><span class="n">pc_use_amat</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">pc_type</span><span class="w"> </span><span class="n">fieldsplit</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_type</span><span class="w"> </span><span class="n">schur</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_fact_type</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_precondition</span><span class="w"> </span><span class="n">a11</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_off_diag_use_amat</span><span class="w"> </span>\
<span class="w">        </span><span class="o">-</span><span class="n">fieldsplit_velocity_pc_type</span><span class="w"> </span><span class="n">lu</span><span class="w"> </span><span class="o">-</span><span class="n">fieldsplit_pressure_ksp_rtol</span><span class="w"> </span><span class="mf">1e-10</span><span class="w"> </span><span class="o">-</span><span class="n">fieldsplit_pressure_pc_type</span><span class="w"> </span><span class="n">lu</span>

</pre></div>
</div>
<p>and we see it converges, however it is superconverging in the pressure,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">L_2</span><span class="w"> </span><span class="n">convergence</span><span class="w"> </span><span class="n">rate</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">2.6</span><span class="p">,</span><span class="w"> </span><span class="mf">3.3</span><span class="p">]</span>
</pre></div>
</div>
<p>If we refine the mesh using <code class="docutils literal notranslate"><span class="pre">-dm_refine</span> <span class="pre">3</span></code>, the convergence rates become <code class="docutils literal notranslate"><span class="pre">[3.0,</span> <span class="pre">2.1]</span></code>.</p>
</section>
<section id="dealing-with-parameters">
<h2>Dealing with Parameters<a class="headerlink" href="#dealing-with-parameters" title="Permalink to this heading">#</a></h2>
<p>Like most physical problems, the Stokes problem has a parameter, the dynamic shear viscosity, which determines what solution regime we are in. To handle these parameters in PETSc, we first define a C struct to hold them,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">mu</span><span class="p">;</span><span class="w"> </span><span class="cm">/* dynamic shear viscosity */</span>
<span class="p">}</span><span class="w"> </span><span class="n">Parameter</span><span class="p">;</span>
</pre></div>
</div>
<p>and then add a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBag.html">PetscBag</a></span></code> object to our application context. We then setup the parameter object,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a></span><span class="w"> </span><span class="nf">SetupParameters</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/MPI_Comm.html">MPI_Comm</a></span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">AppCtx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Parameter</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionBeginUser.html">PetscFunctionBeginUser</a></span><span class="p">;</span>
<span class="w">  </span><span class="cm">/* setup PETSc parameter bag */</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagCreate.html">PetscBagCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Parameter</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetName.html">PetscBagSetName</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;par&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stokes Parameters&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagRegisterScalar.html">PetscBagRegisterScalar</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mu&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dynamic Shear Viscosity, Pa s&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagSetFromOptions.html">PetscBagSetFromOptions</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">));</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span><span class="w">       </span><span class="n">viewer</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PetscViewerFormat</a></span><span class="w"> </span><span class="n">format</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">         </span><span class="n">flg</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscOptionsGetViewer.html">PetscOptionsGetViewer</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-param_view&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flg</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPushFormat.html">PetscViewerPushFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagView.html">PetscBagView</a></span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFlush.html">PetscViewerFlush</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPopFormat.html">PetscViewerPopFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">      </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerDestroy.html">PetscViewerDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a></span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which will allow us to set the value from the command line using <code class="docutils literal notranslate"><span class="pre">-mu</span></code>. The <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBag.html">PetscBag</a></span></code> can also be persisted to disk with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagLoad.html">PetscBagLoad</a>/View()</span></code>. We can make these values available as constant to our pointwise functions through the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span></code> object.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">Parameter</span><span class="w">  </span><span class="o">*</span><span class="n">param</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBagGetData.html">PetscBagGetData</a></span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">bag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">param</span><span class="p">));</span>
<span class="w">    </span><span class="n">constants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">mu</span><span class="p">;</span><span class="w"> </span><span class="cm">/* dynamic shear viscosity, Pa s */</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDSSetConstants.html">PetscDSSetConstants</a></span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">constants</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="investigating-convergence">
<h2>Investigating convergence<a class="headerlink" href="#investigating-convergence" title="Permalink to this heading">#</a></h2>
<p>In order to look at the convergence of some harder problems, we will examine <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a></span> <span class="pre">ex69</span></code>. This example provides an exact solution to the variable viscosity Stokes equation. The sharp viscosity variation will allow us to investigate convergence of the solver and discretization. Briefly, a sharp viscosity variation is created across the unit square, imposed on a background pressure with given fundamental frequency. For example, we can create examples with period one half and viscosity <span class="math">\(e^{2 B x}\)</span> (solKx)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine 5 -dm_view hdf5:</span><span class="nv">$PETSC_DIR</span><span class="s2">/sol.h5 -snes_view_solution hdf5:</span><span class="nv">$PETSC_DIR</span><span class="s2">/sol.h5::append -exact_vec_view hdf5:</span><span class="nv">$PETSC_DIR</span><span class="s2">/sol.h5::append -m 2 -n 2 -B 1&quot;</span>
<span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine 5 -dm_view hdf5:</span><span class="nv">$PETSC_DIR</span><span class="s2">/sol.h5 -snes_view_solution hdf5:</span><span class="nv">$PETSC_DIR</span><span class="s2">/sol.h5::append -exact_vec_view hdf5:</span><span class="nv">$PETSC_DIR</span><span class="s2">/sol.h5::append -m 2 -n 2 -B 3.75&quot;</span>
</pre></div>
</div>
<p>which are show in the figure below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><figure class="align-default" id="id3769">
<img alt="../../_images/ex69_sol_m_2_n_2_B_1.png" src="../../_images/ex69_sol_m_2_n_2_B_1.png" />
<figcaption>
<p><span class="caption-text">Solution for <span class="math">\(m=2\)</span>, <span class="math">\(n=2\)</span>, <span class="math">\(B=1\)</span></span><a class="headerlink" href="#id3769" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id3770">
<img alt="../../_images/ex69_sol_m_2_n_2_B_375.png" src="../../_images/ex69_sol_m_2_n_2_B_375.png" />
<figcaption>
<p><span class="caption-text">Solution for <span class="math">\(m=2\)</span>, <span class="math">\(n=2\)</span>, <span class="math">\(B=3.75\)</span></span><a class="headerlink" href="#id3770" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</td>
</tr>
</tbody>
</table>
<section id="debugging">
<h3>Debugging<a class="headerlink" href="#debugging" title="Permalink to this heading">#</a></h3>
<p>If we can provide the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DT/PetscDS.html">PetscDS</a></span></code> object in our problem with the exact solution function, PETSc has good support for debugging our discretization and solver. We can use the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/PetscConvEst.html">PetscConvEst</a></span></code> object to check the convergence behavior of our element automatically. For example, if we use the <code class="docutils literal notranslate"><span class="pre">-snes_convergence_estimate</span></code> option, PETSc will solve our nonlinear equations on a series of refined meshes, use our exact solution to calculate the error, and then fit this line on a log-log scale to get the convergence rate,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nl">suffix</span><span class="p">:</span><span class="w"> </span><span class="n">p2p1_conv</span>
<span class="w">    </span><span class="nl">requires</span><span class="p">:</span><span class="w"> </span><span class="n">triangle</span>
<span class="w">    </span><span class="cp"># -dm_refine 2 gives L_2 convergence rate: [3.0, 2.2]</span>
<span class="w">    </span><span class="nl">args</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_separate_marker</span><span class="w"> </span><span class="o">-</span><span class="n">vel_petscspace_degree</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">pres_petscspace_degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">snes_error_if_not_converged</span><span class="w"> </span><span class="o">-</span><span class="n">snes_convergence_estimate</span><span class="w"> </span><span class="o">-</span><span class="n">convest_num_refine</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">ksp_rtol</span><span class="w"> </span><span class="mf">1.</span><span class="n">e</span><span class="mi">-9</span><span class="w"> </span><span class="o">-</span><span class="n">ksp_error_if_not_converged</span><span class="w"> </span><span class="o">-</span><span class="n">pc_use_amat</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">pc_type</span><span class="w"> </span><span class="n">fieldsplit</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_type</span><span class="w"> </span><span class="n">schur</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_factorization_type</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_precondition</span><span class="w"> </span><span class="n">a11</span><span class="w"> </span>\
<span class="w">        </span><span class="o">-</span><span class="n">fieldsplit_velocity_pc_type</span><span class="w"> </span><span class="n">lu</span><span class="w"> </span>\
<span class="w">        </span><span class="o">-</span><span class="n">fieldsplit_pressure_ksp_rtol</span><span class="w"> </span><span class="mf">1.</span><span class="n">e</span><span class="mi">-9</span><span class="w"> </span><span class="o">-</span><span class="n">fieldsplit_pressure_pc_type</span><span class="w"> </span><span class="n">lu</span>
</pre></div>
</div>
<p>If we initially refine the mesh twice, <code class="docutils literal notranslate"><span class="pre">-dm_refine</span> <span class="pre">2</span></code>, we get</p>
<blockquote>
<div><p>L_2 convergence rate: [3.0, 2.2]</p>
</div></blockquote>
<p>which are the convergence rates we expect for the velocity and pressure using a <span class="math">\(P_2-P_1\)</span> discretization. For <span class="math">\(Q_1-P_0\)</span></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nl">suffix</span><span class="p">:</span><span class="w"> </span><span class="n">q1p0_conv</span>
<span class="w">    </span><span class="cp"># -dm_refine 2 gives L_2 convergence rate: [2.0, 1.0]</span>
<span class="w">    </span><span class="nl">args</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_simplex</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_separate_marker</span><span class="w"> </span><span class="o">-</span><span class="n">vel_petscspace_degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">pres_petscspace_degree</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">snes_error_if_not_converged</span><span class="w"> </span><span class="o">-</span><span class="n">snes_convergence_estimate</span><span class="w"> </span><span class="o">-</span><span class="n">convest_num_refine</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">ksp_rtol</span><span class="w"> </span><span class="mf">1.</span><span class="n">e</span><span class="mi">-9</span><span class="w"> </span><span class="o">-</span><span class="n">ksp_error_if_not_converged</span><span class="w"> </span><span class="o">-</span><span class="n">pc_use_amat</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">pc_type</span><span class="w"> </span><span class="n">fieldsplit</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_type</span><span class="w"> </span><span class="n">schur</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_factorization_type</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_precondition</span><span class="w"> </span><span class="n">a11</span><span class="w"> </span>\
<span class="w">        </span><span class="o">-</span><span class="n">fieldsplit_velocity_pc_type</span><span class="w"> </span><span class="n">lu</span><span class="w"> </span>\
<span class="w">        </span><span class="o">-</span><span class="n">fieldsplit_pressure_ksp_rtol</span><span class="w"> </span><span class="mf">1.</span><span class="n">e</span><span class="mi">-9</span><span class="w"> </span><span class="o">-</span><span class="n">fieldsplit_pressure_pc_type</span><span class="w"> </span><span class="n">lu</span>
</pre></div>
</div>
<p>we get</p>
<blockquote>
<div><p>L_2 convergence rate: [2.0, 1.0]</p>
</div></blockquote>
<p>This is a sensitive check that everything is working correctly. However, if this is wrong, where can I start? More fine-grained checks are available using the <code class="docutils literal notranslate"><span class="pre">-dmsnes_check</span></code> option. Using this for our <span class="math">\(P_2-P_1\)</span> example (the <code class="docutils literal notranslate"><span class="pre">p2p1</span></code> test), we have</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">L_2</span><span class="w"> </span><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0.000439127</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0376629</span><span class="p">]</span>
<span class="n">L_2</span><span class="w"> </span><span class="n">Residual</span><span class="o">:</span><span class="w"> </span><span class="mf">0.0453958</span>
<span class="n">Function</span><span class="w"> </span><span class="n">appears</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">linear</span>
</pre></div>
</div>
<p>The first line records the discretization error for our exact solution. This means that we project our solution function into the finite element space and then calculate the <span class="math">\(L_2\)</span> norm of the difference between the exact solution and its projection. The norm is computed for each field separately. Next, PETSc calculates the residual using the projected exact solution as input. This should be small, and as the mesh is refined it should approach zero. Last, PETSc uses a Taylor test to try and determine how the error in the linear model scales as a function of the perturbation <span class="math">\(h\)</span>. Thus, in a nonlinear situation we would expect</p>
<blockquote>
<div><p>Taylor approximation converging at order 2.0</p>
</div></blockquote>
<p>In this case, since the viscosity does not depend on the velocity or pressure fields, we detect that the linear model is exact</p>
<blockquote>
<div><p>Function appears to be linear</p>
</div></blockquote>
<p>Suppose that we have made an error in the Jacobian. For instance, let us accidentally flip the sign of the pressure term in the momentum Jacobian.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stokes_momentum_pres_J</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">u_tShift</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">g2</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">d</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="n">g2</span><span class="p">[</span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* \frac{\partial\psi^{u_d}}{\partial x_d} */</span>
</pre></div>
</div>
<p>When we run, we get a failure of the nonlinear solver. Our checking reveals that the Jacobian is wrong because it is converging at order 1 instead of 2, meaning the linear term is not correct in our model.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_monitor -ksp_monitor_true_residual -ksp_converged_reason&quot;</span>
<span class="go">L_2 Error: [0.000439127, 0.0376629]</span>
<span class="go">L_2 Residual: 0.0453958</span>
<span class="go">Taylor approximation converging at order 1.00</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 1.170604545948e-01</span>
<span class="go">    0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 4.965098891419e-01 true resid norm 1.170604545948e-01 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">    1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 9.236805404733e-11 true resid norm 1.460082233654e-12 ||r(i)||/||b|| 1.247289051378e-11</span>
<span class="go">  Linear solve converged due to CONVERGED_ATOL iterations 1</span>
<span class="go">[0]PETSC ERROR: --------------------- Error Message --------------------------------------------------------------</span>
<span class="go">[0]PETSC ERROR:</span>
<span class="go">[0]PETSC ERROR: <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSolve.html">SNESSolve</a> has not converged</span>
</pre></div>
</div>
<p>In order to track down the error, we can use <code class="docutils literal notranslate"><span class="pre">-snes_test_jacobian</span></code> which computes a finite difference approximation to the Jacobian and compares that to the analytic Jacobian. We ignore the first test, which occurs during our testing of the Jacobian, and look at the test that happens during the first Newton iterate. We see that the relative error in the Frobenius norm is about one percent, which indicates we have a real problem.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -snes_test_jacobian&quot;</span>
<span class="go">L_2 Error: [0.000439127, 0.0376629]</span>
<span class="go">L_2 Residual: 0.0453958</span>
<span class="go">  ---------- Testing Jacobian -------------</span>
<span class="go">  Run with -snes_test_jacobian_view and optionally -snes_test_jacobian &lt;threshold&gt; to show difference</span>
<span class="go">    of hand-coded and finite difference Jacobian entries greater than &lt;threshold&gt;.</span>
<span class="go">  Testing hand-coded Jacobian, if (for double precision runs) ||J - Jfd||_F/||J||_F is</span>
<span class="go">    O(1.e-8), the hand-coded Jacobian is probably correct.</span>
<span class="go">  ||J - Jfd||_F/||J||_F = 136.793, ||J - Jfd||_F = 136.793</span>
<span class="go">  ---------- Testing Jacobian for preconditioner -------------</span>
<span class="go">  ||J - Jfd||_F/||J||_F = 136.793, ||J - Jfd||_F = 136.793</span>
<span class="go">Taylor approximation converging at order 1.00</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 1.170604545948e-01</span>
<span class="go">  ---------- Testing Jacobian -------------</span>
<span class="go">  ||J - Jfd||_F/||J||_F = 0.0119377, ||J - Jfd||_F = 1.63299</span>
<span class="go">  ---------- Testing Jacobian for preconditioner -------------</span>
<span class="go">  ||J - Jfd||_F/||J||_F = 0.008471, ||J - Jfd||_F = 1.15873</span>
<span class="go">    0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 4.965098891419e-01 true resid norm 1.170604545948e-01 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">    1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 9.236804064319e-11 true resid norm 1.460031196842e-12 ||r(i)||/||b|| 1.247245452699e-11</span>
<span class="go">  Linear solve converged due to CONVERGED_ATOL iterations 1</span>
<span class="go">[0]PETSC ERROR: --------------------- Error Message --------------------------------------------------------------</span>
<span class="go">[0]PETSC ERROR:</span>
<span class="go">[0]PETSC ERROR: <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSolve.html">SNESSolve</a> has not converged</span>
</pre></div>
</div>
<p>At this point, we could just go back and check the code. However, PETSc will also print out the differences between the analytic and approximate Jacobians. When we give the <code class="docutils literal notranslate"><span class="pre">-snes_test_jacobian_view</span></code> option, the code will print both Jacobians (which we omit) and then their difference, and will also do this for the preconditioning matrix (which we omit). It is clear from the output that the <span class="math">\(u-p\)</span> block of the Jacobian is wrong, and thus we know right where to look for our error. Moreover, if we look at the values in row 15, we see that the values just differ by a sign.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -snes_test_jacobian&quot;</span>
<span class="go">        Hand-coded minus finite-difference Jacobian with tolerance 1e-05 ----------</span>
<span class="go"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">  type: seqaij</span>
<span class="go">row 0:</span>
<span class="go">row 1:</span>
<span class="go">row 2:</span>
<span class="go">row 3:</span>
<span class="go">row 4:</span>
<span class="go">row 5:</span>
<span class="go">row 6:</span>
<span class="go">row 7:</span>
<span class="go">row 8:</span>
<span class="go">row 9:</span>
<span class="go">row 10:</span>
<span class="go">row 11:</span>
<span class="go">row 12:</span>
<span class="go">row 13:</span>
<span class="go">row 14:</span>
<span class="go">row 15: (0, 0.166667)  (2, -0.166667)</span>
<span class="go">row 16: (0, 0.166667)  (2, -0.166667)  (5, 0.166667)  (8, -0.166667)</span>
<span class="go">row 17: (0, 0.166667)  (2, 0.166667)  (5, -0.166667)  (8, -0.166667)</span>
<span class="go">row 18: (0, 0.166667)  (5, -0.166667)</span>
<span class="go">row 19: (5, 0.166667)  (8, -0.166667)  (11, 0.166667)  (13, -0.166667)</span>
<span class="go">row 20: (5, 0.166667)  (8, 0.166667)  (11, -0.166667)  (13, -0.166667)</span>
<span class="go">row 21: (5, 0.166667)  (11, -0.166667)</span>
<span class="go">row 22: (5, 0.333333)  (8, -0.333333)</span>
<span class="go">row 23: (2, 0.166667)  (5, 0.166667)  (8, -0.166667)  (11, -0.166667)</span>
<span class="go">row 24: (2, 0.166667)  (3, -0.166667)  (5, 0.166667)  (8, -0.166667)</span>
<span class="go">row 25: (2, 0.333333)  (8, -0.333333)</span>
<span class="go">row 26: (2, 0.166667)  (3, -0.166667)  (8, 0.166667)  (10, -0.166667)</span>
<span class="go">row 27: (2, 0.166667)  (3, 0.166667)  (8, -0.166667)  (10, -0.166667)</span>
<span class="go">row 28: (3, 0.166667)  (10, -0.166667)</span>
<span class="go">row 29: (8, 0.333333)  (10, -0.333333)</span>
<span class="go">row 30: (3, 0.166667)  (8, 0.166667)  (10, -0.166667)  (13, -0.166667)</span>
<span class="go">row 31: (2, 0.166667)  (3, -0.166667)</span>
<span class="go">row 32: (8, 0.166667)  (10, -0.166667)  (13, 0.166667)  (14, -0.166667)</span>
<span class="go">row 33: (8, 0.166667)  (10, 0.166667)  (13, -0.166667)  (14, -0.166667)</span>
<span class="go">row 34: (10, 0.166667)  (14, -0.166667)</span>
<span class="go">row 35: (13, 0.166667)  (14, -0.166667)</span>
<span class="go">row 36: (8, 0.166667)  (10, -0.166667)  (11, 0.166667)  (13, -0.166667)</span>
<span class="go">row 37: (8, 0.333333)  (13, -0.333333)</span>
<span class="go">row 38: (11, 0.166667)  (13, -0.166667)</span>
<span class="go">          0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 4.965098891419e-01 true resid norm 1.170604545948e-01 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">          1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 9.236804067326e-11 true resid norm 1.460031196842e-12 ||r(i)||/||b|| 1.247245452699e-11</span>
<span class="go">        Linear solve converged due to CONVERGED_ATOL iterations 1</span>
<span class="go">      [0]PETSC ERROR: --------------------- Error Message --------------------------------------------------------------</span>
<span class="go">      [0]PETSC ERROR:</span>
<span class="go">      [0]PETSC ERROR: <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESSolve.html">SNESSolve</a> has not converged</span>
</pre></div>
</div>
<p>Can we see that the Schur complement of Q1-P0 is ill-conditioned?</p>
</section>
<section id="optimizing-the-solver">
<h3>Optimizing the Solver<a class="headerlink" href="#optimizing-the-solver" title="Permalink to this heading">#</a></h3>
<p>In order to see exactly what solver we have employed, we can use the <code class="docutils literal notranslate"><span class="pre">-snes_view</span></code> option. When checking <span class="math">\(P_2-P_1\)</span> convergence, we use an exact solver, but it must have several parts in order to deal with the saddle-point in the Jacobian. Using the test system to provide our extra option, we get</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_view&quot;</span>
<span class="go"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Object: 1 MPI process</span>
<span class="go">  type: newtonls</span>
<span class="go">  maximum iterations=50, maximum function evaluations=10000</span>
<span class="go">  tolerances: relative=1e-08, absolute=1e-50, solution=1e-08</span>
<span class="go">  total number of linear solver iterations=1</span>
<span class="go">  total number of function evaluations=2</span>
<span class="go">  norm schedule ALWAYS</span>
<span class="go">  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESLineSearch.html">SNESLineSearch</a> Object: 1 MPI process</span>
<span class="go">    type: bt</span>
<span class="go">      interpolation: cubic</span>
<span class="go">      alpha=1.000000e-04</span>
<span class="go">    maxstep=1.000000e+08, minlambda=1.000000e-12</span>
<span class="go">    tolerances: relative=1.000000e-08, absolute=1.000000e-15, lambda=1.000000e-08</span>
<span class="go">    maximum iterations=40</span>
<span class="go">  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> Object: 1 MPI process</span>
<span class="go">    type: gmres</span>
<span class="go">      restart=30, using Classical (unmodified) Gram-Schmidt Orthogonalization with no iterative refinement</span>
<span class="go">      happy breakdown tolerance 1e-30</span>
<span class="go">    maximum iterations=10000, initial guess is zero</span>
<span class="go">    tolerances:  relative=1e-09, absolute=1e-10, divergence=10000.</span>
<span class="go">    left preconditioning</span>
<span class="go">    using PRECONDITIONED norm type for convergence test</span>
<span class="go">  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PC.html">PC</a> Object: 1 MPI process</span>
<span class="go">    type: fieldsplit</span>
<span class="go">      FieldSplit with Schur preconditioner, factorization FULL</span>
<span class="go">      Preconditioner for the Schur complement formed from A11</span>
<span class="go">      Split info:</span>
<span class="go">      Split number 0 Defined by <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/IS/IS.html">IS</a></span>
<span class="go">      Split number 1 Defined by <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/IS/IS.html">IS</a></span>
<span class="go">      <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> solver for A00 block</span>
<span class="go">        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">          type: gmres</span>
<span class="go">            restart=30, using Classical (unmodified) Gram-Schmidt Orthogonalization with no iterative refinement</span>
<span class="go">            happy breakdown tolerance 1e-30</span>
<span class="go">          maximum iterations=10000, initial guess is zero</span>
<span class="go">          tolerances:  relative=1e-05, absolute=1e-50, divergence=10000.</span>
<span class="go">          left preconditioning</span>
<span class="go">          using PRECONDITIONED norm type for convergence test</span>
<span class="go">        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PC.html">PC</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">          type: lu</span>
<span class="go">            out-of-place factorization</span>
<span class="go">            tolerance for zero pivot 2.22045e-14</span>
<span class="go">            matrix ordering: nd</span>
<span class="go">            factor fill ratio given 5., needed 1.15761</span>
<span class="go">              Factored matrix follows:</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=30, cols=30</span>
<span class="go">                  package used to perform factorization: petsc</span>
<span class="go">                  total: nonzeros=426, allocated nonzeros=426</span>
<span class="go">                    using I-node routines: found 17 nodes, limit used is 5</span>
<span class="go">          linear system matrix followed by preconditioner matrix:</span>
<span class="go">          <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">            type: seqaij</span>
<span class="go">            rows=30, cols=30</span>
<span class="go">            total: nonzeros=368, allocated nonzeros=368</span>
<span class="go">            total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">              using I-node routines: found 20 nodes, limit used is 5</span>
<span class="go">          <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">            type: seqaij</span>
<span class="go">            rows=30, cols=30</span>
<span class="go">            total: nonzeros=368, allocated nonzeros=368</span>
<span class="go">            total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">              using I-node routines: found 20 nodes, limit used is 5</span>
<span class="go">      <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> solver for S = A11 - A10 inv(A00) A01</span>
<span class="go">        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> Object: (fieldsplit_pressure_) 1 MPI process</span>
<span class="go">          type: gmres</span>
<span class="go">            restart=30, using Classical (unmodified) Gram-Schmidt Orthogonalization with no iterative refinement</span>
<span class="go">            happy breakdown tolerance 1e-30</span>
<span class="go">          maximum iterations=10000, initial guess is zero</span>
<span class="go">          tolerances:  relative=1e-09, absolute=1e-50, divergence=10000.</span>
<span class="go">          left preconditioning</span>
<span class="go">          using PRECONDITIONED norm type for convergence test</span>
<span class="go">        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PC.html">PC</a> Object: (fieldsplit_pressure_) 1 MPI process</span>
<span class="go">          type: lu</span>
<span class="go">            out-of-place factorization</span>
<span class="go">            tolerance for zero pivot 2.22045e-14</span>
<span class="go">            matrix ordering: nd</span>
<span class="go">            factor fill ratio given 5., needed 1.2439</span>
<span class="go">              Factored matrix follows:</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=9, cols=9</span>
<span class="go">                  package used to perform factorization: petsc</span>
<span class="go">                  total: nonzeros=51, allocated nonzeros=51</span>
<span class="go">                    not using I-node routines</span>
<span class="go">          linear system matrix followed by preconditioner matrix:</span>
<span class="go">          <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (fieldsplit_pressure_) 1 MPI process</span>
<span class="go">            type: schurcomplement</span>
<span class="go">            rows=9, cols=9</span>
<span class="go">              has attached null space</span>
<span class="go">              Schur complement A11 - A10 inv(A00) A01</span>
<span class="go">              A11</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=9, cols=9</span>
<span class="go">                  total: nonzeros=41, allocated nonzeros=41</span>
<span class="go">                  total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                    has attached null space</span>
<span class="go">                    not using I-node routines</span>
<span class="go">              A10</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=9, cols=30</span>
<span class="go">                  total: nonzeros=122, allocated nonzeros=122</span>
<span class="go">                  total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                    not using I-node routines</span>
<span class="go">              <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> of A00</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">                  type: gmres</span>
<span class="go">                    restart=30, using Classical (unmodified) Gram-Schmidt Orthogonalization with no iterative refinement</span>
<span class="go">                    happy breakdown tolerance 1e-30</span>
<span class="go">                  maximum iterations=10000, initial guess is zero</span>
<span class="go">                  tolerances:  relative=1e-05, absolute=1e-50, divergence=10000.</span>
<span class="go">                  left preconditioning</span>
<span class="go">                  using PRECONDITIONED norm type for convergence test</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PC.html">PC</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">                  type: lu</span>
<span class="go">                    out-of-place factorization</span>
<span class="go">                    tolerance for zero pivot 2.22045e-14</span>
<span class="go">                    matrix ordering: nd</span>
<span class="go">                    factor fill ratio given 5., needed 1.15761</span>
<span class="go">                      Factored matrix follows:</span>
<span class="go">                        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                          type: seqaij</span>
<span class="go">                          rows=30, cols=30</span>
<span class="go">                          package used to perform factorization: petsc</span>
<span class="go">                          total: nonzeros=426, allocated nonzeros=426</span>
<span class="go">                            using I-node routines: found 17 nodes, limit used is 5</span>
<span class="go">                  linear system matrix followed by preconditioner matrix:</span>
<span class="go">                  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                    type: seqaij</span>
<span class="go">                    rows=30, cols=30</span>
<span class="go">                    total: nonzeros=368, allocated nonzeros=368</span>
<span class="go">                    total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                      using I-node routines: found 20 nodes, limit used is 5</span>
<span class="go">                  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">                    type: seqaij</span>
<span class="go">                    rows=30, cols=30</span>
<span class="go">                    total: nonzeros=368, allocated nonzeros=368</span>
<span class="go">                    total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                      using I-node routines: found 20 nodes, limit used is 5</span>
<span class="go">              A01</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=30, cols=9</span>
<span class="go">                  total: nonzeros=122, allocated nonzeros=122</span>
<span class="go">                  total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                    using I-node routines: found 20 nodes, limit used is 5</span>
<span class="go">          <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (fieldsplit_pressure_) 1 MPI process</span>
<span class="go">            type: seqaij</span>
<span class="go">            rows=9, cols=9</span>
<span class="go">            total: nonzeros=41, allocated nonzeros=41</span>
<span class="go">            total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">              not using I-node routines</span>
<span class="go">    linear system matrix followed by preconditioner matrix:</span>
<span class="go">    <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">      type: seqaij</span>
<span class="go">      rows=39, cols=39</span>
<span class="go">      total: nonzeros=653, allocated nonzeros=653</span>
<span class="go">      total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">        has attached null space</span>
<span class="go">        using I-node routines: found 24 nodes, limit used is 5</span>
<span class="go">    <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (prec_) 1 MPI process</span>
<span class="go">      type: seqaij</span>
<span class="go">      rows=39, cols=39</span>
<span class="go">      total: nonzeros=653, allocated nonzeros=653</span>
<span class="go">      total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">        using I-node routines: found 24 nodes, limit used is 5</span>
</pre></div>
</div>
<p>Going through this piece-by-piece, we can see all the parts of our solver. At the top level, we have a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a></span></code> using Newtons method</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_view&quot;</span>
<span class="go"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Object: 1 MPI process</span>
<span class="go">  type: newtonls</span>
<span class="go">  maximum iterations=50, maximum function evaluations=10000</span>
<span class="go">  tolerances: relative=1e-08, absolute=1e-50, solution=1e-08</span>
<span class="go">  total number of linear solver iterations=1</span>
<span class="go">  total number of function evaluations=2</span>
<span class="go">  norm schedule ALWAYS</span>
<span class="go">  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNESLineSearch.html">SNESLineSearch</a> Object: 1 MPI process</span>
<span class="go">    type: bt</span>
<span class="go">      interpolation: cubic</span>
<span class="go">      alpha=1.000000e-04</span>
<span class="go">    maxstep=1.000000e+08, minlambda=1.000000e-12</span>
<span class="go">    tolerances: relative=1.000000e-08, absolute=1.000000e-15, lambda=1.000000e-08</span>
<span class="go">    maximum iterations=40</span>
</pre></div>
</div>
<p>For each nonlinear step, we use <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSPGMRES.html">KSPGMRES</a></span></code> to solve the Newton equation, preconditioned by <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PCFIELDSPLIT.html">PCFIELDSPLIT</a></span></code>. We split the problem into two blocks, with the split determined by our <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code>, and combine those blocks using a Schur complement. The Schur complement is faithful since we use the <code class="docutils literal notranslate"><span class="pre">FULL</span></code> factorization type.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_view&quot;</span>
<span class="go">  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> Object: 1 MPI process</span>
<span class="go">    type: gmres</span>
<span class="go">      restart=30, using Classical (unmodified) Gram-Schmidt Orthogonalization with no iterative refinement</span>
<span class="go">      happy breakdown tolerance 1e-30</span>
<span class="go">    maximum iterations=10000, initial guess is zero</span>
<span class="go">    tolerances:  relative=1e-09, absolute=1e-10, divergence=10000.</span>
<span class="go">    left preconditioning</span>
<span class="go">    using PRECONDITIONED norm type for convergence test</span>
<span class="go">  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PC.html">PC</a> Object: 1 MPI process</span>
<span class="go">    type: fieldsplit</span>
<span class="go">      FieldSplit with Schur preconditioner, factorization FULL</span>
<span class="go">      Preconditioner for the Schur complement formed from A11</span>
<span class="go">      Split info:</span>
<span class="go">      Split number 0 Defined by <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/IS/IS.html">IS</a></span>
<span class="go">      Split number 1 Defined by <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/IS/IS.html">IS</a></span>
</pre></div>
</div>
<p>We form the preconditioner for the Schur complement from the (1,1) block of our preconditioning matrix, which we have set to be the viscosity-weighted mass matrix</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stokes_identity_J_kx</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">u_tShift</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">g0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PetscExpReal</span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">  </span><span class="n">g0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">mu</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stokes_identity_J_cx</span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">Nf</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">NfAux</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">uOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">u_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">aOff_x</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_t</span><span class="p">[],</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">a_x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">u_tShift</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">x</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numConstants</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">constants</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="n">g0</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">  </span><span class="n">g0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">mu</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p>The solver for the first block, representing the velocity, is GMRES/LU. Note that the prefix is <code class="docutils literal notranslate"><span class="pre">fieldsplit_velocity_</span></code>, constructed automatically from the name of the field in our DM. Also note that there are two matrices, one from our original matrix, and one from our preconditioning matrix, but they are identical. In an optimized, scalable solver, this block would likely be solved by multigrid, but here we use LU for verification purposes.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_view&quot;</span>
<span class="go">      <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> solver for A00 block</span>
<span class="go">        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">          type: gmres</span>
<span class="go">            restart=30, using Classical (unmodified) Gram-Schmidt Orthogonalization with no iterative refinement</span>
<span class="go">            happy breakdown tolerance 1e-30</span>
<span class="go">          maximum iterations=10000, initial guess is zero</span>
<span class="go">          tolerances:  relative=1e-05, absolute=1e-50, divergence=10000.</span>
<span class="go">          left preconditioning</span>
<span class="go">          using PRECONDITIONED norm type for convergence test</span>
<span class="go">        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PC.html">PC</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">          type: lu</span>
<span class="go">            out-of-place factorization</span>
<span class="go">            tolerance for zero pivot 2.22045e-14</span>
<span class="go">            matrix ordering: nd</span>
<span class="go">            factor fill ratio given 5., needed 1.15761</span>
<span class="go">              Factored matrix follows:</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=30, cols=30</span>
<span class="go">                  package used to perform factorization: petsc</span>
<span class="go">                  total: nonzeros=426, allocated nonzeros=426</span>
<span class="go">                    using I-node routines: found 17 nodes, limit used is 5</span>
<span class="go">          linear system matrix followed by preconditioner matrix:</span>
<span class="go">          <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">            type: seqaij</span>
<span class="go">            rows=30, cols=30</span>
<span class="go">            total: nonzeros=368, allocated nonzeros=368</span>
<span class="go">            total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">              using I-node routines: found 20 nodes, limit used is 5</span>
<span class="go">          <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">            type: seqaij</span>
<span class="go">            rows=30, cols=30</span>
<span class="go">            total: nonzeros=368, allocated nonzeros=368</span>
<span class="go">            total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">              using I-node routines: found 20 nodes, limit used is 5</span>
</pre></div>
</div>
<p>The solver for the second block, with prefix <code class="docutils literal notranslate"><span class="pre">fieldsplit_pressure_</span></code>, is also GMRES/LU, however we cannot factor the Schur complement operator since we never explicitly assemble it. Thus we assemble the viscosity-weighted mass matrix on the pressure space as an approximation. Notice that the Schur complement has the velocity solver embedded in it.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_view&quot;</span>
<span class="go">      <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> solver for S = A11 - A10 inv(A00) A01</span>
<span class="go">        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> Object: (fieldsplit_pressure_) 1 MPI process</span>
<span class="go">          type: gmres</span>
<span class="go">            restart=30, using Classical (unmodified) Gram-Schmidt Orthogonalization with no iterative refinement</span>
<span class="go">            happy breakdown tolerance 1e-30</span>
<span class="go">          maximum iterations=10000, initial guess is zero</span>
<span class="go">          tolerances:  relative=1e-09, absolute=1e-50, divergence=10000.</span>
<span class="go">          left preconditioning</span>
<span class="go">          using PRECONDITIONED norm type for convergence test</span>
<span class="go">        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PC.html">PC</a> Object: (fieldsplit_pressure_) 1 MPI process</span>
<span class="go">          type: lu</span>
<span class="go">            out-of-place factorization</span>
<span class="go">            tolerance for zero pivot 2.22045e-14</span>
<span class="go">            matrix ordering: nd</span>
<span class="go">            factor fill ratio given 5., needed 1.2439</span>
<span class="go">              Factored matrix follows:</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=9, cols=9</span>
<span class="go">                  package used to perform factorization: petsc</span>
<span class="go">                  total: nonzeros=51, allocated nonzeros=51</span>
<span class="go">                    not using I-node routines</span>
<span class="go">          linear system matrix followed by preconditioner matrix:</span>
<span class="go">          <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (fieldsplit_pressure_) 1 MPI process</span>
<span class="go">            type: schurcomplement</span>
<span class="go">            rows=9, cols=9</span>
<span class="go">              has attached null space</span>
<span class="go">              Schur complement A11 - A10 inv(A00) A01</span>
<span class="go">              A11</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=9, cols=9</span>
<span class="go">                  total: nonzeros=41, allocated nonzeros=41</span>
<span class="go">                  total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                    has attached null space</span>
<span class="go">                    not using I-node routines</span>
<span class="go">              A10</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=9, cols=30</span>
<span class="go">                  total: nonzeros=122, allocated nonzeros=122</span>
<span class="go">                  total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                    not using I-node routines</span>
<span class="go">              <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> of A00</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">                  type: gmres</span>
<span class="go">                    restart=30, using Classical (unmodified) Gram-Schmidt Orthogonalization with no iterative refinement</span>
<span class="go">                    happy breakdown tolerance 1e-30</span>
<span class="go">                  maximum iterations=10000, initial guess is zero</span>
<span class="go">                  tolerances:  relative=1e-05, absolute=1e-50, divergence=10000.</span>
<span class="go">                  left preconditioning</span>
<span class="go">                  using PRECONDITIONED norm type for convergence test</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PC.html">PC</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">                  type: lu</span>
<span class="go">                    out-of-place factorization</span>
<span class="go">                    tolerance for zero pivot 2.22045e-14</span>
<span class="go">                    matrix ordering: nd</span>
<span class="go">                    factor fill ratio given 5., needed 1.15761</span>
<span class="go">                      Factored matrix follows:</span>
<span class="go">                        <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                          type: seqaij</span>
<span class="go">                          rows=30, cols=30</span>
<span class="go">                          package used to perform factorization: petsc</span>
<span class="go">                          total: nonzeros=426, allocated nonzeros=426</span>
<span class="go">                            using I-node routines: found 17 nodes, limit used is 5</span>
<span class="go">                  linear system matrix followed by preconditioner matrix:</span>
<span class="go">                  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                    type: seqaij</span>
<span class="go">                    rows=30, cols=30</span>
<span class="go">                    total: nonzeros=368, allocated nonzeros=368</span>
<span class="go">                    total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                      using I-node routines: found 20 nodes, limit used is 5</span>
<span class="go">                  <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (fieldsplit_velocity_) 1 MPI process</span>
<span class="go">                    type: seqaij</span>
<span class="go">                    rows=30, cols=30</span>
<span class="go">                    total: nonzeros=368, allocated nonzeros=368</span>
<span class="go">                    total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                      using I-node routines: found 20 nodes, limit used is 5</span>
<span class="go">              A01</span>
<span class="go">                <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">                  type: seqaij</span>
<span class="go">                  rows=30, cols=9</span>
<span class="go">                  total: nonzeros=122, allocated nonzeros=122</span>
<span class="go">                  total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">                    using I-node routines: found 20 nodes, limit used is 5</span>
<span class="go">          <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (fieldsplit_pressure_) 1 MPI process</span>
<span class="go">            type: seqaij</span>
<span class="go">            rows=9, cols=9</span>
<span class="go">            total: nonzeros=41, allocated nonzeros=41</span>
<span class="go">            total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">              not using I-node routines</span>
</pre></div>
</div>
<p>Finally, the SNES viewer reports the system matrix and preconditioning matrix</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_view&quot;</span>
<span class="go">    linear system matrix followed by preconditioner matrix:</span>
<span class="go">    <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">      type: seqaij</span>
<span class="go">      rows=39, cols=39</span>
<span class="go">      total: nonzeros=653, allocated nonzeros=653</span>
<span class="go">      total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">        has attached null space</span>
<span class="go">        using I-node routines: found 24 nodes, limit used is 5</span>
<span class="go">    <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (prec_) 1 MPI process</span>
<span class="go">      type: seqaij</span>
<span class="go">      rows=39, cols=39</span>
<span class="go">      total: nonzeros=653, allocated nonzeros=653</span>
<span class="go">      total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">        using I-node routines: found 24 nodes, limit used is 5</span>
</pre></div>
</div>
<p>We see that they have the same nonzero pattern, even though the preconditioning matrix only contains the diagonal blocks. This is because zeros were inserted to define the nonzero structure. We can remove these nonzeros by telling the DM not to insert zero at preallocation time, and also telling the matrix itself to ignore the zeros from the assembly process.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_view -dm_preallocate_only -prec_mat_ignore_zero_entries&quot;</span>
<span class="go">    linear system matrix followed by preconditioner matrix:</span>
<span class="go">    <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: 1 MPI process</span>
<span class="go">      type: seqaij</span>
<span class="go">      rows=39, cols=39</span>
<span class="go">      total: nonzeros=653, allocated nonzeros=653</span>
<span class="go">      total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">        has attached null space</span>
<span class="go">        using I-node routines: found 24 nodes, limit used is 5</span>
<span class="go">    <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a> Object: (prec_) 1 MPI process</span>
<span class="go">      type: seqaij</span>
<span class="go">      rows=39, cols=39</span>
<span class="go">      total: nonzeros=409, allocated nonzeros=653</span>
<span class="go">      total number of mallocs used during <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatSetValues.html">MatSetValues</a> calls=0</span>
<span class="go">        using I-node routines: found 29 nodes, limit used is 5</span>
</pre></div>
</div>
<p>We can see a sparsity portrait of the system and preconditioning matrices if the installation supports X-windows visualization</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-ksp_view_mat draw -prec_mat_view draw -draw_pause -1&quot;</span>
<span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-ksp_view_mat draw -prec_mat_view draw -draw_save </span><span class="nv">$PETSC_DIR</span><span class="s2">/mat.png&quot;</span>
<span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_preallocate_only -mat_ignore_zero_entries -prec_mat_ignore_zero_entries -ksp_view_mat draw -prec_mat_view draw -draw_save </span><span class="nv">$PETSC_DIR</span><span class="s2">/mat_sparse.png&quot;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><figure class="align-default" id="id3771">
<img alt="../../_images/stokes_p2p1_sys_mat.png" src="../../_images/stokes_p2p1_sys_mat.png" />
<figcaption>
<p><span class="caption-text">System matrix</span><a class="headerlink" href="#id3771" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id3772">
<img alt="../../_images/stokes_p2p1_sys_mat_sparse.png" src="../../_images/stokes_p2p1_sys_mat_sparse.png" />
<figcaption>
<p><span class="caption-text">System matrix with sparse stencil</span><a class="headerlink" href="#id3772" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</td>
</tr>
<tr class="row-even"><td><figure class="align-default" id="id3773">
<img alt="../../_images/stokes_p2p1_prec_mat.png" src="../../_images/stokes_p2p1_prec_mat.png" />
<figcaption>
<p><span class="caption-text">Preconditioning matrix</span><a class="headerlink" href="#id3773" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id3774">
<img alt="../../_images/stokes_p2p1_prec_mat_sparse.png" src="../../_images/stokes_p2p1_prec_mat_sparse.png" />
<figcaption>
<p><span class="caption-text">Preconditioning matrix with sparse stencil</span><a class="headerlink" href="#id3774" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</td>
</tr>
</tbody>
</table>
<p>If we want to check the convergence of the solver, we can also do that using options. Both the linear and nonlinear solvers converge in a single iteration, which is exactly what we want. In order to have this happen, we must have the tolerance on both the outer KSP solver and the inner Schur complement solver be low enough. Notice that the sure complement solver is used twice, and converges in seven iterates each time.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason&quot;</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 1.170604545948e-01</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 7</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 4.965098891419e-01 true resid norm 1.170604545948e-01 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 7</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 9.236813926190e-11 true resid norm 1.460072673561e-12 ||r(i)||/||b|| 1.247280884579e-11</span>
<span class="go">Linear solve converged due to CONVERGED_ATOL iterations 1</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 1.460070661322e-12</span>
</pre></div>
</div>
<p>We can look at the scalability of the solve by refining the mesh. We see that the Schur complement solve looks robust to grid refinement.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine 2 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason&quot;</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 3.503062983054e-02</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 9.943095979973e-01 true resid norm 3.503062983054e-02 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 1.148772629230e-10 true resid norm 2.693482255004e-13 ||r(i)||/||b|| 7.688934706664e-12</span>
<span class="go">Linear solve converged due to CONVERGED_RTOL iterations 1</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 2.693649920420e-13</span>
<span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine 4 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason&quot;</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 8.969202737759e-03</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 6</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 3.322375727167e+00 true resid norm 8.969202737759e-03 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 6</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 6.112282404006e-10 true resid norm 8.543800889926e-14 ||r(i)||/||b|| 9.525708292843e-12</span>
<span class="go">Linear solve converged due to CONVERGED_RTOL iterations 1</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 8.543893996362e-14</span>
</pre></div>
</div>
<p>Starting off with an exact solver allows us to check that the discretization, equations, and boundary conditions are correct. Moreover, choosing the Schur complement formulation, rather than a sparse direct solve, gives us a path to incremental boost the scalability. Our first step will be to replace the direct solve of the momentum operator, which has cost superlinear in <span class="math">\(N\)</span>, with a more scalable alternative. Since the operator is still elliptic, despite the viscosity variation, we should be able to use some form of multigrid. We will start with algebraic multigrid because it handles coefficient variation well, even if the setup time is larger than the geometric variant.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine 2 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason -fieldsplit_velocity_pc_type gamg -fieldsplit_velocity_ksp_converged_reason&quot;</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 3.503062983054e-02</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 9.943097452179e-01 true resid norm 3.503062983054e-02 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 1.503326145261e-05 true resid norm 1.089276827085e-06 ||r(i)||/||b|| 3.109498265814e-05</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  2 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> preconditioned resid norm 1.353007845554e-10 true resid norm 6.056095141823e-11 ||r(i)||/||b|| 1.728799959098e-09</span>
<span class="go">Linear solve converged due to CONVERGED_RTOL iterations 2</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 6.056096909907e-11</span>
</pre></div>
</div>
<p>This looks alright, but the number of iterates grows with refinement. At 3 refinements, it is 16, 30 at 4 refinements, and 70 at 5 refinements. Increasing the number of smoother iterates to four, <code class="docutils literal notranslate"><span class="pre">-fieldsplit_velocity_mg_levels_ksp_max_it</span> <span class="pre">4</span></code>, brings down the number of iterates, but not the growth. Using w-cycles and full multigrid does not help either. It is likely that the coarse grids made by MIS are inaccurate for the <span class="math">\(P_2\)</span> discretization.</p>
<p>We can instead use geometric multigrid, and we would hope get more accurate coarse bases. The <code class="docutils literal notranslate"><span class="pre">-dm_refine_hierarchy</span></code> allows us to make a hierarchy of refined meshes and sets the number of multigrid levels automatically. Then all we need to specify is <code class="docutils literal notranslate"><span class="pre">-fieldsplit_velocity_pc_type</span> <span class="pre">mg</span></code>, as we see in the test</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nl">suffix</span><span class="p">:</span><span class="w"> </span><span class="n">p2p1_gmg</span>
<span class="w">    </span><span class="nl">requires</span><span class="p">:</span><span class="w"> </span><span class="n">triangle</span>
<span class="w">    </span><span class="nl">args</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="n">dm_plex_separate_marker</span><span class="w"> </span><span class="o">-</span><span class="n">dm_refine_hierarchy</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">vel_petscspace_degree</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="n">pres_petscspace_degree</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">snes_error_if_not_converged</span><span class="w"> </span><span class="o">-</span><span class="n">dmsnes_check</span><span class="w"> </span><span class="mf">.001</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">ksp_type</span><span class="w"> </span><span class="n">fgmres</span><span class="w"> </span><span class="o">-</span><span class="n">ksp_rtol</span><span class="w"> </span><span class="mf">1.</span><span class="n">e</span><span class="mi">-9</span><span class="w"> </span><span class="o">-</span><span class="n">ksp_error_if_not_converged</span><span class="w"> </span><span class="o">-</span><span class="n">pc_use_amat</span><span class="w"> </span>\
<span class="w">      </span><span class="o">-</span><span class="n">pc_type</span><span class="w"> </span><span class="n">fieldsplit</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_type</span><span class="w"> </span><span class="n">schur</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_factorization_type</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="o">-</span><span class="n">pc_fieldsplit_schur_precondition</span><span class="w"> </span><span class="n">a11</span><span class="w"> </span>\
<span class="w">        </span><span class="o">-</span><span class="n">fieldsplit_velocity_pc_type</span><span class="w"> </span><span class="n">mg</span><span class="w"> </span>\
<span class="w">        </span><span class="o">-</span><span class="n">fieldsplit_pressure_ksp_rtol</span><span class="w"> </span><span class="mf">1.</span><span class="n">e</span><span class="mi">-9</span><span class="w"> </span><span class="o">-</span><span class="n">fieldsplit_pressure_pc_type</span><span class="w"> </span><span class="n">lu</span>
</pre></div>
</div>
<p>This behaves well for the initial mesh,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1_gmg&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine_hierarchy 2 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason -fieldsplit_velocity_ksp_converged_reason&quot;</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 3.503062983054e-02</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 3.503062983054e-02 true resid norm 3.503062983054e-02 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 4.643855168829e-06 true resid norm 4.643855168807e-06 ||r(i)||/||b|| 1.325655630878e-04</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  2 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.520240889941e-11 true resid norm 1.520239396618e-11 ||r(i)||/||b|| 4.339743258890e-10</span>
<span class="go">Linear solve converged due to CONVERGED_ATOL iterations 2</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 1.520237877998e-11</span>
</pre></div>
</div>
<p>and is also stable under refinement</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1_gmg&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine_hierarchy 4 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason -fieldsplit_velocity_ksp_converged_reason&quot;</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 3.503062983054e-02</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 3.503062983054e-02 true resid norm 3.503062983054e-02 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 8</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 4.643855168829e-06 true resid norm 4.643855168807e-06 ||r(i)||/||b|| 1.325655630878e-04</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 4</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  Linear fieldsplit_velocity_ solve converged due to CONVERGED_RTOL iterations 5</span>
<span class="go">  2 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.520240889941e-11 true resid norm 1.520239396618e-11 ||r(i)||/||b|| 4.339743258890e-10</span>
<span class="go">Linear solve converged due to CONVERGED_ATOL iterations 2</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 1.520237877998e-11</span>
</pre></div>
</div>
<p>Finally, we can back off the pressure solve. <code class="docutils literal notranslate"><span class="pre">ILU(0)</span></code> is good enough to maintain a constant number of iterates as we refine the grid. We could continue to refine our preconditioner by playing with the tolerance of the inner multigrid and Schur complement solves, trading fewer inner iterates for more outer iterates.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1_gmg&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine_hierarchy 2 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason -fieldsplit_pressure_pc_type ilu&quot;</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 3.503062983054e-02</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 3.503062983054e-02 true resid norm 3.503062983054e-02 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 4.643855785779e-06 true resid norm 4.643855785812e-06 ||r(i)||/||b|| 1.325655807011e-04</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  2 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.521944777036e-11 true resid norm 1.521942998859e-11 ||r(i)||/||b|| 4.344606437913e-10</span>
<span class="go">Linear solve converged due to CONVERGED_ATOL iterations 2</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 1.521943449163e-11</span>
<span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1_gmg&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine_hierarchy 4 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason -fieldsplit_pressure_pc_type ilu&quot;</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 8.969202737759e-03</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 8.969202737759e-03 true resid norm 8.969202737759e-03 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 2.234849111673e-05 true resid norm 2.234849111674e-05 ||r(i)||/||b|| 2.491692045566e-03</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  2 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.205594722917e-10 true resid norm 1.205594316079e-10 ||r(i)||/||b|| 1.344148807121e-08</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  3 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.461086575333e-15 true resid norm 2.284323415523e-15 ||r(i)||/||b|| 2.546852247977e-13</span>
<span class="go">Linear solve converged due to CONVERGED_ATOL iterations 3</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 2.317901194143e-15</span>
<span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1_gmg&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine_hierarchy 6 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason -fieldsplit_pressure_pc_type ilu&quot;</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 2.252260693635e-03</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 2.252260693635e-03 true resid norm 2.252260693635e-03 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 9</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.220195757583e-05 true resid norm 1.220195757579e-05 ||r(i)||/||b|| 5.417648858445e-03</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  2 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 2.683367607036e-09 true resid norm 2.683367591382e-09 ||r(i)||/||b|| 1.191410745197e-06</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 10</span>
<span class="go">  3 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 5.510932827474e-13 true resid norm 5.511665167379e-13 ||r(i)||/||b|| 2.447170162386e-10</span>
<span class="go">Linear solve converged due to CONVERGED_ATOL iterations 3</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 5.511916500930e-13</span>
</pre></div>
</div>
<p>We can make the problem harder by increasing the wave number and size of the viscosity perturbation. If we set the <span class="math">\(B\)</span> parameter to 6.9, we have a factor of one million increase in viscosity across the cell. At this scale, we see that we lose enough accuracy in our Jacobian calculation to defeat our Taylor test, but we are still able to solve the problem efficiently.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1_gmg&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine_hierarchy 2 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason -fieldsplit_pressure_pc_type ilu -m 2 -n 2 -B 6.9&quot;</span>
<span class="go">L_2 Error: [4.07817e-06, 0.0104694]</span>
<span class="go">L_2 Residual: 0.0145403</span>
<span class="go">Taylor approximation converging at order 1.00</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 3.421266970274e-02</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 3.421266970274e-02 true resid norm 3.421266970274e-02 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 21</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 2.066264276201e-05 true resid norm 2.066264276201e-05 ||r(i)||/||b|| 6.039471032675e-04</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 20</span>
<span class="go">  2 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.295461366009e-10 true resid norm 1.295461419342e-10 ||r(i)||/||b|| 3.786496144842e-09</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 20</span>
<span class="go">  3 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.954355290546e-15 true resid norm 1.954135246291e-15 ||r(i)||/||b|| 5.711729786858e-14</span>
<span class="go">Linear solve converged due to CONVERGED_ATOL iterations 3</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 1.946196473520e-15</span>
<span class="gp">$ </span>make<span class="w"> </span>-f<span class="w"> </span>./gmakefile<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">globsearch</span><span class="o">=</span><span class="s2">&quot;snes_tutorials-ex69_p2p1_gmg&quot;</span><span class="w"> </span><span class="nv">EXTRA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-dm_refine_hierarchy 6 -snes_monitor -ksp_monitor_true_residual -ksp_converged_reason -fieldsplit_pressure_ksp_converged_reason -fieldsplit_pressure_pc_type ilu -m 2 -n 2 -B 6.9&quot;</span>
<span class="go">L_2 Error: [1.52905e-09, 4.72606e-05]</span>
<span class="go">L_2 Residual: 7.18836e-06</span>
<span class="go">Taylor approximation converging at order 1.00</span>
<span class="go">0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 2.252034794902e-03</span>
<span class="go">  0 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 2.252034794902e-03 true resid norm 2.252034794902e-03 ||r(i)||/||b|| 1.000000000000e+00</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 19</span>
<span class="go">  1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.843225742581e-05 true resid norm 1.843225742582e-05 ||r(i)||/||b|| 8.184712539768e-03</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 19</span>
<span class="go">  2 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.410472862037e-09 true resid norm 1.410472860342e-09 ||r(i)||/||b|| 6.263104209294e-07</span>
<span class="go">  Linear fieldsplit_pressure_ solve converged due to CONVERGED_RTOL iterations 19</span>
<span class="go">  3 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a> unpreconditioned resid norm 1.051996270409e-14 true resid norm 1.064465321443e-14 ||r(i)||/||b|| 4.726682393419e-12</span>
<span class="go">Linear solve converged due to CONVERGED_ATOL iterations 3</span>
<span class="go">1 <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a> Function norm 1.063917948054e-14</span>
</pre></div>
</div>
</section>
</section>
<section id="bibliography">
<h2>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this heading">#</a></h2>
<div class="docutils container" id="id2">
<dl class="citation">
<dt class="label" id="id826"><span class="brackets"><a class="fn-backref" href="#id1">KnepleyBrownRuppSmith13</a></span></dt>
<dd><p>M.G. Knepley, J.Brown, K.Rupp, and B.F. Smith. Achieving high performance with unified residual evaluation. <em>ArXiv e-prints</em>, September 2013. <a class="reference external" href="https://arxiv.org/abs/1309.1204">arXiv:1309.1204</a>.</p>
</dd>
</dl>
</div>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#equation-definition">
   Equation Definition
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mms-solutions">
   MMS Solutions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dealing-with-parameters">
   Dealing with Parameters
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#investigating-convergence">
   Investigating convergence
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#debugging">
     Debugging
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optimizing-the-solver">
     Optimizing the Solver
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bibliography">
   Bibliography
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  

<div class="tocsection editthispage">
    <a href="https://gitlab.com/petsc/petsc/edit/release/doc/tutorials/physics/guide_to_stokes.rst">
        <i class="fa-solid fa-pencil"></i> Edit this page
    </a>
</div>

</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../../_sources/tutorials/physics/guide_to_stokes.rst.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 1991-2023, UChicago Argonne, LLC and the PETSc Development Team.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
  <div class="footer-item">
    <p class="last-updated">
Last updated on 2023-04-30T09:17:39-0500 (v3.19.1).<br>
</p>
  </div>
  
</div>
  </footer>
  </body>
</html>