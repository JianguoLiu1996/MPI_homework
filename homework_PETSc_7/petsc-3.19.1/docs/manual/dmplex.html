
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>DMPlex: Unstructured Grids &#8212; PETSc 3.19.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/katex-math.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <script src="../_static/katex.min.js"></script>
    <script src="../_static/auto-render.min.js"></script>
    <script src="../_static/katex_autorenderer.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'manual/dmplex';</script>
    <link rel="shortcut icon" href="../_static/petsc_favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="DMSTAG: Staggered, Structured Grid" href="dmstag.html" />
    <link rel="prev" title="DM Basics" href="dmbase.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../index.html">

  
  
  
  
  
  
  

  
    <img src="../_static/PETSc-TAO_RGB.svg" class="logo__image only-light" alt="Logo image">
    <img src="../_static/PETSc-TAO_RGB_white.svg" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../overview/index.html">
                        Overview
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../install/index.html">
                        Install
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials/index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="index.html">
                        User-Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../manualpages/index.html">
                        C/Fortran API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../petsc4py/petsc4py.html">
                        Python API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../faq/index.html">
                        FAQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../community/index.html">
                        Community
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../developers/index.html">
                        Developers
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../miscellaneous/index.html">
                        Misc.
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://gitlab.com/petsc/petsc" title="GitLab" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fab fa-gitlab"></i></span>
            <label class="sr-only">GitLab</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../overview/index.html">
                        Overview
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../install/index.html">
                        Install
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials/index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="index.html">
                        User-Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../manualpages/index.html">
                        C/Fortran API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../petsc4py/petsc4py.html">
                        Python API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../faq/index.html">
                        FAQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../community/index.html">
                        Community
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../developers/index.html">
                        Developers
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../miscellaneous/index.html">
                        Misc.
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://gitlab.com/petsc/petsc" title="GitLab" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fab fa-gitlab"></i></span>
            <label class="sr-only">GitLab</label></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Section navigation">
  <p class="bd-links__title" role="heading" aria-level="1">
    Section Navigation
  </p>
  <div class="bd-toc-item navbar-nav">
    <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../overview/nutshell.html">PETSc in a nutshell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/features.html">Supported Systems</a></li>

<li class="toctree-l1"><a class="reference internal" href="../overview/gpu_roadmap.html">GPU Support Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/vector_table.html">Summary of Vector Types Available In PETSc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/matrix_table.html">Summary of Matrix Types Available In PETSc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/linear_solve_table.html">Summary of Sparse Linear Solvers Available In PETSc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/nonlinear_solve_table.html">Summary of Nonlinear Solvers Available In PETSc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/integrator_table.html">Summary of Time Integrators Available In PETSc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/tao_solve_table.html">Summary of Tao Solvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/discrete_table.html">Summary of Discretization Management Systems</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">User-Guide</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="introduction.html">Introduction to PETSc</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="about_this_manual.html">About This Manual</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html">Getting Started</a></li>






</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="programming.html">The Solvers in PETSc/TAO</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="vec.html">Vectors and Parallel Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="mat.html">Matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="ksp.html">KSP: Linear System Solvers</a></li>
<li class="toctree-l3"><a class="reference internal" href="snes.html">SNES: Nonlinear Solvers</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts.html">TS: Scalable ODE and DAE Solvers</a></li>

<li class="toctree-l3"><a class="reference internal" href="tao.html">TAO: Optimization Solvers</a></li>
</ul>
</li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="dm.html">DM: Interfacing Between Solvers and Models/Discretizations</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="dmbase.html">DM Basics</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">DMPlex: Unstructured Grids</a></li>
<li class="toctree-l3"><a class="reference internal" href="dmstag.html">DMSTAG: Staggered, Structured Grid</a></li>
<li class="toctree-l3"><a class="reference internal" href="dmnetwork.html">Networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="dt.html">PetscDT: Discretization Technology in PETSc</a></li>
<li class="toctree-l3"><a class="reference internal" href="fe.html">PetscFE: Finite Element Infrastructure in PETSc</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="additional.html">Additional Information</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="fortran.html">PETSc for Fortran Users</a></li>
<li class="toctree-l3"><a class="reference internal" href="matlab.html">Using MATLAB with PETSc</a></li>
<li class="toctree-l3"><a class="reference internal" href="profiling.html">Profiling</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance.html">Hints for Performance Tuning</a></li>
<li class="toctree-l3"><a class="reference internal" href="blas-lapack.html">The Use of BLAS and LAPACK in PETSc and external libraries</a></li>
<li class="toctree-l3"><a class="reference internal" href="other.html">Other PETSc Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="advanced.html">Advanced Features of Matrices and Solvers</a></li>
<li class="toctree-l3"><a class="reference internal" href="tests.html">Running PETSc Tests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../manualpages/index.html">C/Fortran API</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/Vector.html">Vectors and Index Sets</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/Vec/index.html">Vector Operations (Vec)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/IS/index.html">Index sets (IS)</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/Matrix.html">Matrices and Matrix Operations</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/Mat/index.html">Matrix Operations (Mat)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/MatOrderings/index.html">Matrix colorings (MatColoring), orderings (MatOrdering), partitionings (MatPartitioning), and coarsening (MatCoarsen)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/MatFD/index.html">Finite difference computation of Jacobians (MatFD)</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/DataLayout.html">Data Layout and Communication</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/PetscSF/index.html">Star Forest Communication (PetscSF)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/PetscSection/index.html">Section Data Layout (PetscSection)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/AO/index.html">Application Orderings (AO)</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/DataManagement.html">Data Management between Vec and Mat, and Distributed Mesh Data Structures</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DM/index.html">Data Management (DM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMDA/index.html">Structured Grids (DMDA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMStag/index.html">Staggered, Structured Grids (DMSTAG)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMPlex/index.html">Unstructured Grids and Cell Complexes (DMPLEX)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMNetwork/index.html">Graphs and Networks (DMNETWORK)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMForest/index.html">A Forest of Trees and Structured Adaptive Refinement (DMFOREST)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMPatch/index.html">Sequences of parallel mesh patches (DMPATCH)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMSwarm/index.html">Particle Discretizations (DMSWARM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMMOAB/index.html">MOAB Mesh Representation (DMMOAB)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMLabel/index.html">Selecting Parts of Meshes (DMLabel)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DMPRODUCT/index.html">Tensor products of meshes (DMRODUCT)</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/Discretization.html">Discretization and Function Spaces</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DT/index.html">Discretization Technology and Quadrature (DT)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/SPACE/index.html">Function Spaces (PetscSpace)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/DUALSPACE/index.html">Dual Spaces (PetscDualSpace)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/FE/index.html">Finite Elements (PetscFE)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/FV/index.html">Finite Volumes (PetscFV)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/PF/index.html">Defining your own mathematical functions (PF)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/LANDAU/index.html">Landau Collision Operator</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/LinearSolvers.html">Linear Solvers and Preconditioners</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/KSP/index.html">Linear Solvers and Krylov Methods (KSP)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/PC/index.html">Preconditioners (PC)</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/NonlinearSolvers.html">Nonlinear Solvers</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/SNES/index.html">Nonlinear Solvers (SNES)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/SNESFAS/index.html">Full Approximation Scheme (FAS) nonlinear multigrid</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/Timestepping.html">Forward and Adjoint Timestepping</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/TS/index.html">Time Stepping ODE and DAE Solvers (TS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/Sensitivity/index.html">Sensitivity Analysis for ODE and DAE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/Characteristic/index.html">Semi-Lagrangian Solves using the Method of Characteristics</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/Optimization.html">Optimization</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/Tao/index.html">Optimization Solvers (Tao)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/TaoLineSearch/index.html">Optimization Line Search (TaoLineSearch)</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/Visualization.html">Graphics and Visualization</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/Draw/index.html">Graphics (Draw)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/Viewer/index.html">Viewing Objects (Viewer)</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../manualpages/System.html">System Routines, Profiling, Data Structures</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/Sys/index.html">PETSc Options, IO, and System Utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/PetscH/index.html">Hash Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../manualpages/Profiling/index.html">Profiling and Logging</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../changes/index.html">Changes for each release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../manualpages/singleindex.html">Single Index of all PETSc Manual Pages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../changes/index.html">Changes for each release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manualpages/singleindex.html">Single Index of all PETSc Manual Pages</a></li>
</ul>

  </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="dmplex-unstructured-grids">
<span id="chapter-unstructured"></span><h1>DMPlex: Unstructured Grids<a class="headerlink" href="#dmplex-unstructured-grids" title="Permalink to this heading">#</a></h1>
<p>This chapter introduces the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> subclass of <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code>, which allows
the user to handle unstructured grids using the generic <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code> interface
for hierarchy and multi-physics. <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> was created to remedy a huge
problem in all current PDE simulation codes, namely that the
discretization was so closely tied to the data layout and solver that
switching discretizations in the same code was not possible. Not only
does this preclude the kind of comparison that is necessary for
scientific investigation, but it makes library (as opposed to monolithic
application) development impossible.</p>
<section id="representing-unstructured-grids">
<h2>Representing Unstructured Grids<a class="headerlink" href="#representing-unstructured-grids" title="Permalink to this heading">#</a></h2>
<p>The main advantage of <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> in representing topology is that it
treats all the different pieces of a mesh, e.g. cells, faces, edges, and
vertices, in the same way. This allows the interface to be
small and simple, while remaining flexible and general. This also allows
“dimension independent programming”, which means that the same algorithm
can be used unchanged for meshes of different shapes and dimensions.</p>
<p>All pieces of the mesh (vertices, edges, faces, and cells) are treated as <em>points</em>, which are each identified by a
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span></code>. A mesh is built by relating points to other points, in
particular specifying a “covering” relation among the points. For
example, an edge is defined by being covered by two vertices, and a
triangle can be defined by being covered by three edges (or even by
three vertices). This structure is known as a <a class="reference external" href="http://en.wikipedia.org/wiki/Hasse_diagram">Hasse Diagram</a>, which is a
Directed Acyclic Graph (DAG) representing a cell complex using the
covering relation. The graph edges represent the relation, which also
encodes a partially ordered set (poset).</p>
<p>For example, we can encode the doublet mesh as in <a class="reference internal" href="#fig-doubletmesh"><span class="std std-numref">Fig. 8</span></a>,</p>
<figure class="align-default" id="fig-doubletmesh">
<img alt="../_images/dmplex_doublet_mesh.svg" src="../_images/dmplex_doublet_mesh.svg" /><figcaption>
<p><span class="caption-number">Fig. 8 </span><span class="caption-text">A 2D doublet mesh, two triangles sharing an edge.</span><a class="headerlink" href="#fig-doubletmesh" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>which can also be represented as the DAG in
<a class="reference internal" href="#fig-doubletdag"><span class="std std-numref">Fig. 9</span></a>.</p>
<figure class="align-default" id="fig-doubletdag">
<img alt="../_images/dmplex_doublet_dag.svg" src="../_images/dmplex_doublet_dag.svg" /><figcaption>
<p><span class="caption-number">Fig. 9 </span><span class="caption-text">The Hasse diagram for our 2D doublet mesh, expressed as a DAG.</span><a class="headerlink" href="#fig-doubletdag" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>To use the PETSc API, we consecutively number the mesh pieces. The
PETSc convention in 3 dimensions is to number first cells, then
vertices, then faces, and then edges. In 2 dimensions the convention is
to number faces, vertices, and then edges.
In terms of the labels in
<a class="reference internal" href="#fig-doubletmesh"><span class="std std-numref">Fig. 8</span></a>, these numberings are</p>
<div class="math">
\[f_0 \mapsto \mathtt{0}, f_1 \mapsto \mathtt{1}, \quad v_0 \mapsto \mathtt{2}, v_1 \mapsto \mathtt{3}, v_2 \mapsto \mathtt{4}, v_3 \mapsto \mathtt{5}, \quad e_0 \mapsto \mathtt{6}, e_1 \mapsto \mathtt{7}, e_2 \mapsto \mathtt{8}, e_3 \mapsto \mathtt{9}, e_4 \mapsto \mathtt{10}

\]</div>
<p>First, we declare the set of points present in a mesh,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetChart.html">DMPlexSetChart</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that a <em>chart</em> here corresponds to a semi-closed interval (e.g
<span class="math">\([0,11) = \{0,1,\ldots,10\}\)</span>) specifying the range of indices we’d
like to use to define points on the current rank. We then define the
covering relation, which we call the <em>cone</em>, which are also the in-edges
in the DAG. In order to preallocate correctly, we first provide sizes,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetConeSize.html">DMPlexSetConeSize</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">cover</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">point</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetConeSize.html">DMPlexSetConeSize</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetConeSize.html">DMPlexSetConeSize</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetConeSize.html">DMPlexSetConeSize</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetConeSize.html">DMPlexSetConeSize</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetConeSize.html">DMPlexSetConeSize</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetConeSize.html">DMPlexSetConeSize</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetConeSize.html">DMPlexSetConeSize</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetUp.html">DMSetUp</a></span><span class="p">(</span><span class="n">dm</span><span class="p">);</span>
</pre></div>
</div>
<p>and then point values (recall each point is an integer that represents a single geometric entity, a cell, face, edge, or vertex),</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetCone.html">DMPlexSetCone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">points</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">cover</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">point</span><span class="p">]);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetCone.html">DMPlexSetCone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">]);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetCone.html">DMPlexSetCone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetCone.html">DMPlexSetCone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetCone.html">DMPlexSetCone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">]);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetCone.html">DMPlexSetCone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetCone.html">DMPlexSetCone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetCone.html">DMPlexSetCone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<p>There is also an API for providing the dual relation, using
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetSupportSize.html">DMPlexSetSupportSize</a>()</span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetSupport.html">DMPlexSetSupport</a>()</span></code>, but this can be
calculated automatically using the provided <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetConeSize.html">DMPlexSetConeSize</a>()</span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetCone.html">DMPlexSetCone</a>()</span></code> information and then calling</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSymmetrize.html">DMPlexSymmetrize</a></span><span class="p">(</span><span class="n">dm</span><span class="p">);</span>
</pre></div>
</div>
<p>The “symmetrization” is in the sense of the DAG. Each point knows its covering (cone) and each point knows what it covers (support). Note that when using automatic symmetrization, cones will be ordered but supports will not. The user can enforce an ordering on supports by rewriting them after symmetrization using <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSetSupport.html">DMPlexSetSupport</a>()</span></code>.</p>
<p>In order to support efficient queries, we construct fast
search structures and indices for the different types of points using</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexStratify.html">DMPlexStratify</a></span><span class="p">(</span><span class="n">dm</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="dealing-with-periodicity">
<h2>Dealing with Periodicity<a class="headerlink" href="#dealing-with-periodicity" title="Permalink to this heading">#</a></h2>
<p>Plex allows you to represent periodic domains is two ways. Using the default scheme, periodic topology can be represented directly. This ensures that all topological queries can be satisified, but then care must be taken in representing functions over the mesh, such as the coordinates. The second method is to use a non-periodic topology, but connect certain mesh points using the local-to-global map for that DM. This allows a more general set of mappings to be implemented, such as partial twists, but topological queries on the periodic boundary cease to function.</p>
<p>For the default scheme, a call to <cite>DMLocalizeCoordinates()</cite> (which usually happens automatically on mesh creation) creates a second, discontinuous coordinate field. These values can be accessed using <cite>DMGetCellCoordinates()</cite> and <cite>DMGetCellCoordinatesLocal()</cite>. Plex provides a convenience method, <cite>DMPlexGetCellCoordinates()</cite>, that extracts cell coordinates correctly, depending on the periodicity of the mesh. An example of its use is shown below:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="p">;</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w">       </span><span class="o">*</span><span class="n">coords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">           </span><span class="n">numCoords</span><span class="p">;</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w">          </span><span class="n">isDG</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetCellCoordinates.html">DMPlexGetCellCoordinates</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">isDG</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numCoords</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">coords</span><span class="p">));</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numCoords</span><span class="o">/</span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">cc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscPrintf.html">PetscPrintf</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot; -- &quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscPrintf.html">PetscPrintf</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dim</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscPrintf.html">PetscPrintf</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscPrintf.html">PetscPrintf</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%g&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscRealPart.html">PetscRealPart</a></span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">cc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">])));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscPrintf.html">PetscPrintf</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">));</span>
<span class="p">}</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscPrintf.html">PetscPrintf</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscCall.html">PetscCall</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexRestoreCellCoordinates.html">DMPlexRestoreCellCoordinates</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">isDG</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numCoords</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">coords</span><span class="p">));</span>
</pre></div>
</div>
</section>
<section id="connecting-data-on-grids-to-its-location-in-arrays-or-vec-petscsection">
<span id="sec-petscsection"></span><h2>Connecting Data on Grids to its Location in arrays or Vec (PetscSection)<a class="headerlink" href="#connecting-data-on-grids-to-its-location-in-arrays-or-vec-petscsection" title="Permalink to this heading">#</a></h2>
<p>The strongest links between solvers and discretizations are</p>
<ul class="simple">
<li><p>the relationship between the layout of data (unknowns) over a mesh (or similar structure) and the data layout in arrays and <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span></code> used for computation,</p></li>
<li><p>data (unknowns) partitioning, and</p></li>
<li><p>ordering of data (unknowns).</p></li>
</ul>
<p>To enable modularity, we encode the operations above in simple data
structures that can be understood by the linear algebra (<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/Mat.html">Mat</a></span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/KSP/KSP.html">KSP</a></span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PC/PC.html">PC</a></span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/SNES/SNES.html">SNES</a></span></code>), time integrator (<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/TS/TS.html">TS</a></span></code>), and optimization (<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Tao/Tao.html">Tao</a></span></code>) engines in PETSc
without explicit reference to the mesh (topology) or discretization (analysis).</p>
<section id="data-layout-by-hand">
<h3>Data Layout by Hand<a class="headerlink" href="#data-layout-by-hand" title="Permalink to this heading">#</a></h3>
<p>Specific entries (or collections of entries) in a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span></code> (or a simple array) can be associated with a “location” on a mesh (or other types of data structure) using the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> object.
A <strong>point</strong> is a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span></code> that serves as an abstract “index” into arrays from iteratable sets, such as points on a mesh.</p>
<p><code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> has two modes of operation.</p>
<p>Mode 1:</p>
<p>A <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> associates a set of degrees of freedom (dof), (a small space
<span class="math">\(\{e_k\} 0 &lt; k &lt; d_p\)</span>), with every point. The number of dof and their meaning may be different for different points. For example, the dof on a cell point may represent pressure
while a dof on a face point may represent velocity. Though points must be
contiguously numbered, they can be in any range
<span class="math">\([\mathrm{pStart}, \mathrm{pEnd})\)</span>, which is called a <strong>chart</strong>. A <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> in mode 1 may be thought of as defining a two dimensional array indexed by point in the outer dimension with
a variable length inner dimension indexed by the dof at that point, <span class="math">\(v[pStart &lt;= point &lt; pEnd][0 &lt;= dof &lt;d_p]\)</span> <a class="footnote-reference brackets" href="#petscsection-footnote" id="id1">1</a>.</p>
<p>The sequence for constructing a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> in mode 1 is the following:</p>
<ol class="arabic simple">
<li><p>Specify the range of points, or chart, with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetChart.html">PetscSectionSetChart</a>()</span></code>.</p></li>
<li><p>Specify the number of dofs per point, with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetDof.html">PetscSectionSetDof</a>()</span></code>. Any values not set will be zero.</p></li>
<li><p>Set up the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetUp.html">PetscSectionSetUp</a>()</span></code>.</p></li>
</ol>
<p>Below we demonstrate such a process used by <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> but first we introduce the second mode for working with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code>.</p>
<p>Mode 2:</p>
<p>A <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> consists of one more <strong>fields</strong> each of which is represented (internally) by a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code>.
A <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> in mode 2 may be thought of as defining a three dimensional array indexed by point and field in the outer dimensions with
a variable length inner dimension indexed by the dof at that point. The actual order the values in the array are stored can be set with
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetPointMajor.html">PetscSectionSetPointMajor</a></span></code>(<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_FALSE</a></span></code>). In <strong>point major</strong> order all the degrees of freedom for each point for all fields are stored contiguously, otherwise
all degrees of freedom for each field are stored  are stored contiguously. With point major order the fields are said to be <strong>interlaced</strong>.</p>
<p>Consider a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> with 2 fields and 3 points (from 0 to 2) with 1 dof for each point. In point major order the array has the storage
(values for all the fields at point 0, values for all the fields at point 1, values for all the fields at point 2) while in field major order it is
(values for all points in field 0, values for all points in field 1).</p>
<p>The sequence for constructing such a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> is the following:</p>
<ol class="arabic simple">
<li><p>Specify the range of points, or chart, with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetChart.html">PetscSectionSetChart</a>()</span></code>. All fields share the same chart.</p></li>
<li><p>Specify the number of fields with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetNumFields.html">PetscSectionSetNumFields</a>()</span></code>.</p></li>
<li><p>Optionally provide a name for the fields with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetFieldName.html">PetscSectionSetFieldName</a>()</span></code>.</p></li>
<li><p>Set the number of dof for each point on each field with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetFieldDof.html">PetscSectionSetFieldDof</a>()</span></code>. Again, values not set will be zero.</p></li>
<li><p>Set the <strong>total</strong> number of dof for each point with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetDof.html">PetscSectionSetDof</a>()</span></code>. Thus value must be greater than or equal to the sum of the values set with
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetFieldDof.html">PetscSectionSetFieldDof</a>()</span></code> at that point. Again, values not set will be zero.</p></li>
<li><p>Set up the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetUp.html">PetscSectionSetUp</a>()</span></code>.</p></li>
</ol>
<p>Once a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> has been created one can use <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetStorageSize.html">PetscSectionGetStorageSize</a></span></code>(<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span></code> <code class="docutils literal notranslate"><span class="pre">*</span></code>) to determine the total number of entries that can be stored in an array or <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span></code>
accessible by the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code>. The memory locations in the associated array are found using an <strong>offset</strong> which can be obtained with:</p>
<p>Mode 1:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetOffset.html">PetscSectionGetOffset</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
</pre></div>
</div>
<p>Mode 2:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetFieldOffset.html">PetscSectionGetFieldOffset</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
</pre></div>
</div>
<p>The value in the array is then accessed with <code class="docutils literal notranslate"><span class="pre">array[offset]</span></code>. If there are multiple dof at a point (and field in mode 2) then <code class="docutils literal notranslate"><span class="pre">array[offset</span> <span class="pre">+</span> <span class="pre">1]</span></code>, etc give access to each of those dof.</p>
<p>Using the mesh from
<a class="reference internal" href="#fig-doubletmesh"><span class="std std-numref">Fig. 8</span></a>, we provide an example of creating a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> using mode 1. We can lay out data for
a continuous Galerkin <span class="math">\(P_3\)</span> finite element method,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">pStart</span><span class="p">,</span><span class="w"> </span><span class="n">pEnd</span><span class="p">,</span><span class="w"> </span><span class="n">cStart</span><span class="p">,</span><span class="w"> </span><span class="n">cEnd</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">vStart</span><span class="p">,</span><span class="w"> </span><span class="n">vEnd</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">eStart</span><span class="p">,</span><span class="w"> </span><span class="n">eEnd</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetChart.html">DMPlexGetChart</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pStart</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pEnd</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetHeightStratum.html">DMPlexGetHeightStratum</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cStart</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cEnd</span><span class="p">);</span><span class="w">   </span><span class="c1">// cells</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetHeightStratum.html">DMPlexGetHeightStratum</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">eStart</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">eEnd</span><span class="p">);</span><span class="w">   </span><span class="c1">// edges</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetHeightStratum.html">DMPlexGetHeightStratum</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vStart</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vEnd</span><span class="p">);</span><span class="w">   </span><span class="c1">// vertices, equivalent to <a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetDepthStratum.html">DMPlexGetDepthStratum</a>(dm, 0, &amp;vStart, &amp;vEnd);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetChart.html">PetscSectionSetChart</a></span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">pStart</span><span class="p">,</span><span class="w"> </span><span class="n">pEnd</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cStart</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cEnd</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetDof.html">PetscSectionSetDof</a></span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vStart</span><span class="p">;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vEnd</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">v</span><span class="p">)</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetDof.html">PetscSectionSetDof</a></span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eStart</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">eEnd</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetDof.html">PetscSectionSetDof</a></span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// two dof on each edge</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetUp.html">PetscSectionSetUp</a></span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetHeightStratum.html">DMPlexGetHeightStratum</a>()</span></code> returns all the points of the requested height
in the DAG. Since this problem is in two dimensions the edges are at
height 1 and the vertices at height 2 (the cells are always at height
0). One can also use <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetDepthStratum.html">DMPlexGetDepthStratum</a>()</span></code> to use the depth in the
DAG to select the points. <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetDepth.html">DMPlexGetDepth</a>(dm,&amp;depth)</span></code> returns the depth
of the DAG, hence <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetDepthStratum.html">DMPlexGetDepthStratum</a>(dm,depth-1-h,)</span></code> returns the
same values as <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetHeightStratum.html">DMPlexGetHeightStratum</a>(dm,h,)</span></code>.</p>
<p>For <span class="math">\(P_3\)</span> elements there is one degree of freedom at each vertex, 2 along
each edge (resulting in a total of 4 degrees of freedom along each edge
including the vertices, thus being able to reproduce a cubic function)
and 1 degree of freedom within the cell (the bubble function which is
zero along all edges).</p>
<p>Now a PETSc local vector can be created manually using this layout,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetStorageSize.html">PetscSectionGetStorageSize</a></span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecSetSizes.html">VecSetSizes</a></span><span class="p">(</span><span class="n">localVec</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_DETERMINE.html">PETSC_DETERMINE</a></span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecSetFromOptions.html">VecSetFromOptions</a></span><span class="p">(</span><span class="n">localVec</span><span class="p">);</span>
</pre></div>
</div>
<p>When working with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFE.html">PetscFE</a></span></code> (see below) one can simply get the sections (and related vectors) with</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetLocalSection.html">DMSetLocalSection</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetLocalVector.html">DMGetLocalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">localVec</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetGlobalVector.html">DMGetGlobalVector</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">globalVec</span><span class="p">);</span>
</pre></div>
</div>
<p>A global vector is missing both the shared dofs which are not owned by this process, as well as <em>constrained</em> dofs. These constraints represent essential (Dirichlet)
boundary conditions. They are dofs that have a given fixed value, so they are present in local vectors for assembly purposes, but absent
from global vectors since they are never solved for during algebraic solves.</p>
<p>We can indicate constraints in a local section using <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetConstraintDof.html">PetscSectionSetConstraintDof</a>()</span></code>, to set the number of constrained dofs for a given point, and <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionSetConstraintIndices.html">PetscSectionSetConstraintIndices</a>()</span></code> which indicates which dofs on the given point are constrained. Once we have this information, a global section can be created using <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionCreateGlobalSection.html">PetscSectionCreateGlobalSection</a>()</span></code>, and this is done automatically by the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code>. A global section returns <span class="math">\(-(dof+1)\)</span> for the number of dofs on an unowned point, and <span class="math">\(-(off+1)\)</span> for its offset on the owning process. This can be used to create global vectors, just as the local section is used to create local vectors.</p>
</section>
<section id="data-layout-using-dmplex-and-petscfe">
<h3>Data Layout using DMPLEX and PetscFE<a class="headerlink" href="#data-layout-using-dmplex-and-petscfe" title="Permalink to this heading">#</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code> can automatically create the local section if given a description of the discretization, for example using a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFE.html">PetscFE</a></span></code> object. We demonstrate this by creating
a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFE.html">PetscFE</a></span></code> that can be configured from the command line. It is a single, scalar field, and is added to the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code> using <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetField.html">DMSetField</a>()</span></code>.
When a local or global vector is requested, the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code> builds the local and global sections automatically.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexIsSimplex.html">DMPlexIsSimplex</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simplex</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFECreateDefault.html">PetscFECreateDefault</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="w"> </span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">simplex</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fe</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetField.html">DMSetField</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="w"> </span><span class="n">fe</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateDS.html">DMCreateDS</a></span><span class="p">(</span><span class="n">dm</span><span class="p">);</span>
</pre></div>
</div>
<p>Here the call to <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetField.html">DMSetField</a>()</span></code> declares the discretization will have one field with the integer label 0 that has one degree of freedom at each point on the <code class="docutils literal notranslate"><span class="pre">DMPlex</span></code>.
To get the <span class="math">\(P_3\)</span> section above, we can either give the option <code class="docutils literal notranslate"><span class="pre">-petscspace_degree</span> <span class="pre">3</span></code>, or call <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/FE/PetscFECreateLagrange.html">PetscFECreateLagrange</a>()</span></code> and set the degree directly.</p>
</section>
<section id="partitioning-and-ordering">
<h3>Partitioning and Ordering<a class="headerlink" href="#partitioning-and-ordering" title="Permalink to this heading">#</a></h3>
<p>In the same way as <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Mat/MatPartitioning.html">MatPartitioning</a></span></code> or
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/MatOrderings/MatGetOrdering.html">MatGetOrdering</a>()</span></code>, give the results of a partitioning or ordering of a graph defined by a sparse matrix,
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/PetscPartitionerDMPlexPartition.html">PetscPartitionerDMPlexPartition</a></span></code> or <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexPermute.html">DMPlexPermute</a></span></code> are encoded in
an <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/IS/IS.html">IS</a></span></code>. However, the graph is not the adjacency graph of the matrix
but the mesh itself. Once the mesh is partitioned and
reordered, the data layout from a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> can be used to
automatically derive a problem partitioning/ordering.</p>
</section>
<section id="influence-of-variables-on-one-another">
<h3>Influence of Variables on One Another<a class="headerlink" href="#influence-of-variables-on-one-another" title="Permalink to this heading">#</a></h3>
<p>The Jacobian of a problem represents the influence of some
variable on other variables in the problem. Very often, this influence
pattern is determined jointly by the computational mesh and
discretization. <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreateMatrix.html">DMCreateMatrix</a>()</span></code> must compute this pattern when it
automatically creates the properly preallocated Jacobian matrix. In
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMDA/DMDA.html">DMDA</a></span></code> the influence pattern, or what we will call variable
<em>adjacency</em>, depends only on the stencil since the topology is Cartesian
and the discretization is implicitly finite difference.</p>
<p>In <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code>,
we allow the user to specify the adjacency topologically, while
maintaining good defaults. The pattern is controlled by two flags. The first flag, <code class="docutils literal notranslate"><span class="pre">useCone</span></code>,
indicates whether variables couple first to their boundary <a class="footnote-reference brackets" href="#boundary-footnote" id="id2">2</a>
and then to
neighboring entities, or the reverse. For example, in finite elements,
the variables couple to the set of neighboring cells containing the mesh
point, and we set the flag to <code class="docutils literal notranslate"><span class="pre">useCone</span> <span class="pre">=</span> <span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_FALSE</a></span></code>. By constrast,
in finite volumes, cell variables first couple to the cell boundary, and
then to the neighbors, so we set the flag to <code class="docutils literal notranslate"><span class="pre">useCone</span> <span class="pre">=</span> <span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span></code>.
The second flag, <code class="docutils literal notranslate"><span class="pre">useClosure</span></code>, indicates whether we consider the
transitive closure of the neighbor relation above, or just a single
level. For example, in finite elements, the entire boundary of any cell
couples to the interior, and we set the flag to
<code class="docutils literal notranslate"><span class="pre">useClosure</span> <span class="pre">=</span> <span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span></code>. By contrast, in most finite volume methods,
cells couple only across faces, and not through vertices, so we set the
flag to <code class="docutils literal notranslate"><span class="pre">useClosure</span> <span class="pre">=</span> <span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_FALSE</a></span></code>. However, the power of this method
is its flexibility. If we wanted a finite volume method that coupled all
cells around a vertex, we could easily prescribe that by changing to
<code class="docutils literal notranslate"><span class="pre">useClosure</span> <span class="pre">=</span> <span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span></code>.</p>
</section>
</section>
<section id="evaluating-residuals">
<h2>Evaluating Residuals<a class="headerlink" href="#evaluating-residuals" title="Permalink to this heading">#</a></h2>
<p>The evaluation of a residual or Jacobian, for most discretizations has
the following general form:</p>
<ul class="simple">
<li><p>Traverse the mesh, picking out pieces (which in general overlap),</p></li>
<li><p>Extract some values from the current solution vector, associated with this
piece,</p></li>
<li><p>Calculate some values for the piece, and</p></li>
<li><p>Insert these values into the residual vector</p></li>
</ul>
<p>DMPlex separates these different concerns by passing sets of points  from mesh traversal routines to data
extraction routines and back. In this way, the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> which
structures the data inside a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span></code> does not need to know anything
about the mesh inside a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code>.</p>
<p>The most common mesh traversal is the transitive closure of a point,
which is exactly the transitive closure of a point in the DAG using the
covering relation. In other words, the transitive closure consists of
all points that cover the given point (generally a cell) plus all points
that cover those points, etc. So in 2d the transitive closure for a cell
consists of edges and vertices while in 3d it consists of faces, edges,
and vertices. Note that this closure can be calculated orienting the
arrows in either direction. For example, in a finite element
calculation, we calculate an integral over each element, and then sum up
the contributions to the basis function coefficients. The closure of the
element can be expressed discretely as the transitive closure of the
element point in the mesh DAG, where each point also has an orientation.
Then we can retrieve the data using <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> methods,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">;</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">     </span><span class="n">numPoints</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecGetArrayRead.html">VecGetArrayRead</a></span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetTransitiveClosure.html">DMPlexGetTransitiveClosure</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span><span class="p">,</span><span class="o">&amp;</span><span class="n">numPoints</span><span class="p">,</span><span class="o">&amp;</span><span class="n">points</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">numPoints</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetDof.html">PetscSectionGetDof</a></span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dof</span><span class="p">);</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetOffset.html">PetscSectionGetOffset</a></span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">dof</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">myfunc</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">off</span><span class="o">+</span><span class="n">d</span><span class="p">]);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexRestoreTransitiveClosure.html">DMPlexRestoreTransitiveClosure</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_TRUE</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numPoints</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">points</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecRestoreArrayRead.html">VecRestoreArrayRead</a></span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
<p>This operation is so common that we have built a convenience method
around it which returns the values in a contiguous array, correctly
taking into account the orientations of various mesh points:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">values</span><span class="p">;</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">           </span><span class="n">csize</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexVecGetClosure.html">DMPlexVecGetClosure</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">);</span>
<span class="c1">// Do integral in quadrature loop putting the result into r[]</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexVecRestoreClosure.html">DMPlexVecRestoreClosure</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexVecSetClosure.html">DMPlexVecSetClosure</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">residual</span><span class="p">,</span><span class="w"> </span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/ADD_VALUES.html">ADD_VALUES</a></span><span class="p">);</span>
</pre></div>
</div>
<p>A simple example of this kind of calculation is in
<code class="docutils literal notranslate"><span class="pre">DMPlexComputeL2Diff_Plex()</span></code> (<a class="reference external" href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/src/dm/impls/plex/plexfem.c.html#DMComputeL2Diff_Plex">source</a>).
Note that there is no restriction on the type of cell or dimension of
the mesh in the code above, so it will work for polyhedral cells, hybrid
meshes, and meshes of any dimension, without change. We can also reverse
the covering relation, so that the code works for finite volume methods
where we want the data from neighboring cells for each face:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscScalar.html">PetscScalar</a></span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">;</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">     </span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">numPoints</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">dofA</span><span class="p">,</span><span class="w"> </span><span class="n">offA</span><span class="p">,</span><span class="w"> </span><span class="n">dofB</span><span class="p">,</span><span class="w"> </span><span class="n">offB</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecGetArray.html">VecGetArray</a></span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w">  </span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexGetTransitiveClosure.html">DMPlexGetTransitiveClosure</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PETSC_FALSE</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numPoints</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">points</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">numPoints</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetDof.html">PetscSectionGetDof</a></span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dofA</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetDof.html">PetscSectionGetDof</a></span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dofB</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">dofA</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dofB</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetOffset.html">PetscSectionGetOffset</a></span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">offA</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSectionGetOffset.html">PetscSectionGetOffset</a></span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">offB</span><span class="p">);</span>
<span class="n">myfunc</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">offA</span><span class="p">],</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">offB</span><span class="p">]);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecRestoreArray.html">VecRestoreArray</a></span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
<p>This kind of calculation is used in
<a class="reference external" href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/src/ts/tutorials/ex11.c.html">TS Tutorial ex11</a>.</p>
</section>
<section id="saving-and-loading-dmplex-data-with-hdf5">
<h2>Saving and Loading DMPlex Data with HDF5<a class="headerlink" href="#saving-and-loading-dmplex-data-with-hdf5" title="Permalink to this heading">#</a></h2>
<p>PETSc allows users to save/load <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code>s representing meshes,
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code>s representing data layouts on the meshes, and
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span></code>s defined on the data layouts to/from an HDF5 file in
parallel, where one can use different number of processes for saving
and for loading.</p>
<section id="saving">
<h3>Saving<a class="headerlink" href="#saving" title="Permalink to this heading">#</a></h3>
<p>The simplest way to save <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code> data is to use options for configuration.
This requires only the code</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMViewFromOptions.html">DMViewFromOptions</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-dm_view&quot;</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/VecViewFromOptions.html">VecViewFromOptions</a></span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-vec_view&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>along with the command line options</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./myprog<span class="w"> </span>-dm_view<span class="w"> </span>hdf5:myprog.h5<span class="w"> </span>-vec_view<span class="w"> </span>hdf5:myprog.h5::append
</pre></div>
</div>
<p>Options prefixes can be used to separately control the saving and loading of various fields.
However, the user can have finer grained control by explicitly creating the PETSc objects involved.
To save data to “example.h5” file, we can first create a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span></code> of type <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PETSCVIEWERHDF5.html">PETSCVIEWERHDF5</a></span></code> in <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFileMode.html">FILE_MODE_WRITE</a></span></code> mode as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span><span class="w">  </span><span class="n">viewer</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerHDF5Open.html">PetscViewerHDF5Open</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;example.h5&quot;</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFileMode.html">FILE_MODE_WRITE</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">);</span>
</pre></div>
</div>
<p>As <code class="docutils literal notranslate"><span class="pre">dm</span></code> is a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> object representing a mesh, we first give it a <em>mesh name</em>, “plexA”, and save it as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;plexA&quot;</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPushFormat.html">PetscViewerPushFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PETSC_VIEWER_HDF5_PETSC</a></span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMView.html">DMView</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPopFormat.html">PetscViewerPopFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMView.html">DMView</a>()</span></code> call is shorthand for the following sequence</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexTopologyView.html">DMPlexTopologyView</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexCoordinatesView.html">DMPlexCoordinatesView</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexLabelsView.html">DMPlexLabelsView</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">);</span>
</pre></div>
</div>
<p>If the <em>mesh name</em> is not explicitly set, the default name is used.
In the above <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PETSC_VIEWER_HDF5_PETSC</a></span></code> format was used to save the entire representation of the mesh.
This format also saves global point numbers attached to the mesh points.
In this example the set of all global point numbers is <span class="math">\(X = [0, 11)\)</span>.</p>
<p>The data layout, <code class="docutils literal notranslate"><span class="pre">s</span></code>, needs to be wrapped in a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code> object for it to be saved.
Here, we create the wrapping <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code>, <code class="docutils literal notranslate"><span class="pre">sdm</span></code>, with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMClone.html">DMClone</a>()</span></code>, give it a <em>dm name</em>, “dmA”, attach <code class="docutils literal notranslate"><span class="pre">s</span></code> to <code class="docutils literal notranslate"><span class="pre">sdm</span></code>, and save it as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMClone.html">DMClone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sdm</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">sdm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dmA&quot;</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetLocalSection.html">DMSetLocalSection</a></span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSectionView.html">DMPlexSectionView</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">sdm</span><span class="p">);</span>
</pre></div>
</div>
<p>If the <em>dm name</em> is not explicitly set, the default name is to be used.
In the above, instead of using <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMClone.html">DMClone</a>()</span></code>, one could also create a new <code class="docutils literal notranslate"><span class="pre">DMSHELL</span></code> object to attach <code class="docutils literal notranslate"><span class="pre">s</span></code> to.
The first argument of <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSectionView.html">DMPlexSectionView</a>()</span></code> is a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> object that represents the mesh, and the third argument is a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code> object that carries the data layout that we would like to save.
They are, in general, two different objects, and the former carries a <em>mesh name</em>, while the latter carries a <em>dm name</em>.
These names are used to construct a group structure in the HDF5 file.
Note that the data layout points are associated with the mesh points, so each of them can also be tagged with a global point number in <span class="math">\(X\)</span>; <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSectionView.html">DMPlexSectionView</a>()</span></code> saves these tags along with the data layout itself, so that, when the mesh and the data layout are loaded separately later, one can associate the points in the former with those in the latter by comparing their global point numbers.</p>
<p>We now create a local vector assiciated with <code class="docutils literal notranslate"><span class="pre">sdm</span></code>, e.g., as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w">  </span><span class="n">vec</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetLocalVector.html">DMGetLocalVector</a></span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">);</span>
</pre></div>
</div>
<p>After setting values of <code class="docutils literal notranslate"><span class="pre">vec</span></code>, we name it “vecA” and save it as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vecA&quot;</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexLocalVectorView.html">DMPlexLocalVectorView</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">sdm</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span>
</pre></div>
</div>
<p>A global vector can be saved in the exact same way with trivial changes.</p>
<p>After saving, we destroy the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span></code> with:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerDestroy.html">PetscViewerDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">);</span>
</pre></div>
</div>
<p>The output file “example.h5” now looks like the following:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="w"> </span><span class="n">h5dump</span><span class="w"> </span><span class="o">--</span><span class="n">contents</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">h5</span>
<span class="n">HDF5</span><span class="w"> </span><span class="s">&quot;example.h5&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="n">FILE_CONTENTS</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">dms</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">dms</span><span class="o">/</span><span class="n">dmA</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">dms</span><span class="o">/</span><span class="n">dmA</span><span class="o">/</span><span class="n">order</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">dms</span><span class="o">/</span><span class="n">dmA</span><span class="o">/</span><span class="n">section</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">dms</span><span class="o">/</span><span class="n">dmA</span><span class="o">/</span><span class="n">section</span><span class="o">/</span><span class="n">atlasDof</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">dms</span><span class="o">/</span><span class="n">dmA</span><span class="o">/</span><span class="n">section</span><span class="o">/</span><span class="n">atlasOff</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">dms</span><span class="o">/</span><span class="n">dmA</span><span class="o">/</span><span class="n">vecs</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">dms</span><span class="o">/</span><span class="n">dmA</span><span class="o">/</span><span class="n">vecs</span><span class="o">/</span><span class="n">vecA</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">dms</span><span class="o">/</span><span class="n">dmA</span><span class="o">/</span><span class="n">vecs</span><span class="o">/</span><span class="n">vecA</span><span class="o">/</span><span class="n">vecA</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">labels</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">cells</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">cones</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">order</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">orientation</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="saving-in-the-new-parallel-hdf5-format">
<h3>Saving in the new parallel HDF5 format<a class="headerlink" href="#saving-in-the-new-parallel-hdf5-format" title="Permalink to this heading">#</a></h3>
<p>Since PETSc 3.19, we offer a new format which supports parallel loading.
To write in this format, you currently need to specify it explicitly using the option</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">dm_plex_view_hdf5_storage_version</span><span class="w"> </span><span class="mf">3.0.0</span>
</pre></div>
</div>
<p>The storage version is stored in the file and set automatically when loading (described below).
You can check the storage version of the HDF5 file with</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="w"> </span><span class="n">h5dump</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">/</span><span class="n">dmplex_storage_version</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">h5</span>
</pre></div>
</div>
<p>To allow for simple and efficient implementation, and good load balancing, the 3.0.0 format changes the way the mesh topology is stored.
Different strata (sets of mesh entities with an equal dimension; or vertices, edges, faces, and cells) are now stored separately.
The new structure of <code class="docutils literal notranslate"><span class="pre">/topologies/&lt;mesh_name&gt;/topology</span></code> is following:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="w"> </span><span class="n">h5dump</span><span class="w"> </span><span class="o">--</span><span class="n">contents</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">h5</span>
<span class="n">HDF5</span><span class="w"> </span><span class="s">&quot;example.h5&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="n">FILE_CONTENTS</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="p">...</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">permutation</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">0</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="n">cone_sizes</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="n">cones</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="n">orientations</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">1</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="n">cone_sizes</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="n">cones</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="n">orientations</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">2</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">cone_sizes</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">cones</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">orientations</span>
<span class="w"> </span><span class="n">group</span><span class="w">      </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">3</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="n">cone_sizes</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="n">cones</span>
<span class="w"> </span><span class="n">dataset</span><span class="w">    </span><span class="o">/</span><span class="n">topologies</span><span class="o">/</span><span class="n">plexA</span><span class="o">/</span><span class="n">topology</span><span class="o">/</span><span class="n">strata</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="n">orientations</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Group <code class="docutils literal notranslate"><span class="pre">/topologies/&lt;mesh_name&gt;/topology/strata</span></code> contains a subgroup for each stratum depth (dimension; 0 for vertices up to 3 for cells).
DAG points (mesh entities) have an implicit global numbering, given by the position in <code class="docutils literal notranslate"><span class="pre">orientations</span></code> (or <code class="docutils literal notranslate"><span class="pre">cone_sizes</span></code>) plus the stratum offset.
The stratum offset is given by a sum of lengths of all previous strata with respect to the order stored in <code class="docutils literal notranslate"><span class="pre">/topologies/&lt;mesh_name&gt;/topology/permutation</span></code>.
This global numbering is compatible with the explicit numbering in dataset <code class="docutils literal notranslate"><span class="pre">topology/order</span></code> of previous versions.</p>
<p>For a DAG point with index <code class="docutils literal notranslate"><span class="pre">i</span></code> at depth <code class="docutils literal notranslate"><span class="pre">s</span></code>, <code class="docutils literal notranslate"><span class="pre">cone_sizes[i]</span></code> gives a size of this point’s cone (set of adjacent entities with depth <code class="docutils literal notranslate"><span class="pre">s-1</span></code>).
Let <code class="docutils literal notranslate"><span class="pre">o</span> <span class="pre">=</span> <span class="pre">sum(cone_sizes[0:i]])</span></code> (in Python syntax).
Points forming the cone are then given by <code class="docutils literal notranslate"><span class="pre">cones[o:o+cone_sizes[i]]</span></code> (in numbering relative to the depth <code class="docutils literal notranslate"><span class="pre">s-1</span></code>).
The orientation of the cone with respect to point <code class="docutils literal notranslate"><span class="pre">i</span></code> is then stored in <code class="docutils literal notranslate"><span class="pre">orientations[i]</span></code>.</p>
</section>
<section id="loading">
<h3>Loading<a class="headerlink" href="#loading" title="Permalink to this heading">#</a></h3>
<p>To load data from “example.h5” file, we create a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span></code>
of type <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PETSCVIEWERHDF5.html">PETSCVIEWERHDF5</a></span></code> in <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFileMode.html">FILE_MODE_READ</a></span></code> mode as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerHDF5Open.html">PetscViewerHDF5Open</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="s">&quot;example.h5&quot;</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscFileMode.html">FILE_MODE_READ</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">);</span>
</pre></div>
</div>
<p>We then create a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> object, give it a <em>mesh name</em>, “plexA”, and load
the mesh as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreate.html">DMCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dm</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetType.html">DMSetType</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;plexA&quot;</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPushFormat.html">PetscViewerPushFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PETSC_VIEWER_HDF5_PETSC</a></span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMLoad.html">DMLoad</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPopFormat.html">PetscViewerPopFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">);</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PETSC_VIEWER_HDF5_PETSC</a></span></code> format was again used. The user can have more control by replace the single load call with</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span><span class="w">  </span><span class="n">sfO</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMCreate.html">DMCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a></span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dm</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMSetType.html">DMSetType</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;plexA&quot;</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPushFormat.html">PetscViewerPushFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerFormat.html">PETSC_VIEWER_HDF5_PETSC</a></span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexTopologyLoad.html">DMPlexTopologyLoad</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sfO</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexCoordinatesLoad.html">DMPlexCoordinatesLoad</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">sfO</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerPopFormat.html">PetscViewerPopFormat</a></span><span class="p">(</span><span class="n">viewer</span><span class="p">);</span>
</pre></div>
</div>
<p>The object returned by <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexTopologyLoad.html">DMPlexTopologyLoad</a>()</span></code>, <code class="docutils literal notranslate"><span class="pre">sfO</span></code>, is a
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span></code> that pushes forward <span class="math">\(X\)</span> to the loaded mesh,
<code class="docutils literal notranslate"><span class="pre">dm</span></code>; this <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span></code> is constructed with the global point
number tags that we saved along with the mesh points.</p>
<p>As the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> mesh just loaded might not have a desired distribution,
it is common to redistribute the mesh for a better distribution using
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexDistribute.html">DMPlexDistribute</a>()</span></code>, e.g., as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w">        </span><span class="n">distributedDM</span><span class="p">;</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w">  </span><span class="n">overlap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span><span class="w">   </span><span class="n">sfDist</span><span class="p">,</span><span class="w"> </span><span class="n">sf</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexDistribute.html">DMPlexDistribute</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">overlap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sfDist</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">distributedDM</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">distributedDM</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMDestroy.html">DMDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="p">);</span>
<span class="w">  </span><span class="n">dm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distributedDM</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;plexA&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSFCompose.html">PetscSFCompose</a></span><span class="p">(</span><span class="n">sfO</span><span class="p">,</span><span class="w"> </span><span class="n">sfDist</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sf</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSFDestroy.html">PetscSFDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfO</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSFDestroy.html">PetscSFDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfDist</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that the new <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code> does not automatically inherit the <em>mesh name</em>,
so we need to name it “plexA” once again. <code class="docutils literal notranslate"><span class="pre">sfDist</span></code> is a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span></code>
that pushes forward the loaded mesh to the redistributed mesh, so, composed
with <code class="docutils literal notranslate"><span class="pre">sfO</span></code>, it makes the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span></code> that pushes forward <span class="math">\(X\)</span>
directly to the redistributed mesh, which we call <code class="docutils literal notranslate"><span class="pre">sf</span></code>.</p>
<p>We then create a new <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span></code>, <code class="docutils literal notranslate"><span class="pre">sdm</span></code>, with <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMClone.html">DMClone</a>()</span></code>, give it
a <em>dm name</em>, “dmA”, and load the on-disk data layout into <code class="docutils literal notranslate"><span class="pre">sdm</span></code> as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span><span class="w">  </span><span class="n">globalDataSF</span><span class="p">,</span><span class="w"> </span><span class="n">localDataSF</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMClone.html">DMClone</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sdm</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">sdm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dmA&quot;</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSectionLoad.html">DMPlexSectionLoad</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">sdm</span><span class="p">,</span><span class="w"> </span><span class="n">sf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">globalDataSF</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">localDataSF</span><span class="p">);</span>
</pre></div>
</div>
<p>where we could also create a new
<code class="docutils literal notranslate"><span class="pre">DMSHELL</span></code> object instead of using <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMClone.html">DMClone</a>()</span></code>.
Each point in the on-disk data layout being tagged with a global
point number in <span class="math">\(X\)</span>, <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSectionLoad.html">DMPlexSectionLoad</a>()</span></code>
internally constructs a <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span></code> that pushes forward the on-disk
data layout to <span class="math">\(X\)</span>.
Composing this with <code class="docutils literal notranslate"><span class="pre">sf</span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexSectionLoad.html">DMPlexSectionLoad</a>()</span></code> internally
constructs another <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span></code> that pushes forward the on-disk
data layout directly to the redistributed mesh. It then
reconstructs the data layout <code class="docutils literal notranslate"><span class="pre">s</span></code> on the redistributed mesh and
attaches it to <code class="docutils literal notranslate"><span class="pre">sdm</span></code>. The objects returned by this function,
<code class="docutils literal notranslate"><span class="pre">globalDataSF</span></code> and <code class="docutils literal notranslate"><span class="pre">localDataSF</span></code>, are <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSF/PetscSF.html">PetscSF</a></span></code>s that can
be used to migrate the on-disk vector data into local and global
<code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span></code>s defined on <code class="docutils literal notranslate"><span class="pre">sdm</span></code>.</p>
<p>We now create a local vector assiciated with <code class="docutils literal notranslate"><span class="pre">sdm</span></code>, e.g., as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w">  </span><span class="n">vec</span><span class="p">;</span>

<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMGetLocalVector.html">DMGetLocalVector</a></span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="p">);</span>
</pre></div>
</div>
<p>We then name <code class="docutils literal notranslate"><span class="pre">vec</span></code> “vecA” and load the on-disk vector into <code class="docutils literal notranslate"><span class="pre">vec</span></code> as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a></span><span class="p">((</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscObject.html">PetscObject</a></span><span class="p">)</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vecA&quot;</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexLocalVectorLoad.html">DMPlexLocalVectorLoad</a></span><span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">,</span><span class="w"> </span><span class="n">sdm</span><span class="p">,</span><span class="w"> </span><span class="n">localDataSF</span><span class="p">,</span><span class="w"> </span><span class="n">localVec</span><span class="p">);</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">localDataSF</span></code> knows how to migrate the on-disk vector
data into a local <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span></code> defined on <code class="docutils literal notranslate"><span class="pre">sdm</span></code>.
The on-disk vector can be loaded into a global vector associated with
<code class="docutils literal notranslate"><span class="pre">sdm</span></code> in the exact same way with trivial changes.</p>
<p>After loading, we destroy the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewer.html">PetscViewer</a></span></code> with:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Viewer/PetscViewerDestroy.html">PetscViewerDestroy</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">);</span>
</pre></div>
</div>
<p>The above infrastructure works seamlessly in distributed-memory parallel
settings, in which one can even use different number of processes for
saving and for loading; a more comprehensive example is found in
<a class="reference external" href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/src/dm/impls/plex/tutorials/ex12.c.html">DMPlex Tutorial ex12</a>.</p>
</section>
</section>
<section id="metric-based-mesh-adaptation">
<h2>Metric-based mesh adaptation<a class="headerlink" href="#metric-based-mesh-adaptation" title="Permalink to this heading">#</a></h2>
<p>DMPlex supports mesh adaptation using the <em>Riemannian metric framework</em>.
The idea is to use a Riemannian metric space within the mesher. The
metric space dictates how mesh resolution should be distributed across
the domain. Using this information, the remesher transforms the mesh such
that it is a <em>unit mesh</em> when viewed in the metric space. That is, the image
of each of its elements under the mapping from Euclidean space into the
metric space has edges of unit length.</p>
<p>One of the main advantages of metric-based mesh adaptation is that it allows
for fully anisotropic remeshing. That is, it provides a means of controlling
the shape and orientation of elements in the adapted mesh, as well as their
size. This can be particularly useful for advection-dominated and
directionally-dependent problems.</p>
<p>See <span id="id3">[<a class="reference internal" href="#id3761" title="Frédéric Alauzet. Metric-based anisotropic mesh adaptation. https://pages.saclay.inria.fr/frederic.alauzet/cours/cea2010_V3.pdf, 2010.">Ala10</a>]</span> for further details on metric-based anisotropic mesh
adaptation.</p>
<p>The two main ingredients for metric-based mesh adaptation are an input mesh
(i.e. the <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPLEX.html">DMPLEX</a></span></code>) and a Riemannian metric. The implementation in PETSc assumes
that the metric is piecewise linear and continuous across elemental boundaries.
Such an object can be created using the routine</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricCreate.html">DMPlexMetricCreate</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="o">*</span><span class="n">metric</span><span class="p">);</span>
</pre></div>
</div>
<p>A metric must be symmetric positive-definite, so that distances may be properly
defined. This can be checked using</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricEnforceSPD.html">DMPlexMetricEnforceSPD</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">metricIn</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w"> </span><span class="n">restrictSizes</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w"> </span><span class="n">restrictAnisotropy</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">metricOut</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">determinant</span><span class="p">);</span>
</pre></div>
</div>
<p>This routine may also be used to enforce minimum and maximum tolerated metric
magnitudes (i.e. cell sizes), as well as maximum anisotropy. These quantities
can be specified using</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricSetMinimumMagnitude.html">DMPlexMetricSetMinimumMagnitude</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">h_min</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricSetMaximumMagnitude.html">DMPlexMetricSetMaximumMagnitude</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">h_max</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricSetMaximumAnisotropy.html">DMPlexMetricSetMaximumAnisotropy</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">a_max</span><span class="p">);</span>
</pre></div>
</div>
<p>or the command line arguments</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">dm_plex_metric_h_min</span><span class="w"> </span><span class="o">&lt;</span><span class="n">h_min</span><span class="o">&gt;</span>
<span class="o">-</span><span class="n">dm_plex_metric_h_max</span><span class="w"> </span><span class="o">&lt;</span><span class="n">h_max</span><span class="o">&gt;</span>
<span class="o">-</span><span class="n">dm_plex_metric_a_max</span><span class="w"> </span><span class="o">&lt;</span><span class="n">a_max</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>One simple way to combine two metrics is by simply averaging them entry-by-entry.
Another is to <em>intersect</em> them, which amounts to choosing the greatest level of
refinement in each direction. These operations are available in PETSc through
the routines</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricAverage.html">DMPlexMetricAverage</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numMetrics</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">weights</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">metrics</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">metricAvg</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricIntersection.html">DMPlexMetricIntersection</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscInt.html">PetscInt</a></span><span class="w"> </span><span class="n">numMetrics</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">metrics</span><span class="p">[],</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">metricInt</span><span class="p">);</span>
</pre></div>
</div>
<p>However, before combining metrics, it is important that they are scaled in the same
way. Scaling also allows the user to control the number of vertices in the adapted
mesh (in an approximate sense). This is achieved using the <span class="math">\(L^p\)</span> normalization
framework, with the routine</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricNormalize.html">DMPlexMetricNormalize</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">metricIn</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w"> </span><span class="n">restrictSizes</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscBool.html">PetscBool</a></span><span class="w"> </span><span class="n">restrictAnisotropy</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">metricOut</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">determinant</span><span class="p">);</span>
</pre></div>
</div>
<p>There are two important parameters for the normalization: the normalization order
<span class="math">\(p\)</span> and the target metric complexity, which is analogous to the vertex count.
They are controlled using</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricSetNormalizationOrder.html">DMPlexMetricSetNormalizationOrder</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMPlex/DMPlexMetricSetTargetComplexity.html">DMPlexMetricSetTargetComplexity</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Sys/PetscReal.html">PetscReal</a></span><span class="w"> </span><span class="n">target</span><span class="p">);</span>
</pre></div>
</div>
<p>or the command line arguments</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">-dm_plex_metric_p &lt;p&gt;</span>
<span class="go">-dm_plex_metric_target_complexity &lt;target&gt;</span>
</pre></div>
</div>
<p>Two different metric-based mesh adaptation tools are available in PETSc:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://meshadaptation.github.io/">Pragmatic</a>;</p></li>
<li><p><a class="reference external" href="https://www.mmgtools.org/">Mmg/ParMmg</a>.</p></li>
</ul>
<p>Mmg is a serial package, whereas ParMmg is the MPI version.
Note that surface meshing is not currently supported and that ParMmg
works only in three dimensions. Mmg can be used for both two and three dimensional problems.
Pragmatic, Mmg and ParMmg may be specified by the command line arguments</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">dm_adaptor</span><span class="w"> </span><span class="n">pragmatic</span>
<span class="o">-</span><span class="n">dm_adaptor</span><span class="w"> </span><span class="n">mmg</span>
<span class="o">-</span><span class="n">dm_adaptor</span><span class="w"> </span><span class="n">parmmg</span>
</pre></div>
</div>
<p>Once a metric has been constructed, it can be used to perform metric-based
mesh adaptation using the routine</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DMAdaptMetric.html">DMAdaptMetric</a></span><span class="p">(</span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/Vec/Vec.html">Vec</a></span><span class="w"> </span><span class="n">metric</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMLabel/DMLabel.html">DMLabel</a></span><span class="w"> </span><span class="n">bdLabel</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DMLabel/DMLabel.html">DMLabel</a></span><span class="w"> </span><span class="n">rgLabel</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/DM/DM.html">DM</a></span><span class="w"> </span><span class="n">dmAdapt</span><span class="p">);</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">bdLabel</span></code> and <code class="docutils literal notranslate"><span class="pre">rgLabel</span></code> are boundary and interior tags to be
preserved under adaptation, respectively.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="petscsection-footnote"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>A <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/PetscSection/PetscSection.html">PetscSection</a></span></code> can be thought of as a generalization of <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/IS/PetscLayout.html">PetscLayout</a></span></code>, in the same way that a fiber bundle is a generalization
of the normal Euclidean basis used in linear algebra. With <code class="docutils literal notranslate"><span class="pre"><a href="PETSC_DOC_OUT_ROOT_PLACEHOLDER/manualpages/IS/PetscLayout.html">PetscLayout</a></span></code>, we associate a unit vector (<span class="math">\(e_i\)</span>) with every
point in the space, and just divide up points between processes.</p>
</dd>
<dt class="label" id="boundary-footnote"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>The boundary of a cell is its faces, the boundary of a face is its edges and the boundary of an edge is the two vertices.</p>
</dd>
</dl>
<div class="docutils container" id="id4">
<dl class="citation">
<dt class="label" id="id3761"><span class="brackets"><a class="fn-backref" href="#id3">Ala10</a></span></dt>
<dd><p>Frédéric Alauzet. Metric-based anisotropic mesh adaptation. <a class="reference external" href="https://pages.saclay.inria.fr/frederic.alauzet/cours/cea2010_V3.pdf">https://pages.saclay.inria.fr/frederic.alauzet/cours/cea2010_V3.pdf</a>, 2010.</p>
</dd>
</dl>
</div>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="dmbase.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">DM Basics</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="dmstag.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">DMSTAG: Staggered, Structured Grid</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#representing-unstructured-grids">
   Representing Unstructured Grids
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dealing-with-periodicity">
   Dealing with Periodicity
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#connecting-data-on-grids-to-its-location-in-arrays-or-vec-petscsection">
   Connecting Data on Grids to its Location in arrays or Vec (PetscSection)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-layout-by-hand">
     Data Layout by Hand
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-layout-using-dmplex-and-petscfe">
     Data Layout using DMPLEX and PetscFE
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#partitioning-and-ordering">
     Partitioning and Ordering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#influence-of-variables-on-one-another">
     Influence of Variables on One Another
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluating-residuals">
   Evaluating Residuals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#saving-and-loading-dmplex-data-with-hdf5">
   Saving and Loading DMPlex Data with HDF5
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#saving">
     Saving
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#saving-in-the-new-parallel-hdf5-format">
     Saving in the new parallel HDF5 format
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading">
     Loading
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#metric-based-mesh-adaptation">
   Metric-based mesh adaptation
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  

<div class="tocsection editthispage">
    <a href="https://gitlab.com/petsc/petsc/edit/release/doc/manual/dmplex.rst">
        <i class="fa-solid fa-pencil"></i> Edit this page
    </a>
</div>

</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../_sources/manual/dmplex.rst.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 1991-2023, UChicago Argonne, LLC and the PETSc Development Team.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
  <div class="footer-item">
    <p class="last-updated">
Last updated on 2023-04-30T09:17:39-0500 (v3.19.1).<br>
</p>
  </div>
  
</div>
  </footer>
  </body>
</html>