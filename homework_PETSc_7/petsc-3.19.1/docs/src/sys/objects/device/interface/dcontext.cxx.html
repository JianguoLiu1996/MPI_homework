<center><a href="https://gitlab.com/petsc/petsc/-/blob/a093114c2e7b4ba1f47e6ac8a72c57724150f16d/src/sys/objects/device/interface/dcontext.cxx">Actual source code: dcontext.cxx</a></center><br>

<html>
<head>
<title></title>
<meta name="generator" content="c2html 0.9.4">
<meta name="date" content="2023-04-30T14:19:44+00:00">
</head>

<body bgcolor="#FFFFFF">
<pre width="80">
<a name="line1">  1: </a><font color="#A020F0">#include </font><font color="#666666">"petscdevice_interface_internal.hpp"</font><font color="#A020F0"> </font><font color="#B22222">/*I &lt;petscdevice.h&gt; I*/</font><font color="#A020F0"></font>
<a name="line2">  2: </a>#include <A href="../../../../../include/petsc/private/viewerimpl.h.html">&lt;petsc/private/viewerimpl.h&gt;</A>

<a name="line4">  4: </a>#include <A href="../../../../../include/petsc/private/cpp/object_pool.hpp.html">&lt;petsc/private/cpp/object_pool.hpp&gt;</A>
<a name="line5">  5: </a>#include <A href="../../../../../include/petsc/private/cpp/utility.hpp.html">&lt;petsc/private/cpp/utility.hpp&gt;</A>
<a name="line6">  6: </a>#include <A href="../../../../../include/petsc/private/cpp/array.hpp.html">&lt;petsc/private/cpp/array.hpp&gt;</A>

<a name="line8">  8: </a><font color="#A020F0">#include &lt;vector&gt;</font>
<a name="line9">  9: </a><font color="#A020F0">#include &lt;string&gt; // std::to_string among other things</font>

<a name="line11"> 11: </a><font color="#B22222">/* Define the allocator */</font>
<a name="line12"> 12: </a>class PetscDeviceContextConstructor : public Petsc::ConstructorInterface&lt;_p_PetscDeviceContext, PetscDeviceContextConstructor&gt; {
<a name="line13"> 13: </a><strong><font color="#FF0000">public:</font></strong>
<a name="line14"> 14: </a>  <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> construct_(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx) const noexcept
<a name="line15"> 15: </a>  {
<a name="line16"> 16: </a>    <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line17"> 17: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscArrayzero.html">PetscArrayzero</a>(dctx, 1));
<a name="line18"> 18: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscHeaderInitialize_Private(dctx, PETSC_DEVICE_CONTEXT_CLASSID, <font color="#666666">"<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>"</font>, <font color="#666666">"<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>"</font>, <font color="#666666">"Sys"</font>, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, <a href="../../../../../manualpages/Sys/PetscDeviceContextDestroy.html">PetscDeviceContextDestroy</a>, <a href="../../../../../manualpages/Sys/PetscDeviceContextView.html">PetscDeviceContextView</a>));
<a name="line19"> 19: </a>    <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(PetscObjectCast(dctx)-&gt;cpp = new CxxData());
<a name="line20"> 20: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(underlying().reset(dctx, false));
<a name="line21"> 21: </a>    <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line22"> 22: </a>  }

<a name="line24"> 24: </a>  static <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> destroy_(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx) noexcept
<a name="line25"> 25: </a>  {
<a name="line26"> 26: </a>    <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line27"> 27: </a>    <a href="../../../../../manualpages/Sys/PetscAssert.html">PetscAssert</a>(!dctx-&gt;numChildren, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONGSTATE</a>, <font color="#666666">"Device context still has %"</font> PetscInt_FMT <font color="#666666">" un-joined children, must call <a href="../../../../../manualpages/Sys/PetscDeviceContextJoin.html">PetscDeviceContextJoin</a>() with all children before destroying"</font>, dctx-&gt;numChildren);
<a name="line28"> 28: </a>    <a href="../../../../../manualpages/Sys/PetscTryTypeMethod.html">PetscTryTypeMethod</a>(dctx, destroy);
<a name="line29"> 29: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceDestroy.html">PetscDeviceDestroy</a>(&amp;dctx-&gt;device));
<a name="line30"> 30: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscFree.html">PetscFree</a>(dctx-&gt;childIDs));
<a name="line31"> 31: </a>    delete CxxDataCast(dctx);
<a name="line32"> 32: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscHeaderDestroy_Private(PetscObjectCast(dctx), <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_FALSE</a>));
<a name="line33"> 33: </a>    <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line34"> 34: </a>  }

<a name="line36"> 36: </a>  static <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> reset_(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, bool zero = true) noexcept
<a name="line37"> 37: </a>  {
<a name="line38"> 38: </a>    <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line39"> 39: </a>    <font color="#4169E1">if</font> (zero) {
<a name="line40"> 40: </a>      // reset the device <font color="#4169E1">if</font> the user set it
<a name="line41"> 41: </a>      <font color="#4169E1">if</font> (Petsc::util::exchange(dctx-&gt;usersetdevice, <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_FALSE</a>)) {
<a name="line42"> 42: </a>        <a href="../../../../../manualpages/Sys/PetscTryTypeMethod.html">PetscTryTypeMethod</a>(dctx, destroy);
<a name="line43"> 43: </a>        <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceDestroy.html">PetscDeviceDestroy</a>(&amp;dctx-&gt;device));
<a name="line44"> 44: </a>        <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscArrayzero.html">PetscArrayzero</a>(dctx-&gt;ops, 1));
<a name="line45"> 45: </a>        dctx-&gt;data = nullptr;
<a name="line46"> 46: </a>      }
<a name="line47"> 47: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscHeaderReset_Internal(PetscObjectCast(dctx)));
<a name="line48"> 48: </a>      dctx-&gt;numChildren = 0;
<a name="line49"> 49: </a>      dctx-&gt;setup       = <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_FALSE</a>;
<a name="line50"> 50: </a>      // don't deallocate the child array, rather just zero it out
<a name="line51"> 51: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscArrayzero.html">PetscArrayzero</a>(dctx-&gt;childIDs, dctx-&gt;maxNumChildren));
<a name="line52"> 52: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(CxxDataCast(dctx)-&gt;clear());
<a name="line53"> 53: </a>    }
<a name="line54"> 54: </a>    dctx-&gt;streamType = <a href="../../../../../manualpages/Sys/PetscStreamType.html">PETSC_STREAM_DEFAULT_BLOCKING</a>;
<a name="line55"> 55: </a>    <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line56"> 56: </a>  }

<a name="line58"> 58: </a>  static <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> invalidate_(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>) noexcept { <font color="#4169E1">return</font> <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>; }
<a name="line59"> 59: </a>};

<a name="line61"> 61: </a>static Petsc::ObjectPool&lt;_p_PetscDeviceContext, PetscDeviceContextConstructor&gt; contextPool;

<a name="line63"> 63: </a><font color="#B22222">/*@C</font>
<a name="line64"> 64: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a> - Creates a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line66"> 66: </a><font color="#B22222">  Not Collective</font>

<a name="line68"> 68: </a><font color="#B22222">  Output Parameter:</font>
<a name="line69"> 69: </a><font color="#B22222">. dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line71"> 71: </a><font color="#B22222">  Level: beginner</font>

<a name="line73"> 73: </a><font color="#B22222">  Note:</font>
<a name="line74"> 74: </a><font color="#B22222">  Unlike almost every other PETSc class it is advised that most users use</font>
<a name="line75"> 75: </a><font color="#B22222">  `<a href="../../../../../manualpages/Sys/PetscDeviceContextDuplicate.html">PetscDeviceContextDuplicate</a>()` rather than this routine to create new contexts. Contexts of</font>
<a name="line76"> 76: </a><font color="#B22222">  different types are incompatible with one another; using `<a href="../../../../../manualpages/Sys/PetscDeviceContextDuplicate.html">PetscDeviceContextDuplicate</a>()`</font>
<a name="line77"> 77: </a><font color="#B22222">  ensures compatible types.</font>

<a name="line79"> 79: </a><font color="#B22222">  DAG representation:</font>
<a name="line80"> 80: </a><font color="#B22222">.vb</font>
<a name="line81"> 81: </a><font color="#B22222">  time -&gt;</font>

<a name="line83"> 83: </a><font color="#B22222">  |= CALL =| - dctx -&gt;</font>
<a name="line84"> 84: </a><font color="#B22222">.ve</font>

<a name="line86"> 86: </a><font color="#B22222">.N ASYNC_API</font>

<a name="line88"> 88: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextDuplicate.html">PetscDeviceContextDuplicate</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetDevice.html">PetscDeviceContextSetDevice</a>()`,</font>
<a name="line89"> 89: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetUp.html">PetscDeviceContextSetUp</a>()`,</font>
<a name="line90"> 90: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextSetFromOptions.html">PetscDeviceContextSetFromOptions</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextView.html">PetscDeviceContextView</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextDestroy.html">PetscDeviceContextDestroy</a>()`</font>
<a name="line91"> 91: </a><font color="#B22222">@*/</font>
<a name="line92"> 92: </a><strong><font color="#4169E1"><a name="PetscDeviceContextCreate"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> *dctx)</font></strong>
<a name="line93"> 93: </a>{
<a name="line94"> 94: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line96"> 96: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceInitializePackage.html">PetscDeviceInitializePackage</a>());
<a name="line97"> 97: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_Create, nullptr, nullptr, nullptr, nullptr));
<a name="line98"> 98: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(contextPool.allocate(dctx));
<a name="line99"> 99: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_Create, nullptr, nullptr, nullptr, nullptr));
<a name="line100">100: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line101">101: </a>}

<a name="line103">103: </a><font color="#B22222">/*@C</font>
<a name="line104">104: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextDestroy.html">PetscDeviceContextDestroy</a> - Frees a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line106">106: </a><font color="#B22222">  Not Collective</font>

<a name="line108">108: </a><font color="#B22222">  Input Parameter:</font>
<a name="line109">109: </a><font color="#B22222">. dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line111">111: </a><font color="#B22222">  Level: beginner</font>

<a name="line113">113: </a><font color="#B22222">  Notes:</font>
<a name="line114">114: </a><font color="#B22222">  No implicit synchronization occurs due to this routine, all resources are released completely</font>
<a name="line115">115: </a><font color="#B22222">  asynchronously w.r.t. the host. If one needs to guarantee access to the data produced on</font>
<a name="line116">116: </a><font color="#B22222">  `dctx`'s stream the user is responsible for calling `<a href="../../../../../manualpages/Sys/PetscDeviceContextSynchronize.html">PetscDeviceContextSynchronize</a>()` before</font>
<a name="line117">117: </a><font color="#B22222">  calling this routine.</font>

<a name="line119">119: </a><font color="#B22222">  DAG representation:</font>
<a name="line120">120: </a><font color="#B22222">.vb</font>
<a name="line121">121: </a><font color="#B22222">  time -&gt;</font>

<a name="line123">123: </a><font color="#B22222">  -&gt; dctx - |= CALL =|</font>
<a name="line124">124: </a><font color="#B22222">.ve</font>

<a name="line126">126: </a><font color="#B22222">  Developer Notes:</font>
<a name="line127">127: </a><font color="#B22222">  `dctx` is never actually "destroyed" in the classical sense. It is returned to an ever</font>
<a name="line128">128: </a><font color="#B22222">  growing pool of `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`s. There are currently no limits on the size of the pool,</font>
<a name="line129">129: </a><font color="#B22222">  this should perhaps be implemented.</font>

<a name="line131">131: </a><font color="#B22222">.N ASYNC_API</font>

<a name="line133">133: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetDevice.html">PetscDeviceContextSetDevice</a>()`,</font>
<a name="line134">134: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextSetUp.html">PetscDeviceContextSetUp</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSynchronize.html">PetscDeviceContextSynchronize</a>()`</font>
<a name="line135">135: </a><font color="#B22222">@*/</font>
<a name="line136">136: </a><strong><font color="#4169E1"><a name="PetscDeviceContextDestroy"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextDestroy.html">PetscDeviceContextDestroy</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> *dctx)</font></strong>
<a name="line137">137: </a>{
<a name="line138">138: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line140">140: </a>  <font color="#4169E1">if</font> (!*dctx) <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line141">141: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_Destroy, nullptr, nullptr, nullptr, nullptr));
<a name="line142">142: </a>  <font color="#4169E1">if</font> (--(PetscObjectCast(*dctx)-&gt;refct) &lt;= 0) {
<a name="line143">143: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextCheckNotOrphaned_Internal(*dctx));
<a name="line144">144: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(contextPool.deallocate(dctx));
<a name="line145">145: </a>  }
<a name="line146">146: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_Destroy, nullptr, nullptr, nullptr, nullptr));
<a name="line147">147: </a>  *dctx = nullptr;
<a name="line148">148: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line149">149: </a>}

<a name="line151">151: </a><font color="#B22222">/*@C</font>
<a name="line152">152: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a> - Set the implementation type of the underlying stream for a</font>
<a name="line153">153: </a><font color="#B22222">  `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line155">155: </a><font color="#B22222">  Not Collective</font>

<a name="line157">157: </a><font color="#B22222">  Input Parameters:</font>
<a name="line158">158: </a><font color="#B22222">+ dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>
<a name="line159">159: </a><font color="#B22222">- type - The `<a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a>`</font>

<a name="line161">161: </a><font color="#B22222">  Level: beginner</font>

<a name="line163">163: </a><font color="#B22222">  Note:</font>
<a name="line164">164: </a><font color="#B22222">  See `<a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a>` in `include/petscdevicetypes.h` for more information on the available</font>
<a name="line165">165: </a><font color="#B22222">  types and their interactions. If the `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` was previously set up and stream</font>
<a name="line166">166: </a><font color="#B22222">  type was changed, you must call `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetUp.html">PetscDeviceContextSetUp</a>()` again after this routine.</font>

<a name="line168">168: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a>`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextGetStreamType.html">PetscDeviceContextGetStreamType</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>()`,</font>
<a name="line169">169: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextSetUp.html">PetscDeviceContextSetUp</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetFromOptions.html">PetscDeviceContextSetFromOptions</a>()`</font>
<a name="line170">170: </a><font color="#B22222">@*/</font>
<a name="line171">171: </a><strong><font color="#4169E1"><a name="PetscDeviceContextSetStreamType"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a> type)</font></strong>
<a name="line172">172: </a>{
<a name="line173">173: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line174">174: </a>  // <font color="#4169E1">do</font> not use getoptionalnullcontext here since we <font color="#4169E1">do</font> not want the user to change the stream
<a name="line175">175: </a>  // type
<a name="line178">178: </a>  // only need to <font color="#4169E1">do</font> complex swapping <font color="#4169E1">if</font> the object has already been setup
<a name="line179">179: </a>  <font color="#4169E1">if</font> (dctx-&gt;setup &amp;&amp; (dctx-&gt;streamType != type)) {
<a name="line180">180: </a>    dctx-&gt;setup = <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_FALSE</a>;
<a name="line181">181: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_ChangeStream, dctx, nullptr, nullptr, nullptr));
<a name="line182">182: </a>    <a href="../../../../../manualpages/Sys/PetscUseTypeMethod.html">PetscUseTypeMethod</a>(dctx, changestreamtype, type);
<a name="line183">183: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_ChangeStream, dctx, nullptr, nullptr, nullptr));
<a name="line184">184: </a>  }
<a name="line185">185: </a>  dctx-&gt;streamType = type;
<a name="line186">186: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line187">187: </a>}

<a name="line189">189: </a><font color="#B22222">/*@C</font>
<a name="line190">190: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextGetStreamType.html">PetscDeviceContextGetStreamType</a> - Get the implementation type of the underlying stream for a</font>
<a name="line191">191: </a><font color="#B22222">  `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line193">193: </a><font color="#B22222">  Not Collective</font>

<a name="line195">195: </a><font color="#B22222">  Input Parameter:</font>
<a name="line196">196: </a><font color="#B22222">. dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line198">198: </a><font color="#B22222">  Output Parameter:</font>
<a name="line199">199: </a><font color="#B22222">. type - The `<a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a>`</font>

<a name="line201">201: </a><font color="#B22222">  Level: beginner</font>

<a name="line203">203: </a><font color="#B22222">  Note:</font>
<a name="line204">204: </a><font color="#B22222">  See `<a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a>` in `include/petscdevicetypes.h` for more information on the available</font>
<a name="line205">205: </a><font color="#B22222">  types and their interactions</font>

<a name="line207">207: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>()`,</font>
<a name="line208">208: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextSetFromOptions.html">PetscDeviceContextSetFromOptions</a>()`</font>
<a name="line209">209: </a><font color="#B22222">@*/</font>
<a name="line210">210: </a><strong><font color="#4169E1"><a name="PetscDeviceContextGetStreamType"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextGetStreamType.html">PetscDeviceContextGetStreamType</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a> *type)</font></strong>
<a name="line211">211: </a>{
<a name="line212">212: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line213">213: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line215">215: </a>  *type = dctx-&gt;streamType;
<a name="line216">216: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line217">217: </a>}

<a name="line219">219: </a><font color="#B22222">/*</font>
<a name="line220">220: </a><font color="#B22222">  Actual function to set the device.</font>

<a name="line222">222: </a><font color="#B22222">  1. Repeatedly destroying and recreating internal data structures (like streams and events)</font>
<a name="line223">223: </a><font color="#B22222">     for recycled PetscDeviceContexts is not free. If done often, it does add up.</font>
<a name="line224">224: </a><font color="#B22222">  2. The vast majority of PetscDeviceContexts are created by PETSc either as children or</font>
<a name="line225">225: </a><font color="#B22222">     default contexts. The default contexts *never* change type, and the children are extremely</font>
<a name="line226">226: </a><font color="#B22222">     unlikely to (chances are if you fork once, you will fork again very soon).</font>
<a name="line227">227: </a><font color="#B22222">  3. The only time this calculus changes is if the user themselves sets the device type. In</font>
<a name="line228">228: </a><font color="#B22222">     this case we do not know what the user has changed, so must always wipe the slate clean.</font>

<a name="line230">230: </a><font color="#B22222">  Thus we need to keep track whether the user explicitly sets the device contexts device.</font>
<a name="line231">231: </a><font color="#B22222">*/</font>
<a name="line232">232: </a><strong><font color="#4169E1"><a name="PetscDeviceContextSetDevice_Private"></a>static <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> PetscDeviceContextSetDevice_Private(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a> device, <a href="../../../../../manualpages/Sys/PetscBool.html">PetscBool</a> user_set)</font></strong>
<a name="line233">233: </a>{
<a name="line234">234: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line235">235: </a>  // <font color="#4169E1">do</font> not use getoptionalnullcontext here since we <font color="#4169E1">do</font> not want the user to change its device
<a name="line238">238: </a>  <font color="#4169E1">if</font> (dctx-&gt;device &amp;&amp; (dctx-&gt;device-&gt;id == device-&gt;id)) <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line239">239: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_SetDevice, dctx, nullptr, nullptr, nullptr));
<a name="line240">240: </a>  <a href="../../../../../manualpages/Sys/PetscTryTypeMethod.html">PetscTryTypeMethod</a>(dctx, destroy);
<a name="line241">241: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceDestroy.html">PetscDeviceDestroy</a>(&amp;dctx-&gt;device));
<a name="line242">242: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscMemzero.html">PetscMemzero</a>(dctx-&gt;ops, <font color="#4169E1">sizeof</font>(*dctx-&gt;ops)));
<a name="line243">243: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceReference_Internal(device));
<a name="line244">244: </a>  // set it before calling the method
<a name="line245">245: </a>  dctx-&gt;device = device;
<a name="line246">246: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>((*device-&gt;ops-&gt;createcontext)(dctx));
<a name="line247">247: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_SetDevice, dctx, nullptr, nullptr, nullptr));
<a name="line248">248: </a>  dctx-&gt;setup         = <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_FALSE</a>;
<a name="line249">249: </a>  dctx-&gt;usersetdevice = user_set;
<a name="line250">250: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line251">251: </a>}

<a name="line253">253: </a><strong><font color="#4169E1"><a name="PetscDeviceContextSetDefaultDeviceForType_Internal"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> PetscDeviceContextSetDefaultDeviceForType_Internal(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscDeviceType.html">PetscDeviceType</a> type)</font></strong>
<a name="line254">254: </a>{
<a name="line255">255: </a>  <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a> device;

<a name="line257">257: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line258">258: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceGetDefaultForType_Internal(type, &amp;device));
<a name="line259">259: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextSetDevice_Private(dctx, device, <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_FALSE</a>));
<a name="line260">260: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line261">261: </a>}

<a name="line263">263: </a><font color="#B22222">/*@C</font>
<a name="line264">264: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextSetDevice.html">PetscDeviceContextSetDevice</a> - Set the underlying `<a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>` for a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line266">266: </a><font color="#B22222">  Not Collective</font>

<a name="line268">268: </a><font color="#B22222">  Input Parameters:</font>
<a name="line269">269: </a><font color="#B22222">+ dctx   - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>
<a name="line270">270: </a><font color="#B22222">- device - The `<a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>`</font>

<a name="line272">272: </a><font color="#B22222">  Level: intermediate</font>

<a name="line274">274: </a><font color="#B22222">  Notes:</font>
<a name="line275">275: </a><font color="#B22222">  This routine is effectively `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`'s "set-type" (so every `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` must</font>
<a name="line276">276: </a><font color="#B22222">  also have an attached `<a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>`). Unlike the usual set-type semantics, it is not strictly</font>
<a name="line277">277: </a><font color="#B22222">  necessary to set a contexts device to enable usage, any created `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`s will</font>
<a name="line278">278: </a><font color="#B22222">  always come equipped with the "default" device.</font>

<a name="line280">280: </a><font color="#B22222">  This routine is a no-op if `device` is already attached to `dctx`.</font>

<a name="line282">282: </a><font color="#B22222">  This routine may (but is very unlikely to) initialize the backend device and may incur</font>
<a name="line283">283: </a><font color="#B22222">  synchronization.</font>

<a name="line285">285: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceCreate.html">PetscDeviceCreate</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceConfigure.html">PetscDeviceConfigure</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextGetDevice.html">PetscDeviceContextGetDevice</a>()`,</font>
<a name="line286">286: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextGetDeviceType.html">PetscDeviceContextGetDeviceType</a>()`</font>
<a name="line287">287: </a><font color="#B22222">@*/</font>
<a name="line288">288: </a><strong><font color="#4169E1"><a name="PetscDeviceContextSetDevice"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextSetDevice.html">PetscDeviceContextSetDevice</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a> device)</font></strong>
<a name="line289">289: </a>{
<a name="line290">290: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line291">291: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextSetDevice_Private(dctx, device, <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_TRUE</a>));
<a name="line292">292: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line293">293: </a>}

<a name="line295">295: </a><font color="#B22222">/*@C</font>
<a name="line296">296: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextGetDevice.html">PetscDeviceContextGetDevice</a> - Get the underlying `<a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>` for a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line298">298: </a><font color="#B22222">  Not Collective</font>

<a name="line300">300: </a><font color="#B22222">  Input Parameter:</font>
<a name="line301">301: </a><font color="#B22222">. dctx - the `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line303">303: </a><font color="#B22222">  Output Parameter:</font>
<a name="line304">304: </a><font color="#B22222">. device - The `<a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>`</font>

<a name="line306">306: </a><font color="#B22222">  Level: intermediate</font>

<a name="line308">308: </a><font color="#B22222">  Note:</font>
<a name="line309">309: </a><font color="#B22222">  This is a borrowed reference, the user should not destroy `device`.</font>

<a name="line311">311: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetDevice.html">PetscDeviceContextSetDevice</a>()`, `<a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextGetDeviceType.html">PetscDeviceContextGetDeviceType</a>()`</font>
<a name="line312">312: </a><font color="#B22222">@*/</font>
<a name="line313">313: </a><strong><font color="#4169E1"><a name="PetscDeviceContextGetDevice"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextGetDevice.html">PetscDeviceContextGetDevice</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a> *device)</font></strong>
<a name="line314">314: </a>{
<a name="line315">315: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line316">316: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line318">318: </a>  <a href="../../../../../manualpages/Sys/PetscAssert.html">PetscAssert</a>(dctx-&gt;device, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONGSTATE</a>, <font color="#666666">"<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> %"</font> PetscInt64_FMT <font color="#666666">" has no attached <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a> to get"</font>, PetscObjectCast(dctx)-&gt;id);
<a name="line319">319: </a>  *device = dctx-&gt;device;
<a name="line320">320: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line321">321: </a>}

<a name="line323">323: </a><font color="#B22222">/*@C</font>
<a name="line324">324: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextGetDeviceType.html">PetscDeviceContextGetDeviceType</a> - Get the `<a href="../../../../../manualpages/Sys/PetscDeviceType.html">PetscDeviceType</a>` for a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line326">326: </a><font color="#B22222">  Not Collective</font>

<a name="line328">328: </a><font color="#B22222">  Input Parameter:</font>
<a name="line329">329: </a><font color="#B22222">. dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line331">331: </a><font color="#B22222">  Output Parameter:</font>
<a name="line332">332: </a><font color="#B22222">. type - The `<a href="../../../../../manualpages/Sys/PetscDeviceType.html">PetscDeviceType</a>`</font>

<a name="line334">334: </a><font color="#B22222">  Level: beginner</font>

<a name="line336">336: </a><font color="#B22222">  Note:</font>
<a name="line337">337: </a><font color="#B22222">  This routine is a convenience shorthand for `<a href="../../../../../manualpages/Sys/PetscDeviceContextGetDevice.html">PetscDeviceContextGetDevice</a>()` -&gt;</font>
<a name="line338">338: </a><font color="#B22222">  `<a href="../../../../../manualpages/Sys/PetscDeviceGetType.html">PetscDeviceGetType</a>()`.</font>

<a name="line340">340: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceType.html">PetscDeviceType</a>`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextGetDevice.html">PetscDeviceContextGetDevice</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceGetType.html">PetscDeviceGetType</a>()`, `<a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>`</font>
<a name="line341">341: </a><font color="#B22222">@*/</font>
<a name="line342">342: </a><strong><font color="#4169E1"><a name="PetscDeviceContextGetDeviceType"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextGetDeviceType.html">PetscDeviceContextGetDeviceType</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscDeviceType.html">PetscDeviceType</a> *type)</font></strong>
<a name="line343">343: </a>{
<a name="line344">344: </a>  <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a> device = nullptr;

<a name="line346">346: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line347">347: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line349">349: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextGetDevice.html">PetscDeviceContextGetDevice</a>(dctx, &amp;device));
<a name="line350">350: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceGetType.html">PetscDeviceGetType</a>(device, type));
<a name="line351">351: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line352">352: </a>}

<a name="line354">354: </a><font color="#B22222">/*@C</font>
<a name="line355">355: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextSetUp.html">PetscDeviceContextSetUp</a> - Prepares a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` for use</font>

<a name="line357">357: </a><font color="#B22222">  Not Collective</font>

<a name="line359">359: </a><font color="#B22222">  Input Parameter:</font>
<a name="line360">360: </a><font color="#B22222">. dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line362">362: </a><font color="#B22222">  Level: beginner</font>

<a name="line364">364: </a><font color="#B22222">  Developer Note:</font>
<a name="line365">365: </a><font color="#B22222">  This routine is usually the stage where a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` acquires device-side data</font>
<a name="line366">366: </a><font color="#B22222">  structures such as streams, events, and (possibly) handles.</font>

<a name="line368">368: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetDevice.html">PetscDeviceContextSetDevice</a>()`,</font>
<a name="line369">369: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextDestroy.html">PetscDeviceContextDestroy</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetFromOptions.html">PetscDeviceContextSetFromOptions</a>()`</font>
<a name="line370">370: </a><font color="#B22222">@*/</font>
<a name="line371">371: </a><strong><font color="#4169E1"><a name="PetscDeviceContextSetUp"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextSetUp.html">PetscDeviceContextSetUp</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx)</font></strong>
<a name="line372">372: </a>{
<a name="line373">373: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line374">374: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line375">375: </a>  <font color="#4169E1">if</font> (dctx-&gt;setup) <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line376">376: </a>  <font color="#4169E1">if</font> (!dctx-&gt;device) {
<a name="line377">377: </a>    const auto default_dtype = <a href="../../../../../manualpages/Sys/PETSC_DEVICE_DEFAULT.html">PETSC_DEVICE_DEFAULT</a>();

<a name="line379">379: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscInfo.html">PetscInfo</a>(dctx, <font color="#666666">"<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> %"</font> PetscInt64_FMT <font color="#666666">" did not have an explicitly attached <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>, using default with type %s\n"</font>, PetscObjectCast(dctx)-&gt;id, PetscDeviceTypes[default_dtype]));
<a name="line380">380: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextSetDefaultDeviceForType_Internal(dctx, default_dtype));
<a name="line381">381: </a>  }
<a name="line382">382: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_SetUp, dctx, nullptr, nullptr, nullptr));
<a name="line383">383: </a>  <a href="../../../../../manualpages/Sys/PetscUseTypeMethod.html">PetscUseTypeMethod</a>(dctx, setup);
<a name="line384">384: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_SetUp, dctx, nullptr, nullptr, nullptr));
<a name="line385">385: </a>  dctx-&gt;setup = <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_TRUE</a>;
<a name="line386">386: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line387">387: </a>}

<a name="line389">389: </a><strong><font color="#4169E1"><a name="PetscDeviceContextDuplicate_Private"></a>static <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> PetscDeviceContextDuplicate_Private(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a> stype, <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> *dctxdup)</font></strong>
<a name="line390">390: </a>{
<a name="line391">391: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line392">392: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_Duplicate, dctx, nullptr, nullptr, nullptr));
<a name="line393">393: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>(dctxdup));
<a name="line394">394: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a>(*dctxdup, stype));
<a name="line395">395: </a>  <font color="#4169E1">if</font> (const auto device = dctx-&gt;device) <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextSetDevice_Private(*dctxdup, device, dctx-&gt;usersetdevice));
<a name="line396">396: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextSetUp.html">PetscDeviceContextSetUp</a>(*dctxdup));
<a name="line397">397: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_Duplicate, dctx, nullptr, nullptr, nullptr));
<a name="line398">398: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line399">399: </a>}

<a name="line401">401: </a><font color="#B22222">/*@C</font>
<a name="line402">402: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextDuplicate.html">PetscDeviceContextDuplicate</a> - Duplicates a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` object</font>

<a name="line404">404: </a><font color="#B22222">  Not Collective</font>

<a name="line406">406: </a><font color="#B22222">  Input Parameter:</font>
<a name="line407">407: </a><font color="#B22222">. dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` to duplicate</font>

<a name="line409">409: </a><font color="#B22222">  Output Parameter:</font>
<a name="line410">410: </a><font color="#B22222">. dctxdup - The duplicated `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line412">412: </a><font color="#B22222">  Level: beginner</font>

<a name="line414">414: </a><font color="#B22222">  Notes:</font>
<a name="line415">415: </a><font color="#B22222">  This is a shorthand method for creating a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` with the exact same settings as</font>
<a name="line416">416: </a><font color="#B22222">  another. Note however that `dctxdup` does not share any of the underlying data with `dctx`,</font>
<a name="line417">417: </a><font color="#B22222">  (including its current stream-state) they are completely separate objects.</font>

<a name="line419">419: </a><font color="#B22222">  There is no implied ordering between `dctx` or `dctxdup`.</font>

<a name="line421">421: </a><font color="#B22222">  DAG representation:</font>
<a name="line422">422: </a><font color="#B22222">.vb</font>
<a name="line423">423: </a><font color="#B22222">  time -&gt;</font>

<a name="line425">425: </a><font color="#B22222">  -&gt; dctx - |= CALL =| - dctx ----&gt;</font>
<a name="line426">426: </a><font color="#B22222">                       - dctxdup -&gt;</font>
<a name="line427">427: </a><font color="#B22222">.ve</font>

<a name="line429">429: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetDevice.html">PetscDeviceContextSetDevice</a>()`,</font>
<a name="line430">430: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a>()`</font>
<a name="line431">431: </a><font color="#B22222">@*/</font>
<a name="line432">432: </a><strong><font color="#4169E1"><a name="PetscDeviceContextDuplicate"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextDuplicate.html">PetscDeviceContextDuplicate</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> *dctxdup)</font></strong>
<a name="line433">433: </a>{
<a name="line434">434: </a>  auto stype = <a href="../../../../../manualpages/Sys/PetscStreamType.html">PETSC_STREAM_DEFAULT_BLOCKING</a>;

<a name="line436">436: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line437">437: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line439">439: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextGetStreamType.html">PetscDeviceContextGetStreamType</a>(dctx, &amp;stype));
<a name="line440">440: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextDuplicate_Private(dctx, stype, dctxdup));
<a name="line441">441: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line442">442: </a>}

<a name="line444">444: </a><font color="#B22222">/*@C</font>
<a name="line445">445: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextQueryIdle.html">PetscDeviceContextQueryIdle</a> - Returns whether or not a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` is idle</font>

<a name="line447">447: </a><font color="#B22222">  Not Collective</font>

<a name="line449">449: </a><font color="#B22222">  Input Parameter:</font>
<a name="line450">450: </a><font color="#B22222">. dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line452">452: </a><font color="#B22222">  Output Parameter:</font>
<a name="line453">453: </a><font color="#B22222">. idle - `<a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_TRUE</a>` if `dctx` has NO work, `<a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_FALSE</a>` if it has work</font>

<a name="line455">455: </a><font color="#B22222">  Level: intermediate</font>

<a name="line457">457: </a><font color="#B22222">  Note:</font>
<a name="line458">458: </a><font color="#B22222">  This routine only refers a singular context and does NOT take any of its children into</font>
<a name="line459">459: </a><font color="#B22222">  account. That is, if `dctx` is idle but has dependents who do have work this routine still</font>
<a name="line460">460: </a><font color="#B22222">  returns `<a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_TRUE</a>`.</font>

<a name="line462">462: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextWaitForContext.html">PetscDeviceContextWaitForContext</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextFork.html">PetscDeviceContextFork</a>()`</font>
<a name="line463">463: </a><font color="#B22222">@*/</font>
<a name="line464">464: </a><strong><font color="#4169E1"><a name="PetscDeviceContextQueryIdle"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextQueryIdle.html">PetscDeviceContextQueryIdle</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscBool.html">PetscBool</a> *idle)</font></strong>
<a name="line465">465: </a>{
<a name="line466">466: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line467">467: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line469">469: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_QueryIdle, dctx, nullptr, nullptr, nullptr));
<a name="line470">470: </a>  <a href="../../../../../manualpages/Sys/PetscUseTypeMethod.html">PetscUseTypeMethod</a>(dctx, query, idle);
<a name="line471">471: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_QueryIdle, dctx, nullptr, nullptr, nullptr));
<a name="line472">472: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscInfo.html">PetscInfo</a>(dctx, <font color="#666666">"<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> ('%s', id %"</font> PetscInt64_FMT <font color="#666666">") %s idle\n"</font>, PetscObjectCast(dctx)-&gt;name ? PetscObjectCast(dctx)-&gt;name : <font color="#666666">"unnamed"</font>, PetscObjectCast(dctx)-&gt;id, *idle ? <font color="#666666">"was"</font> : <font color="#666666">"was not"</font>));
<a name="line473">473: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line474">474: </a>}

<a name="line476">476: </a><font color="#B22222">/*@C</font>
<a name="line477">477: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextWaitForContext.html">PetscDeviceContextWaitForContext</a> - Make one context wait for another context to finish</font>

<a name="line479">479: </a><font color="#B22222">  Not Collective</font>

<a name="line481">481: </a><font color="#B22222">  Input Parameters:</font>
<a name="line482">482: </a><font color="#B22222">+ dctxa - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` object that is waiting</font>
<a name="line483">483: </a><font color="#B22222">- dctxb - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` object that is being waited on</font>

<a name="line485">485: </a><font color="#B22222">  Level: beginner</font>

<a name="line487">487: </a><font color="#B22222">  Notes:</font>
<a name="line488">488: </a><font color="#B22222">  Serializes two `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`s. Serialization is performed asynchronously; the host</font>
<a name="line489">489: </a><font color="#B22222">  does not wait for the serialization to actually occur.</font>

<a name="line491">491: </a><font color="#B22222">  This routine uses only the state of `dctxb` at the moment this routine was called, so any</font>
<a name="line492">492: </a><font color="#B22222">  future work queued will not affect `dctxa`. It is safe to pass the same context to both</font>
<a name="line493">493: </a><font color="#B22222">  arguments (in which case this routine does nothing).</font>

<a name="line495">495: </a><font color="#B22222">  DAG representation:</font>
<a name="line496">496: </a><font color="#B22222">.vb</font>
<a name="line497">497: </a><font color="#B22222">  time -&gt;</font>

<a name="line499">499: </a><font color="#B22222">  -&gt; dctxa ---/- |= CALL =| - dctxa -&gt;</font>
<a name="line500">500: </a><font color="#B22222">             /</font>
<a name="line501">501: </a><font color="#B22222">  -&gt; dctxb -/------------------------&gt;</font>
<a name="line502">502: </a><font color="#B22222">.ve</font>

<a name="line504">504: </a><font color="#B22222">.N ASYNC_API</font>

<a name="line506">506: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextQueryIdle.html">PetscDeviceContextQueryIdle</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoin.html">PetscDeviceContextJoin</a>()`</font>
<a name="line507">507: </a><font color="#B22222">@*/</font>
<a name="line508">508: </a><strong><font color="#4169E1"><a name="PetscDeviceContextWaitForContext"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextWaitForContext.html">PetscDeviceContextWaitForContext</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctxa, <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctxb)</font></strong>
<a name="line509">509: </a>{
<a name="line510">510: </a>  <a href="../../../../../manualpages/Sys/PetscObject.html">PetscObject</a> aobj;

<a name="line512">512: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line513">513: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctxa));
<a name="line514">514: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctxb));
<a name="line515">515: </a>  PetscCheckCompatibleDeviceContexts(dctxa, 1, dctxb, 2);
<a name="line516">516: </a>  <font color="#4169E1">if</font> (dctxa == dctxb) <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line517">517: </a>  aobj = PetscObjectCast(dctxa);
<a name="line518">518: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_WaitForCtx, dctxa, dctxb, nullptr, nullptr));
<a name="line519">519: </a>  <a href="../../../../../manualpages/Sys/PetscUseTypeMethod.html">PetscUseTypeMethod</a>(dctxa, waitforcontext, dctxb);
<a name="line520">520: </a>  <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(CxxDataCast(dctxa)-&gt;upstream[dctxb] = CxxDataParent(dctxb));
<a name="line521">521: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_WaitForCtx, dctxa, dctxb, nullptr, nullptr));
<a name="line522">522: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscInfo.html">PetscInfo</a>(dctxa, <font color="#666666">"dctx %"</font> PetscInt64_FMT <font color="#666666">" waiting on dctx %"</font> PetscInt64_FMT <font color="#666666">"\n"</font>, aobj-&gt;id, PetscObjectCast(dctxb)-&gt;id));
<a name="line523">523: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscObjectStateIncrease.html">PetscObjectStateIncrease</a>(aobj));
<a name="line524">524: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line525">525: </a>}

<a name="line527">527: </a><font color="#B22222">/*@C</font>
<a name="line528">528: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextForkWithStreamType.html">PetscDeviceContextForkWithStreamType</a> - Create a set of dependent child contexts from a parent</font>
<a name="line529">529: </a><font color="#B22222">  context with a prescribed `<a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a>`</font>

<a name="line531">531: </a><font color="#B22222">  Not Collective, Asynchronous</font>

<a name="line533">533: </a><font color="#B22222">  Input Parameters:</font>
<a name="line534">534: </a><font color="#B22222">+ dctx  - The parent `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>
<a name="line535">535: </a><font color="#B22222">. stype - The prescribed `<a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a>`</font>
<a name="line536">536: </a><font color="#B22222">- n     - The number of children to create</font>

<a name="line538">538: </a><font color="#B22222">  Output Parameter:</font>
<a name="line539">539: </a><font color="#B22222">. dsub - The created child context(s)</font>

<a name="line541">541: </a><font color="#B22222">  Level: intermediate</font>

<a name="line543">543: </a><font color="#B22222">  Notes:</font>
<a name="line544">544: </a><font color="#B22222">  This routine creates `n` edges of a DAG from a source node which are causally dependent on the</font>
<a name="line545">545: </a><font color="#B22222">  source node. This causal dependency is established as-if by calling</font>
<a name="line546">546: </a><font color="#B22222">  `<a href="../../../../../manualpages/Sys/PetscDeviceContextWaitForContext.html">PetscDeviceContextWaitForContext</a>()` on every child.</font>

<a name="line548">548: </a><font color="#B22222">  `dsub` is allocated by this routine and has its lifetime bounded by `dctx`. That is, `dctx`</font>
<a name="line549">549: </a><font color="#B22222">  expects to free `dsub` (via `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoin.html">PetscDeviceContextJoin</a>()`) before it itself is destroyed.</font>

<a name="line551">551: </a><font color="#B22222">  This routine only accounts for work queued on `dctx` up until calling this routine, any</font>
<a name="line552">552: </a><font color="#B22222">  subsequent work enqueued on `dctx` has no effect on `dsub`.</font>

<a name="line554">554: </a><font color="#B22222">  The `<a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a>` of `dctx` does not have to equal `stype`. In fact, it is often the case</font>
<a name="line555">555: </a><font color="#B22222">  that they are different. This is useful in cases where a routine can locally exploit stream</font>
<a name="line556">556: </a><font color="#B22222">  parallelism without needing to worry about what stream type the incoming `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>
<a name="line557">557: </a><font color="#B22222">  carries.</font>

<a name="line559">559: </a><font color="#B22222">  DAG representation:</font>
<a name="line560">560: </a><font color="#B22222">.vb</font>
<a name="line561">561: </a><font color="#B22222">  time -&gt;</font>

<a name="line563">563: </a><font color="#B22222">  -&gt; dctx - |= CALL =| -\----&gt; dctx ------&gt;</font>
<a name="line564">564: </a><font color="#B22222">                         \---&gt; dsub[0] ---&gt;</font>
<a name="line565">565: </a><font color="#B22222">                          \--&gt; ... -------&gt;</font>
<a name="line566">566: </a><font color="#B22222">                           \-&gt; dsub[n-1] -&gt;</font>
<a name="line567">567: </a><font color="#B22222">.ve</font>

<a name="line569">569: </a><font color="#B22222">.N ASYNC_API</font>

<a name="line571">571: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoin.html">PetscDeviceContextJoin</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSynchronize.html">PetscDeviceContextSynchronize</a>()`,</font>
<a name="line572">572: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextQueryIdle.html">PetscDeviceContextQueryIdle</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextWaitForContext.html">PetscDeviceContextWaitForContext</a>()`</font>
<a name="line573">573: </a><font color="#B22222">@*/</font>
<a name="line574">574: </a><strong><font color="#4169E1"><a name="PetscDeviceContextForkWithStreamType"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextForkWithStreamType.html">PetscDeviceContextForkWithStreamType</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a> stype, <a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> n, <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> **dsub)</font></strong>
<a name="line575">575: </a>{
<a name="line576">576: </a>  // debugging only
<a name="line577">577: </a><strong><font color="#FF0000">  std:</font></strong>:string idList;
<a name="line578">578: </a>  auto        ninput = n;

<a name="line580">580: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line581">581: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line582">582: </a>  <a href="../../../../../manualpages/Sys/PetscAssert.html">PetscAssert</a>(n &gt;= 0, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_OUTOFRANGE</a>, <font color="#666666">"Number of contexts requested %"</font> PetscInt_FMT <font color="#666666">" &lt; 0"</font>, n);
<a name="line584">584: </a>  *dsub = nullptr;
<a name="line585">585: </a>  <font color="#B22222">/* reserve 4 chars per id, 2 for number and 2 for ', ' separator */</font>
<a name="line586">586: </a>  <font color="#4169E1">if</font> (<a href="../../../../../manualpages/Sys/PetscDefined.html">PetscDefined</a>(USE_DEBUG_AND_INFO)) <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(idList.reserve(4 * n));
<a name="line587">587: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_Fork, dctx, nullptr, nullptr, nullptr));
<a name="line588">588: </a>  <font color="#B22222">/* update child totals */</font>
<a name="line589">589: </a>  dctx-&gt;numChildren += n;
<a name="line590">590: </a>  <font color="#B22222">/* now to find out if we have room */</font>
<a name="line591">591: </a>  <font color="#4169E1">if</font> (dctx-&gt;numChildren &gt; dctx-&gt;maxNumChildren) {
<a name="line592">592: </a>    const auto numChildren    = dctx-&gt;numChildren;
<a name="line593">593: </a>    auto      &amp;maxNumChildren = dctx-&gt;maxNumChildren;
<a name="line594">594: </a>    auto       numAllocated   = numChildren;

<a name="line596">596: </a>    <font color="#B22222">/* no room, either from having too many kids or not having any */</font>
<a name="line597">597: </a>    <font color="#4169E1">if</font> (auto &amp;childIDs = dctx-&gt;childIDs) {
<a name="line598">598: </a>      // the difference is backwards because we have not updated maxNumChildren yet
<a name="line599">599: </a>      numAllocated -= maxNumChildren;
<a name="line600">600: </a>      <font color="#B22222">/* have existing children, must reallocate them */</font>
<a name="line601">601: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscRealloc.html">PetscRealloc</a>(numChildren * <font color="#4169E1">sizeof</font>(*childIDs), &amp;childIDs));
<a name="line602">602: </a>      <font color="#B22222">/* clear the extra memory since realloc doesn't do it for us */</font>
<a name="line603">603: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscArrayzero.html">PetscArrayzero</a>(std::next(childIDs, maxNumChildren), numAllocated));
<a name="line604">604: </a>    } <font color="#4169E1">else</font> {
<a name="line605">605: </a>      <font color="#B22222">/* have no children */</font>
<a name="line606">606: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscCalloc1.html">PetscCalloc1</a>(numChildren, &amp;childIDs));
<a name="line607">607: </a>    }
<a name="line608">608: </a>    <font color="#B22222">/* update total number of children */</font>
<a name="line609">609: </a>    maxNumChildren = numChildren;
<a name="line610">610: </a>  }
<a name="line611">611: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscMalloc1.html">PetscMalloc1</a>(n, dsub));
<a name="line612">612: </a>  <font color="#4169E1">for</font> (<a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> i = 0; ninput &amp;&amp; (i &lt; dctx-&gt;numChildren); ++i) {
<a name="line613">613: </a>    auto &amp;childID = dctx-&gt;childIDs[i];
<a name="line614">614: </a>    <font color="#B22222">/* empty child slot */</font>
<a name="line615">615: </a>    <font color="#4169E1">if</font> (!childID) {
<a name="line616">616: </a>      auto &amp;childctx = (*dsub)[i];

<a name="line618">618: </a>      <font color="#B22222">/* create the child context in the image of its parent */</font>
<a name="line619">619: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextDuplicate_Private(dctx, stype, &amp;childctx));
<a name="line620">620: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextWaitForContext.html">PetscDeviceContextWaitForContext</a>(childctx, dctx));
<a name="line621">621: </a>      <font color="#B22222">/* register the child with its parent */</font>
<a name="line622">622: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscObjectGetId.html">PetscObjectGetId</a>(PetscObjectCast(childctx), &amp;childID));
<a name="line623">623: </a>      <font color="#4169E1">if</font> (<a href="../../../../../manualpages/Sys/PetscDefined.html">PetscDefined</a>(USE_DEBUG_AND_INFO)) {
<a name="line624">624: </a>        <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(idList += std::to_string(childID));
<a name="line625">625: </a>        <font color="#4169E1">if</font> (ninput != 1) <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(idList += <font color="#666666">", "</font>);
<a name="line626">626: </a>      }
<a name="line627">627: </a>      --ninput;
<a name="line628">628: </a>    }
<a name="line629">629: </a>  }
<a name="line630">630: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_Fork, dctx, nullptr, nullptr, nullptr));
<a name="line631">631: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDebugInfo(dctx, <font color="#666666">"Forked %"</font> PetscInt_FMT <font color="#666666">" children from parent %"</font> PetscInt64_FMT <font color="#666666">" with IDs: %s\n"</font>, n, PetscObjectCast(dctx)-&gt;id, idList.c_str()));
<a name="line632">632: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line633">633: </a>}

<a name="line635">635: </a><font color="#B22222">/*@C</font>
<a name="line636">636: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextFork.html">PetscDeviceContextFork</a> - Create a set of dependent child contexts from a parent context</font>

<a name="line638">638: </a><font color="#B22222">  Not Collective, Asynchronous</font>

<a name="line640">640: </a><font color="#B22222">  Input Parameters:</font>
<a name="line641">641: </a><font color="#B22222">+ dctx - The parent `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>
<a name="line642">642: </a><font color="#B22222">- n    - The number of children to create</font>

<a name="line644">644: </a><font color="#B22222">  Output Parameter:</font>
<a name="line645">645: </a><font color="#B22222">. dsub - The created child context(s)</font>

<a name="line647">647: </a><font color="#B22222">  Level: beginner</font>

<a name="line649">649: </a><font color="#B22222">  Notes:</font>
<a name="line650">650: </a><font color="#B22222">  Behaves identically to `<a href="../../../../../manualpages/Sys/PetscDeviceContextForkWithStreamType.html">PetscDeviceContextForkWithStreamType</a>()` except that the prescribed</font>
<a name="line651">651: </a><font color="#B22222">  `<a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a>` is taken from `dctx`. In effect this routine is shorthand for\:</font>

<a name="line653">653: </a><font color="#B22222">.vb</font>
<a name="line654">654: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscStreamType.html">PetscStreamType</a> stype;</font>

<a name="line656">656: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextGetStreamType.html">PetscDeviceContextGetStreamType</a>(dctx, &amp;stype);</font>
<a name="line657">657: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextForkWithStreamType.html">PetscDeviceContextForkWithStreamType</a>(dctx, stype, ...);</font>
<a name="line658">658: </a><font color="#B22222">.ve</font>

<a name="line660">660: </a><font color="#B22222">.N ASYNC_API</font>

<a name="line662">662: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextForkWithStreamType.html">PetscDeviceContextForkWithStreamType</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoin.html">PetscDeviceContextJoin</a>()`,</font>
<a name="line663">663: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextSynchronize.html">PetscDeviceContextSynchronize</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextQueryIdle.html">PetscDeviceContextQueryIdle</a>()`</font>
<a name="line664">664: </a><font color="#B22222">@*/</font>
<a name="line665">665: </a><strong><font color="#4169E1"><a name="PetscDeviceContextFork"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextFork.html">PetscDeviceContextFork</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> n, <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> **dsub)</font></strong>
<a name="line666">666: </a>{
<a name="line667">667: </a>  auto stype = <a href="../../../../../manualpages/Sys/PetscStreamType.html">PETSC_STREAM_DEFAULT_BLOCKING</a>;

<a name="line669">669: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line670">670: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line671">671: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextGetStreamType.html">PetscDeviceContextGetStreamType</a>(dctx, &amp;stype));
<a name="line672">672: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextForkWithStreamType.html">PetscDeviceContextForkWithStreamType</a>(dctx, stype, n, dsub));
<a name="line673">673: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line674">674: </a>}

<a name="line676">676: </a><font color="#B22222">/*@C</font>
<a name="line677">677: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextJoin.html">PetscDeviceContextJoin</a> - Converge a set of child contexts</font>

<a name="line679">679: </a><font color="#B22222">  Not Collective, Asynchronous</font>

<a name="line681">681: </a><font color="#B22222">  Input Parameters:</font>
<a name="line682">682: </a><font color="#B22222">+ dctx         - A `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` to converge on</font>
<a name="line683">683: </a><font color="#B22222">. n            - The number of sub contexts to converge</font>
<a name="line684">684: </a><font color="#B22222">. joinMode     - The type of join to perform</font>
<a name="line685">685: </a><font color="#B22222">- dsub         - The sub contexts to converge</font>

<a name="line687">687: </a><font color="#B22222">  Level: beginner</font>

<a name="line689">689: </a><font color="#B22222">  Notes:</font>
<a name="line690">690: </a><font color="#B22222">  If `<a href="../../../../../manualpages/Sys/PetscDeviceContextFork.html">PetscDeviceContextFork</a>()` creates `n` edges from a source node which all depend on the source</font>
<a name="line691">691: </a><font color="#B22222">  node, then this routine is the exact mirror. That is, it creates a node (represented in `dctx`)</font>
<a name="line692">692: </a><font color="#B22222">  which receives `n` edges (and optionally destroys them) which is dependent on the completion</font>
<a name="line693">693: </a><font color="#B22222">  of all incoming edges.</font>

<a name="line695">695: </a><font color="#B22222">  If `joinMode` is `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PETSC_DEVICE_CONTEXT_JOIN_DESTROY</a>`. All contexts in `dsub` will be</font>
<a name="line696">696: </a><font color="#B22222">  destroyed by this routine. Thus all sub contexts must have been created with the `dctx`</font>
<a name="line697">697: </a><font color="#B22222">  passed to this routine.</font>

<a name="line699">699: </a><font color="#B22222">  If `joinMode` is `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PETSC_DEVICE_CONTEXT_JOIN_SYNC</a>`. All sub contexts will additionally wait on</font>
<a name="line700">700: </a><font color="#B22222">  `dctx` after converging. This has the effect of "synchronizing" the outgoing edges. Note the</font>
<a name="line701">701: </a><font color="#B22222">  sync suffix does NOT refer to the host, i.e. this routine does NOT call</font>
<a name="line702">702: </a><font color="#B22222">  `PetscDeviceSynchronize()`.</font>

<a name="line704">704: </a><font color="#B22222">  If `joinMode` is `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PETSC_DEVICE_CONTEXT_JOIN_NO_SYNC</a>`. `dctx` waits for all sub contexts but</font>
<a name="line705">705: </a><font color="#B22222">  the sub contexts do not wait for one another or `dctx` afterwards.</font>

<a name="line707">707: </a><font color="#B22222">  DAG representations:</font>
<a name="line708">708: </a><font color="#B22222">  If `joinMode` is `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PETSC_DEVICE_CONTEXT_JOIN_DESTROY</a>`</font>
<a name="line709">709: </a><font color="#B22222">.vb</font>
<a name="line710">710: </a><font color="#B22222">  time -&gt;</font>

<a name="line712">712: </a><font color="#B22222">  -&gt; dctx ---------/- |= CALL =| - dctx -&gt;</font>
<a name="line713">713: </a><font color="#B22222">  -&gt; dsub[0] -----/</font>
<a name="line714">714: </a><font color="#B22222">  -&gt;  ... -------/</font>
<a name="line715">715: </a><font color="#B22222">  -&gt; dsub[n-1] -/</font>
<a name="line716">716: </a><font color="#B22222">.ve</font>
<a name="line717">717: </a><font color="#B22222">  If `joinMode` is `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PETSC_DEVICE_CONTEXT_JOIN_SYNC</a>`</font>
<a name="line718">718: </a><font color="#B22222">.vb</font>
<a name="line719">719: </a><font color="#B22222">  time -&gt;</font>

<a name="line721">721: </a><font color="#B22222">  -&gt; dctx ---------/- |= CALL =| -\----&gt; dctx ------&gt;</font>
<a name="line722">722: </a><font color="#B22222">  -&gt; dsub[0] -----/                \---&gt; dsub[0] ---&gt;</font>
<a name="line723">723: </a><font color="#B22222">  -&gt;  ... -------/                  \--&gt; ... -------&gt;</font>
<a name="line724">724: </a><font color="#B22222">  -&gt; dsub[n-1] -/                    \-&gt; dsub[n-1] -&gt;</font>
<a name="line725">725: </a><font color="#B22222">.ve</font>
<a name="line726">726: </a><font color="#B22222">  If `joinMode` is `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PETSC_DEVICE_CONTEXT_JOIN_NO_SYNC</a>`</font>
<a name="line727">727: </a><font color="#B22222">.vb</font>
<a name="line728">728: </a><font color="#B22222">  time -&gt;</font>

<a name="line730">730: </a><font color="#B22222">  -&gt; dctx ----------/- |= CALL =| - dctx -&gt;</font>
<a name="line731">731: </a><font color="#B22222">  -&gt; dsub[0] ------/-----------------------&gt;</font>
<a name="line732">732: </a><font color="#B22222">  -&gt;  ... --------/------------------------&gt;</font>
<a name="line733">733: </a><font color="#B22222">  -&gt; dsub[n-1] --/-------------------------&gt;</font>
<a name="line734">734: </a><font color="#B22222">.ve</font>

<a name="line736">736: </a><font color="#B22222">.N ASYNC_API</font>

<a name="line738">738: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextFork.html">PetscDeviceContextFork</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextForkWithStreamType.html">PetscDeviceContextForkWithStreamType</a>()`,</font>
<a name="line739">739: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextSynchronize.html">PetscDeviceContextSynchronize</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PetscDeviceContextJoinMode</a>`</font>
<a name="line740">740: </a><font color="#B22222">@*/</font>
<a name="line741">741: </a><strong><font color="#4169E1"><a name="PetscDeviceContextJoin"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextJoin.html">PetscDeviceContextJoin</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> n, <a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PetscDeviceContextJoinMode</a> joinMode, <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> **dsub)</font></strong>
<a name="line742">742: </a>{
<a name="line743">743: </a>  // debugging only
<a name="line744">744: </a><strong><font color="#FF0000">  std:</font></strong>:string idList;

<a name="line746">746: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line747">747: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line748">748: </a>  <font color="#B22222">/* validity of dctx is checked in the wait-for loop */</font>
<a name="line750">750: </a>  <a href="../../../../../manualpages/Sys/PetscAssert.html">PetscAssert</a>(n &gt;= 0, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_OUTOFRANGE</a>, <font color="#666666">"Number of contexts merged %"</font> PetscInt_FMT <font color="#666666">" &lt; 0"</font>, n);
<a name="line751">751: </a>  <font color="#B22222">/* reserve 4 chars per id, 2 for number and 2 for ', ' separator */</font>
<a name="line752">752: </a>  <font color="#4169E1">if</font> (<a href="../../../../../manualpages/Sys/PetscDefined.html">PetscDefined</a>(USE_DEBUG_AND_INFO)) <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(idList.reserve(4 * n));
<a name="line753">753: </a>  <font color="#B22222">/* first dctx waits on all the incoming edges */</font>
<a name="line754">754: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_Join, dctx, nullptr, nullptr, nullptr));
<a name="line755">755: </a>  <font color="#4169E1">for</font> (<a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> i = 0; i &lt; n; ++i) {
<a name="line756">756: </a>    PetscCheckCompatibleDeviceContexts(dctx, 1, (*dsub)[i], 4);
<a name="line757">757: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextWaitForContext.html">PetscDeviceContextWaitForContext</a>(dctx, (*dsub)[i]));
<a name="line758">758: </a>    <font color="#4169E1">if</font> (<a href="../../../../../manualpages/Sys/PetscDefined.html">PetscDefined</a>(USE_DEBUG_AND_INFO)) {
<a name="line759">759: </a>      <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(idList += std::to_string(PetscObjectCast((*dsub)[i])-&gt;id));
<a name="line760">760: </a>      <font color="#4169E1">if</font> (i + 1 &lt; n) <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(idList += <font color="#666666">", "</font>);
<a name="line761">761: </a>    }
<a name="line762">762: </a>  }

<a name="line764">764: </a>  <font color="#B22222">/* now we handle the aftermath */</font>
<a name="line765">765: </a>  <font color="#4169E1">switch</font> (joinMode) {
<a name="line766">766: </a>  <font color="#4169E1">case</font> <a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PETSC_DEVICE_CONTEXT_JOIN_DESTROY</a>: {
<a name="line767">767: </a>    const auto children = dctx-&gt;childIDs;
<a name="line768">768: </a>    const auto maxchild = dctx-&gt;maxNumChildren;
<a name="line769">769: </a>    auto      &amp;nchild   = dctx-&gt;numChildren;
<a name="line770">770: </a>    <a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a>   j        = 0;

<a name="line772">772: </a>    <a href="../../../../../manualpages/Sys/PetscCheck.html">PetscCheck</a>(n &lt;= nchild, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_OUTOFRANGE</a>, <font color="#666666">"Trying to destroy %"</font> PetscInt_FMT <font color="#666666">" children of a parent context that only has %"</font> PetscInt_FMT <font color="#666666">" children, likely trying to restore to wrong parent"</font>, n, nchild);
<a name="line773">773: </a>    <font color="#B22222">/* update child count while it's still fresh in memory */</font>
<a name="line774">774: </a>    nchild -= n;
<a name="line775">775: </a>    <font color="#4169E1">for</font> (<a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> i = 0; i &lt; maxchild; ++i) {
<a name="line776">776: </a>      <font color="#4169E1">if</font> (children[i] &amp;&amp; (children[i] == PetscObjectCast((*dsub)[j])-&gt;id)) {
<a name="line777">777: </a>        <font color="#B22222">/* child is one of ours, can destroy it */</font>
<a name="line778">778: </a>        <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextDestroy.html">PetscDeviceContextDestroy</a>((*dsub) + j));
<a name="line779">779: </a>        <font color="#B22222">/* reset the child slot */</font>
<a name="line780">780: </a>        children[i] = 0;
<a name="line781">781: </a>        <font color="#4169E1">if</font> (++j == n) <font color="#4169E1">break</font>;
<a name="line782">782: </a>      }
<a name="line783">783: </a>    }
<a name="line784">784: </a>    <font color="#B22222">/* gone through the loop but did not find every child */</font>
<a name="line785">785: </a>    <a href="../../../../../manualpages/Sys/PetscCheck.html">PetscCheck</a>(j == n, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a>, <font color="#666666">"%"</font> PetscInt_FMT <font color="#666666">" contexts still remain after destroy, this may be because you are trying to restore to the wrong parent context, or the device contexts are not in the same order as they were checked out out in"</font>, n - j);
<a name="line786">786: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscFree.html">PetscFree</a>(*dsub));
<a name="line787">787: </a>  } <font color="#4169E1">break</font>;
<a name="line788">788: </a>  <font color="#4169E1">case</font> <a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PETSC_DEVICE_CONTEXT_JOIN_SYNC</a>:
<a name="line789">789: </a>    <font color="#4169E1">for</font> (<a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> i = 0; i &lt; n; ++i) <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextWaitForContext.html">PetscDeviceContextWaitForContext</a>((*dsub)[i], dctx));
<a name="line790">790: </a>  <font color="#4169E1">case</font> <a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PETSC_DEVICE_CONTEXT_JOIN_NO_SYNC</a>:
<a name="line791">791: </a>    <font color="#4169E1">break</font>;
<a name="line792">792: </a><strong><font color="#FF0000">  default:</font></strong>
<a name="line793">793: </a>    <a href="../../../../../manualpages/Sys/SETERRQ.html">SETERRQ</a>(<a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_ARG_WRONG</a>, <font color="#666666">"Unknown <a href="../../../../../manualpages/Sys/PetscDeviceContextJoinMode.html">PetscDeviceContextJoinMode</a> given"</font>);
<a name="line794">794: </a>  }
<a name="line795">795: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_Join, dctx, nullptr, nullptr, nullptr));

<a name="line797">797: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDebugInfo(dctx, <font color="#666666">"Joined %"</font> PetscInt_FMT <font color="#666666">" ctxs to ctx %"</font> PetscInt64_FMT <font color="#666666">", mode %s with IDs: %s\n"</font>, n, PetscObjectCast(dctx)-&gt;id, PetscDeviceContextJoinModes[joinMode], idList.c_str()));
<a name="line798">798: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line799">799: </a>}

<a name="line801">801: </a><font color="#B22222">/*@C</font>
<a name="line802">802: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextSynchronize.html">PetscDeviceContextSynchronize</a> - Block the host until all work queued on a</font>
<a name="line803">803: </a><font color="#B22222">  `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` has finished</font>

<a name="line805">805: </a><font color="#B22222">  Not Collective</font>

<a name="line807">807: </a><font color="#B22222">  Input Parameter:</font>
<a name="line808">808: </a><font color="#B22222">. dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` to synchronize</font>

<a name="line810">810: </a><font color="#B22222">  Level: beginner</font>

<a name="line812">812: </a><font color="#B22222">  Notes:</font>
<a name="line813">813: </a><font color="#B22222">  The host will not return from this routine until `dctx` is idle. Any and all memory</font>
<a name="line814">814: </a><font color="#B22222">  operations queued on or otherwise associated with (either explicitly or implicitly via</font>
<a name="line815">815: </a><font color="#B22222">  dependencies) are guaranteed to have finished and be globally visible on return.</font>

<a name="line817">817: </a><font color="#B22222">  In effect, this routine serves as memory and execution barrier.</font>

<a name="line819">819: </a><font color="#B22222">  DAG representation:</font>
<a name="line820">820: </a><font color="#B22222">.vb</font>
<a name="line821">821: </a><font color="#B22222">  time -&gt;</font>

<a name="line823">823: </a><font color="#B22222">  -&gt; dctx - |= CALL =| - dctx -&gt;</font>
<a name="line824">824: </a><font color="#B22222">.ve</font>

<a name="line826">826: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextFork.html">PetscDeviceContextFork</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextJoin.html">PetscDeviceContextJoin</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextQueryIdle.html">PetscDeviceContextQueryIdle</a>()`</font>
<a name="line827">827: </a><font color="#B22222">@*/</font>
<a name="line828">828: </a><strong><font color="#4169E1"><a name="PetscDeviceContextSynchronize"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextSynchronize.html">PetscDeviceContextSynchronize</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx)</font></strong>
<a name="line829">829: </a>{
<a name="line830">830: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line831">831: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line832">832: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventBegin.html">PetscLogEventBegin</a>(DCONTEXT_Sync, dctx, nullptr, nullptr, nullptr));
<a name="line833">833: </a>  <font color="#B22222">/* if it isn't setup there is nothing to sync on */</font>
<a name="line834">834: </a>  <font color="#4169E1">if</font> (dctx-&gt;setup) {
<a name="line835">835: </a>    <a href="../../../../../manualpages/Sys/PetscUseTypeMethod.html">PetscUseTypeMethod</a>(dctx, synchronize);
<a name="line836">836: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextSyncClearMap_Internal(dctx));
<a name="line837">837: </a>  }
<a name="line838">838: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscLogEventEnd.html">PetscLogEventEnd</a>(DCONTEXT_Sync, dctx, nullptr, nullptr, nullptr));
<a name="line839">839: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line840">840: </a>}

<a name="line842">842: </a><font color="#B22222">/* every device type has a vector of null PetscDeviceContexts -- one for each device */</font>
<a name="line843">843: </a>static auto nullContexts          = std::array&lt;std::vector&lt;<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>&gt;, <a href="../../../../../manualpages/Sys/PetscDeviceType.html">PETSC_DEVICE_MAX</a>&gt;{};
<a name="line844">844: </a>static auto nullContextsFinalizer = false;

<a name="line846">846: </a><strong><font color="#4169E1"><a name="PetscDeviceContextGetNullContextForDevice_Private"></a>static <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> PetscDeviceContextGetNullContextForDevice_Private(<a href="../../../../../manualpages/Sys/PetscBool.html">PetscBool</a> user_set_device, <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a> device, <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> *dctx)</font></strong>
<a name="line847">847: </a>{
<a name="line848">848: </a>  <a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a>        devid;
<a name="line849">849: </a>  <a href="../../../../../manualpages/Sys/PetscDeviceType.html">PetscDeviceType</a> dtype;

<a name="line851">851: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line854">854: </a>  <font color="#4169E1">if</font> (<a href="../../../../../manualpages/Sys/PetscUnlikely.html">PetscUnlikely</a>(!nullContextsFinalizer)) {
<a name="line855">855: </a>    const auto finalizer = [] {
<a name="line856">856: </a>      <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line857">857: </a>      <font color="#4169E1">for</font> (auto &amp;&amp;dvec : nullContexts) {
<a name="line858">858: </a>        <font color="#4169E1">for</font> (auto &amp;&amp;dctx : dvec) <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextDestroy.html">PetscDeviceContextDestroy</a>(&amp;dctx));
<a name="line859">859: </a>        <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(dvec.clear());
<a name="line860">860: </a>      }
<a name="line861">861: </a>      nullContextsFinalizer = false;
<a name="line862">862: </a>      <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line863">863: </a>    };

<a name="line865">865: </a>    nullContextsFinalizer = true;
<a name="line866">866: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscRegisterFinalize.html">PetscRegisterFinalize</a>(std::move(finalizer)));
<a name="line867">867: </a>  }
<a name="line868">868: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceGetDeviceId.html">PetscDeviceGetDeviceId</a>(device, &amp;devid));
<a name="line869">869: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceGetType.html">PetscDeviceGetType</a>(device, &amp;dtype));
<a name="line870">870: </a>  {
<a name="line871">871: </a>    auto &amp;ctxlist = nullContexts[dtype];

<a name="line873">873: </a>    <a href="../../../../../manualpages/Sys/PetscCheck.html">PetscCheck</a>(devid &gt;= 0, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, <a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_ERR_PLIB</a>, <font color="#666666">"Device ID (%"</font> PetscInt_FMT <font color="#666666">") must be positive"</font>, devid);
<a name="line874">874: </a>    // need to resize the container <font color="#4169E1">if</font> not big enough because incrementing the iterator in
<a name="line875">875: </a>    // std::next() (<font color="#4169E1">if</font> we haven't initialized that ctx yet) may cause it to fall outside the
<a name="line876">876: </a>    // current size of the container.
<a name="line877">877: </a>    <font color="#4169E1">if</font> (static_cast&lt;std::size_t&gt;(devid) &gt;= ctxlist.size()) <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(ctxlist.resize(devid + 1));
<a name="line878">878: </a>    <font color="#4169E1">if</font> (<a href="../../../../../manualpages/Sys/PetscUnlikely.html">PetscUnlikely</a>(!ctxlist[devid])) {
<a name="line879">879: </a>      // we have not seen this device before
<a name="line880">880: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>(dctx));
<a name="line881">881: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Profiling/PetscInfo.html">PetscInfo</a>(*dctx, <font color="#666666">"Initializing null <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> (of type %s) for device %"</font> PetscInt_FMT <font color="#666666">"\n"</font>, PetscDeviceTypes[dtype], devid));
<a name="line882">882: </a>      {
<a name="line883">883: </a>        const auto pobj   = PetscObjectCast(*dctx);
<a name="line884">884: </a>        const auto name   = <font color="#666666">"null context "</font> + std::to_string(devid);
<a name="line885">885: </a>        const auto prefix = <font color="#666666">"null_context_"</font> + std::to_string(devid) + '_';

<a name="line887">887: </a>        <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscObjectSetName.html">PetscObjectSetName</a>(pobj, name.c_str()));
<a name="line888">888: </a>        <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscObjectSetOptionsPrefix.html">PetscObjectSetOptionsPrefix</a>(pobj, prefix.c_str()));
<a name="line889">889: </a>      }
<a name="line890">890: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a>(*dctx, <a href="../../../../../manualpages/Sys/PetscStreamType.html">PETSC_STREAM_GLOBAL_BLOCKING</a>));
<a name="line891">891: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextSetDevice_Private(*dctx, device, user_set_device));
<a name="line892">892: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextSetUp.html">PetscDeviceContextSetUp</a>(*dctx));
<a name="line893">893: </a>      // would use ctxlist.cbegin() but GCC 4.8 can't handle const iterator insert!
<a name="line894">894: </a>      <a href="../../../../../manualpages/Sys/PetscCallCXX.html">PetscCallCXX</a>(ctxlist.insert(std::next(ctxlist.begin(), devid), *dctx));
<a name="line895">895: </a>    } <font color="#4169E1">else</font> *dctx = ctxlist[devid];
<a name="line896">896: </a>  }
<a name="line897">897: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line898">898: </a>}

<a name="line900">900: </a><font color="#B22222">/*</font>
<a name="line901">901: </a><font color="#B22222">  Gets the "NULL" context for the current <a href="../../../../../manualpages/Sys/PetscDeviceType.html">PetscDeviceType</a> and <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>. NULL contexts are</font>
<a name="line902">902: </a><font color="#B22222">  guaranteed to always be globally blocking.</font>
<a name="line903">903: </a><font color="#B22222">*/</font>
<a name="line904">904: </a><strong><font color="#4169E1"><a name="PetscDeviceContextGetNullContext_Internal"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> PetscDeviceContextGetNullContext_Internal(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> *dctx)</font></strong>
<a name="line905">905: </a>{
<a name="line906">906: </a>  <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> gctx;
<a name="line907">907: </a>  <a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>        gdev = nullptr;

<a name="line909">909: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line911">911: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextGetCurrentContext.html">PetscDeviceContextGetCurrentContext</a>(&amp;gctx));
<a name="line912">912: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextGetDevice.html">PetscDeviceContextGetDevice</a>(gctx, &amp;gdev));
<a name="line913">913: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetNullContextForDevice_Private(gctx-&gt;usersetdevice, gdev, dctx));
<a name="line914">914: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line915">915: </a>}

<a name="line917">917: </a><font color="#B22222">/*@C</font>
<a name="line918">918: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextSetFromOptions.html">PetscDeviceContextSetFromOptions</a> - Configure a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` from the options database</font>

<a name="line920">920: </a><font color="#B22222">  Collective on `comm` or `dctx`</font>

<a name="line922">922: </a><font color="#B22222">  Input Parameters:</font>
<a name="line923">923: </a><font color="#B22222">+ comm - MPI communicator on which to query the options database (optional)</font>
<a name="line924">924: </a><font color="#B22222">- dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` to configure</font>

<a name="line926">926: </a><font color="#B22222">  Output Parameter:</font>
<a name="line927">927: </a><font color="#B22222">. dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line929">929: </a><font color="#B22222">  Options Database Keys:</font>
<a name="line930">930: </a><font color="#B22222">+ -device_context_stream_type - type of stream to create inside the `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` -</font>
<a name="line931">931: </a><font color="#B22222">   `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a>()`</font>
<a name="line932">932: </a><font color="#B22222">- -device_context_device_type - the type of `<a href="../../../../../manualpages/Sys/PetscDevice.html">PetscDevice</a>` to attach by default - `<a href="../../../../../manualpages/Sys/PetscDeviceType.html">PetscDeviceType</a>`</font>

<a name="line934">934: </a><font color="#B22222">  Level: beginner</font>

<a name="line936">936: </a><font color="#B22222">  Note:</font>
<a name="line937">937: </a><font color="#B22222">  The user may pass `MPI_COMM_NULL` for `comm` in which case the communicator of `dctx` is</font>
<a name="line938">938: </a><font color="#B22222">  used (which is always `<a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>`).</font>

<a name="line940">940: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextSetDevice.html">PetscDeviceContextSetDevice</a>()`,</font>
<a name="line941">941: </a><font color="#B22222">`<a href="../../../../../manualpages/Sys/PetscDeviceContextView.html">PetscDeviceContextView</a>()`</font>
<a name="line942">942: </a><font color="#B22222">@*/</font>
<a name="line943">943: </a><strong><font color="#4169E1"><a name="PetscDeviceContextSetFromOptions"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextSetFromOptions.html">PetscDeviceContextSetFromOptions</a>(<a href="../../../../../manualpages/Sys/MPI_Comm.html">MPI_Comm</a> comm, <a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx)</font></strong>
<a name="line944">944: </a>{
<a name="line945">945: </a>  const auto pobj     = PetscObjectCast(dctx);
<a name="line946">946: </a>  auto       dtype    = std::make_pair(<a href="../../../../../manualpages/Sys/PETSC_DEVICE_DEFAULT.html">PETSC_DEVICE_DEFAULT</a>(), <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_FALSE</a>);
<a name="line947">947: </a>  auto       stype    = std::make_pair(PETSC_DEVICE_CONTEXT_DEFAULT_STREAM_TYPE, <a href="../../../../../manualpages/Sys/PetscBool.html">PETSC_FALSE</a>);
<a name="line948">948: </a>  <a href="../../../../../manualpages/Sys/MPI_Comm.html">MPI_Comm</a>   old_comm = <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>;

<a name="line950">950: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line951">951: </a>  // <font color="#4169E1">do</font> not user getoptionalnullcontext here, the user is not allowed to set it from options!
<a name="line953">953: </a>  <font color="#B22222">/* set the device type first */</font>
<a name="line954">954: </a>  <font color="#4169E1">if</font> (const auto device = dctx-&gt;device) <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceGetType.html">PetscDeviceGetType</a>(device, &amp;dtype.first));
<a name="line955">955: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextGetStreamType.html">PetscDeviceContextGetStreamType</a>(dctx, &amp;stype.first));

<a name="line957">957: </a>  <font color="#4169E1">if</font> (comm == MPI_COMM_NULL) {
<a name="line958">958: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscObjectGetComm.html">PetscObjectGetComm</a>(pobj, &amp;comm));
<a name="line959">959: </a>  } <font color="#4169E1">else</font> {
<a name="line960">960: </a>    // briefly set the communicator <font color="#4169E1">for</font> dctx (it is always <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>) so
<a name="line961">961: </a>    // <a href="../../../../../manualpages/Sys/PetscObjectOptionsBegin.html">PetscObjectOptionsBegin</a>() behaves as <font color="#4169E1">if</font> dctx had comm
<a name="line962">962: </a>    old_comm = Petsc::util::exchange(pobj-&gt;comm, comm);
<a name="line963">963: </a>  }

<a name="line965">965: </a>  <a href="../../../../../manualpages/Sys/PetscObjectOptionsBegin.html">PetscObjectOptionsBegin</a>(pobj);
<a name="line966">966: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextQueryOptions_Internal(PetscOptionsObject, dtype, stype));
<a name="line967">967: </a>  <a href="../../../../../manualpages/Sys/PetscOptionsEnd.html">PetscOptionsEnd</a>();
<a name="line968">968: </a>  // reset the comm (should be <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>)
<a name="line969">969: </a>  <font color="#4169E1">if</font> (comm != MPI_COMM_NULL) pobj-&gt;comm = old_comm;
<a name="line970">970: </a>  <font color="#4169E1">if</font> (dtype.second) <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextSetDefaultDeviceForType_Internal(dctx, dtype.first));
<a name="line971">971: </a>  <font color="#4169E1">if</font> (stype.second) <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextSetStreamType.html">PetscDeviceContextSetStreamType</a>(dctx, stype.first));
<a name="line972">972: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextSetUp.html">PetscDeviceContextSetUp</a>(dctx));
<a name="line973">973: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line974">974: </a>}

<a name="line976">976: </a><font color="#B22222">/*@C</font>
<a name="line977">977: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextView.html">PetscDeviceContextView</a> - View a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>

<a name="line979">979: </a><font color="#B22222">  Collective on `viewer`</font>

<a name="line981">981: </a><font color="#B22222">  Input Parameters:</font>
<a name="line982">982: </a><font color="#B22222">+ dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>`</font>
<a name="line983">983: </a><font color="#B22222">- viewer - The `<a href="../../../../../manualpages/Viewer/PetscViewer.html">PetscViewer</a>` to view `dctx` with (may be `NULL`)</font>

<a name="line985">985: </a><font color="#B22222">  Level: beginner</font>

<a name="line987">987: </a><font color="#B22222">  Note:</font>
<a name="line988">988: </a><font color="#B22222">  If `viewer` is `NULL`, `<a href="../../../../../manualpages/Viewer/PETSC_VIEWER_STDOUT_WORLD.html">PETSC_VIEWER_STDOUT_WORLD</a>` is used instead, in which case this</font>
<a name="line989">989: </a><font color="#B22222">  routine is collective on `<a href="../../../../../manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a>`.</font>

<a name="line991">991: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextViewFromOptions.html">PetscDeviceContextViewFromOptions</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceView.html">PetscDeviceView</a>()`, `<a href="../../../../../manualpages/Viewer/PETSC_VIEWER_STDOUT_WORLD.html">PETSC_VIEWER_STDOUT_WORLD</a>`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>()`</font>
<a name="line992">992: </a><font color="#B22222">@*/</font>
<a name="line993">993: </a><strong><font color="#4169E1"><a name="PetscDeviceContextView"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextView.html">PetscDeviceContextView</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Viewer/PetscViewer.html">PetscViewer</a> viewer)</font></strong>
<a name="line994">994: </a>{
<a name="line995">995: </a>  <a href="../../../../../manualpages/Sys/PetscBool.html">PetscBool</a> iascii;

<a name="line997">997: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line998">998: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line999">999: </a>  <font color="#4169E1">if</font> (!viewer) <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIGetStdout.html">PetscViewerASCIIGetStdout</a>(<a href="../../../../../manualpages/Sys/PETSC_COMM_WORLD.html">PETSC_COMM_WORLD</a>, &amp;viewer));
<a name="line1001">1001: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscObjectTypeCompare.html">PetscObjectTypeCompare</a>(PetscObjectCast(viewer), <a href="../../../../../manualpages/Viewer/PETSCVIEWERASCII.html">PETSCVIEWERASCII</a>, &amp;iascii));
<a name="line1002">1002: </a>  <font color="#4169E1">if</font> (iascii) {
<a name="line1003">1003: </a>    auto        stype = <a href="../../../../../manualpages/Sys/PetscStreamType.html">PETSC_STREAM_DEFAULT_BLOCKING</a>;
<a name="line1004">1004: </a>    <a href="../../../../../manualpages/Viewer/PetscViewer.html">PetscViewer</a> sub;

<a name="line1006">1006: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerGetSubViewer.html">PetscViewerGetSubViewer</a>(viewer, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, &amp;sub));
<a name="line1007">1007: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscObjectPrintClassNamePrefixType.html">PetscObjectPrintClassNamePrefixType</a>(PetscObjectCast(dctx), sub));
<a name="line1008">1008: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIPushTab.html">PetscViewerASCIIPushTab</a>(sub));
<a name="line1009">1009: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContextGetStreamType.html">PetscDeviceContextGetStreamType</a>(dctx, &amp;stype));
<a name="line1010">1010: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(sub, <font color="#666666">"stream type: %s\n"</font>, PetscStreamTypes[stype]));
<a name="line1011">1011: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(sub, <font color="#666666">"children: %"</font> PetscInt_FMT <font color="#666666">"\n"</font>, dctx-&gt;numChildren));
<a name="line1012">1012: </a>    <font color="#4169E1">if</font> (const auto nchild = dctx-&gt;numChildren) {
<a name="line1013">1013: </a>      <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIPushTab.html">PetscViewerASCIIPushTab</a>(sub));
<a name="line1014">1014: </a>      <font color="#4169E1">for</font> (<a href="../../../../../manualpages/Sys/PetscInt.html">PetscInt</a> i = 0; i &lt; nchild; ++i) {
<a name="line1015">1015: </a>        <font color="#4169E1">if</font> (i == nchild - 1) {
<a name="line1016">1016: </a>          <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(sub, <font color="#666666">"%"</font> PetscInt64_FMT, dctx-&gt;childIDs[i]));
<a name="line1017">1017: </a>        } <font color="#4169E1">else</font> {
<a name="line1018">1018: </a>          <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIPrintf.html">PetscViewerASCIIPrintf</a>(sub, <font color="#666666">"%"</font> PetscInt64_FMT <font color="#666666">", "</font>, dctx-&gt;childIDs[i]));
<a name="line1019">1019: </a>        }
<a name="line1020">1020: </a>      }
<a name="line1021">1021: </a>    }
<a name="line1022">1022: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIPopTab.html">PetscViewerASCIIPopTab</a>(sub));
<a name="line1023">1023: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerRestoreSubViewer.html">PetscViewerRestoreSubViewer</a>(viewer, <a href="../../../../../manualpages/Sys/PETSC_COMM_SELF.html">PETSC_COMM_SELF</a>, &amp;sub));
<a name="line1024">1024: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerFlush.html">PetscViewerFlush</a>(viewer));
<a name="line1025">1025: </a>    <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIPushTab.html">PetscViewerASCIIPushTab</a>(viewer));
<a name="line1026">1026: </a>  }
<a name="line1027">1027: </a>  <font color="#4169E1">if</font> (const auto device = dctx-&gt;device) <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscDeviceView.html">PetscDeviceView</a>(device, viewer));
<a name="line1028">1028: </a>  <font color="#4169E1">if</font> (iascii) <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Viewer/PetscViewerASCIIPopTab.html">PetscViewerASCIIPopTab</a>(viewer));
<a name="line1029">1029: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line1030">1030: </a>}

<a name="line1032">1032: </a><font color="#B22222">/*@C</font>
<a name="line1033">1033: </a><font color="#B22222">  <a href="../../../../../manualpages/Sys/PetscDeviceContextViewFromOptions.html">PetscDeviceContextViewFromOptions</a> - View a `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` from options</font>

<a name="line1035">1035: </a><font color="#B22222">  Input Parameters:</font>
<a name="line1036">1036: </a><font color="#B22222">+ dctx - The `<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a>` to view</font>
<a name="line1037">1037: </a><font color="#B22222">. obj  - Optional `<a href="../../../../../manualpages/Sys/PetscObject.html">PetscObject</a>` to associate (may be `NULL`)</font>
<a name="line1038">1038: </a><font color="#B22222">- name - The command line option</font>

<a name="line1040">1040: </a><font color="#B22222">  Level: beginner</font>

<a name="line1042">1042: </a><font color="#B22222">.seealso: `<a href="../../../../../manualpages/Sys/PetscDeviceContextView.html">PetscDeviceContextView</a>()`, `<a href="../../../../../manualpages/Sys/PetscObjectViewFromOptions.html">PetscObjectViewFromOptions</a>()`, `<a href="../../../../../manualpages/Sys/PetscDeviceContextCreate.html">PetscDeviceContextCreate</a>()`</font>
<a name="line1043">1043: </a><font color="#B22222">@*/</font>
<a name="line1044">1044: </a><strong><font color="#4169E1"><a name="PetscDeviceContextViewFromOptions"></a><a href="../../../../../manualpages/Sys/PetscErrorCode.html">PetscErrorCode</a> <a href="../../../../../manualpages/Sys/PetscDeviceContextViewFromOptions.html">PetscDeviceContextViewFromOptions</a>(<a href="../../../../../manualpages/Sys/PetscDeviceContext.html">PetscDeviceContext</a> dctx, <a href="../../../../../manualpages/Sys/PetscObject.html">PetscObject</a> obj, const char name[])</font></strong>
<a name="line1045">1045: </a>{
<a name="line1046">1046: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionBegin.html">PetscFunctionBegin</a>;
<a name="line1047">1047: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(PetscDeviceContextGetOptionalNullContext_Internal(&amp;dctx));
<a name="line1050">1050: </a>  <a href="../../../../../manualpages/Sys/PetscCall.html">PetscCall</a>(<a href="../../../../../manualpages/Sys/PetscObjectViewFromOptions.html">PetscObjectViewFromOptions</a>(PetscObjectCast(dctx), obj, name));
<a name="line1051">1051: </a>  <a href="../../../../../manualpages/Sys/PetscFunctionReturn.html">PetscFunctionReturn</a>(<a href="../../../../../manualpages/Sys/PetscErrorCode.html">PETSC_SUCCESS</a>);
<a name="line1052">1052: </a>}
</pre>
</body>

</html>
